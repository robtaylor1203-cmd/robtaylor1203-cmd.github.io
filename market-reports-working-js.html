<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market Reports - TeaTrade</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body class="market-reports-page">
    <header class="site-header">
        <div class="header-top-bar">
            <a href="corporate.html" class="header-logo"><h1>Tea<span>Trade</span></h1></a>
            <div class="header-search-wrapper">
                <input type="text" class="header-search-bar" placeholder="Global site search">
            </div>
            <div class="user-actions">
                <a href="#" title="Create Account"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg></a>
                <a href="#" title="Sign In"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 3h6v6"></path><path d="M10 14 21 3"></path><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path></svg></a>
            </div>
        </div>
        <nav class="secondary-nav">
            <ul>
                <li><a href="data.html">Data</a></li>
                <li><a href="market-reports.html" class="active">Market Reports</a></li>
                <li><a href="#">Auctions</a></li>
                <li><a href="visuals.html">Visuals</a></li>
            </ul>
        </nav>
    </header>

    <main class="page-container">
        <section class="hero-section">
            <div class="hero-content">
                <h1>Global Market Reports Library</h1>
                <p>Comprehensive market intelligence and auction analysis from global tea trading centers</p>
            </div>
        </section>

        <section class="filters-section">
            <div class="filters-wrapper">
                <div class="filter-row">
                    <div class="filter-group">
                        <label for="filter-year">Year</label>
                        <select id="filter-year" class="filter-select">
                            <option value="all">All Years</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="filter-week">Week/Sale No.</label>
                        <select id="filter-week" class="filter-select">
                            <option value="all">All</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="filter-centre">Auction Centre</label>
                        <select id="filter-centre" class="filter-select">
                            <option value="all">All Centres</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="search-reports">Search</label>
                        <input type="text" id="search-reports" class="filter-input" placeholder="Search titles or descriptions...">
                    </div>
                </div>
            </div>
        </section>

        <section class="reports-grid">
            <div id="reports-container">
                <p>Loading market reports...</p>
            </div>
        </section>
    </main>

    <script>
        let allReports = [];

        document.addEventListener('DOMContentLoaded', () => {
            console.log('Market reports page loaded');
            fetchAndRenderReports();

            // Add event listeners
            document.getElementById('filter-year').addEventListener('change', filterReports);
            document.getElementById('filter-week').addEventListener('change', filterReports);
            document.getElementById('filter-centre').addEventListener('change', filterReports);
            document.getElementById('search-reports').addEventListener('input', filterReports);
        });

        async function fetchAndRenderReports() {
            try {
                console.log('Fetching market-reports-library.json...');
                const response = await fetch('market-reports-library.json?v=' + Date.now());
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const text = await response.text();
                console.log('Raw library response:', text.substring(0, 200) + '...');
                
                allReports = JSON.parse(text);
                console.log('Parsed reports:', allReports);

                if (!Array.isArray(allReports) || allReports.length === 0) {
                    throw new Error('No reports found in library');
                }

                // Sort reports: newest first
                allReports.sort((a, b) => {
                    if (b.year !== a.year) return b.year - a.year;
                    return (parseInt(b.week_number) || 0) - (parseInt(a.week_number) || 0);
                });

                populateFilters(allReports);
                renderReports(allReports);

            } catch (error) {
                console.error('Error fetching reports:', error);
                document.getElementById('reports-container').innerHTML = `
                    <div class="error-message">
                        <h3>Error Loading Reports</h3>
                        <p><strong>Error:</strong> ${error.message}</p>
                        <p><strong>Debug Steps:</strong></p>
                        <ol>
                            <li>Check browser console (F12) for detailed errors</li>
                            <li>Verify market-reports-library.json exists: <code>ls -la market-reports-library.json</code></li>
                            <li>Regenerate data: <code>python3 automation/teatrade_intelligence_aggregator.py</code></li>
                        </ol>
                    </div>
                `;
            }
        }

        function populateFilters(reports) {
            const years = new Set();
            const weeks = new Set();
            const centres = new Set();

            reports.forEach(report => {
                if (report.year) years.add(report.year);
                if (report.week_number) weeks.add(report.week_number);
                if (report.auction_centre) centres.add(report.auction_centre);
            });

            // Populate year dropdown
            const yearSelect = document.getElementById('filter-year');
            Array.from(years).sort((a, b) => b - a).forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            });

            // Populate week dropdown
            const weekSelect = document.getElementById('filter-week');
            Array.from(weeks).sort((a, b) => b - a).forEach(week => {
                const option = document.createElement('option');
                option.value = week;
                option.textContent = `Week ${week}`;
                weekSelect.appendChild(option);
            });

            // Populate centre dropdown
            const centreSelect = document.getElementById('filter-centre');
            Array.from(centres).sort().forEach(centre => {
                const option = document.createElement('option');
                option.value = centre;
                option.textContent = centre;
                centreSelect.appendChild(option);
            });
        }

        function filterReports() {
            const selectedYear = document.getElementById('filter-year').value;
            const selectedWeek = document.getElementById('filter-week').value;
            const selectedCentre = document.getElementById('filter-centre').value;
            const searchTerm = document.getElementById('search-reports').value.toLowerCase();

            const filteredReports = allReports.filter(report => {
                if (selectedYear !== 'all' && report.year != selectedYear) return false;
                if (selectedWeek !== 'all' && report.week_number != selectedWeek) return false;
                if (selectedCentre !== 'all' && report.auction_centre !== selectedCentre) return false;
                
                if (searchTerm) {
                    const titleMatch = report.title && report.title.toLowerCase().includes(searchTerm);
                    const descMatch = report.description && report.description.toLowerCase().includes(searchTerm);
                    if (!titleMatch && !descMatch) return false;
                }
                
                return true;
            });

            renderReports(filteredReports);
        }

        function renderReports(reports) {
            const container = document.getElementById('reports-container');

            if (reports.length === 0) {
                container.innerHTML = '<div class="no-results"><p>No reports found matching criteria.</p></div>';
                return;
            }

            container.innerHTML = '';

            reports.forEach(report => {
                const reportCard = document.createElement('div');
                reportCard.className = 'report-card';

                const periodText = report.week_number 
                    ? `Week ${report.week_number}, ${report.year}` 
                    : `${report.year}`;

                reportCard.innerHTML = `
                    <div class="report-header">
                        <h3 class="report-title">
                            <a href="${report.report_link}">${report.title || 'Untitled Report'}</a>
                        </h3>
                        <div class="report-meta">
                            <span class="report-period">${periodText}</span>
                            <span class="report-centre">Centre: ${report.auction_centre || 'N/A'}</span>
                            <span class="report-year">Year: ${report.year || 'N/A'}</span>
                            <span class="report-week">Week/Sale No: ${report.week_number || 'N/A'}</span>
                        </div>
                    </div>
                    <div class="report-content">
                        <p class="report-description">${report.description || 'No description available.'}</p>
                    </div>
                `;

                container.appendChild(reportCard);
            });

            console.log(`Rendered ${reports.length} reports`);
        }
    </script>
</body>
</html>
