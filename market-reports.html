<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market Reports Library - TeaTrade</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body class="market-reports-page">
    <header class="site-header">
        <div class="header-top-bar">
            <a href="corporate.html" class="header-logo"><h1>Tea<span>Trade</span></h1></a>
            <div class="header-search-wrapper"><input type="text" class="header-search-bar" placeholder="Global site search..."></div>
            <div class="user-actions">
                <a href="#" title="Create Account"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><line x1="20" y1="8" x2="20" y2="14"></line><line x1="17" y1="11" x2="23" y2="11"></line></svg></a>
                <a href="#" title="Sign In"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path><polyline points="10 17 15 12 10 7"></polyline><line x1="15" y1="12" x2="3" y2="12"></line></svg></a>
            </div>
            <button class="mobile-menu-toggle" aria-label="Toggle navigation" aria-expanded="false">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
            </button>
        </div>
        <nav class="secondary-nav">
            <ul>
                <li><a href="data.html">Data</a></li>
                <li><a href="market-reports.html" class="active">Market Reports</a></li>
                <li><a href="#">Auctions</a></li>
                <li><a href="visuals.html">Visuals</a></li>
            </ul>
        </nav>
    </header>

    <main class="page-container">
        <div class="dashboard-header">
            <h2 class="page-title">Global Market Reports Library</h2>
        </div>
        
        <div class="filter-controls-wrapper">
            <div class="filter-group">
                <label for="filter-year" class="filter-label">Year</label>
                <select id="filter-year" class="filter-dropdown">
                    <option value="ALL">All Years</option>
                </select>
            </div>
             <div class="filter-group">
                <label for="filter-week" class="filter-label">Week/Sale No.</label>
                <select id="filter-week" class="filter-dropdown">
                    <option value="ALL">All</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="filter-centre" class="filter-label">Auction Centre</label>
                <select id="filter-centre" class="filter-dropdown">
                    <option value="ALL">All Centres</option>
                </select>
            </div>
             <div class="filter-group">
                <label for="filter-search" class="filter-label">Search</label>
                <input type="text" id="filter-search" class="page-search-bar" placeholder="Search titles or descriptions..." style="height: 44px; border-radius: 8px;">
            </div>
        </div>

        <div id="reports-list">
            </div>
        <div id="loading-indicator">Loading reports...</div>
        <div id="error-message" style="color: red; display: none;"></div>
    </main>

    <script src="script.js"></script>
    <script>
        let allReports = [];

        document.addEventListener('DOMContentLoaded', () => {
            // Initialize mobile menu (assuming this function exists in script.js)
            if (typeof initializeMobileMenu === 'function') {
                initializeMobileMenu();
            }
            loadReports();
            
            // Add event listeners for filters
            document.getElementById('filter-year').addEventListener('change', applyFilters);
            document.getElementById('filter-week').addEventListener('change', applyFilters);
            document.getElementById('filter-centre').addEventListener('change', applyFilters);
            document.getElementById('filter-search').addEventListener('input', applyFilters);
        });

        async function loadReports() {
            try {
                const response = await fetch('market-reports-library.json');
                if (!response.ok) throw new Error('Failed to fetch report library.');
                
                // *** THE FIX: Process the Object structure ***
                const libraryData = await response.json();
                allReports = flattenAndProcessData(libraryData);

                // Sort reports: Newest first (By Year, then by Week/Sale Number)
                allReports.sort((a, b) => {
                    if (b.year !== a.year) {
                        return b.year - a.year;
                    }
                    return b.week_number - a.week_number;
                });

                populateFilters(allReports);
                applyFilters(); // Initial render
                document.getElementById('loading-indicator').style.display = 'none';

            } catch (error) {
                console.error('Error loading reports:', error);
                document.getElementById('loading-indicator').style.display = 'none';
                document.getElementById('error-message').textContent = 'Error loading reports. Please check the connection and file path.';
                document.getElementById('error-message').style.display = 'block';
            }
        }

        // Converts the new Object structure into a flat Array and extracts metadata
        function flattenAndProcessData(dataObject) {
            const flattenedReports = [];
            for (const location in dataObject) {
                for (const reportTitle in dataObject[location]) {
                    const report = dataObject[location][reportTitle];
                    
                    // Robustly extract Year and Week Number for sorting/filtering
                    // We check both the title and the description as formats vary.

                    // 1. Check Title (e.g., "Sale 36 (2025)")
                    const titleYearMatch = reportTitle.match(/\((\d{4})\)/);
                    // Matches "Sale 36" OR "Week 36"
                    const titleWeekMatch = reportTitle.match(/Sale (\d+)|Week (\d+)/i);

                    // 2. Check Description (e.g., "Week: 36 | ...")
                    const descYearMatch = report.description ? report.description.match(/(\d{4})/) : null;
                    const descWeekMatch = report.description ? report.description.match(/Week: (\d+)/i) : null;

                    // Assign the extracted values, prioritizing Title match, then Description match, defaulting to 0.
                    let year = 0;
                    if (titleYearMatch) {
                        year = parseInt(titleYearMatch[1]);
                    } else if (descYearMatch) {
                        // Use the first 4-digit number found in the description if title fails
                        year = parseInt(descYearMatch[0]);
                    }

                    let weekNumber = 0;
                    if (titleWeekMatch) {
                        // Handles both groups from the regex (Sale OR Week)
                        weekNumber = parseInt(titleWeekMatch[1] || titleWeekMatch[2]);
                    } else if (descWeekMatch) {
                        weekNumber = parseInt(descWeekMatch[1]);
                    }

                    // Create a unified object structure
                    const reportEntry = {
                        title: reportTitle,
                        location: location,
                        description: report.description || '',
                        year: year,
                        week_number: weekNumber
                    };
                    flattenedReports.push(reportEntry);
                }
            }
            return flattenedReports;
        }

        function populateFilters(reports) {
            const years = new Set();
            const weeks = new Set();
            const centres = new Set();

            reports.forEach(report => {
                if (report.year && report.year !== 0) years.add(report.year);
                if (report.week_number && report.week_number !== 0) weeks.add(report.week_number);
                if (report.location) centres.add(report.location);
            });

            const yearSelect = document.getElementById('filter-year');
            // Sort years descending
            Array.from(years).sort((a, b) => b - a).forEach(year => {
                yearSelect.innerHTML += `<option value="${year}">${year}</option>`;
            });

            const weekSelect = document.getElementById('filter-week');
            // Sort weeks ascending
            Array.from(weeks).sort((a, b) => a - b).forEach(week => {
                weekSelect.innerHTML += `<option value="${week}">${week}</option>`;
            });

            const centreSelect = document.getElementById('filter-centre');
            // Sort centres alphabetically
            Array.from(centres).sort().forEach(centre => {
                centreSelect.innerHTML += `<option value="${centre}">${centre}</option>`;
            });
        }

        function applyFilters() {
            const selectedYear = document.getElementById('filter-year').value;
            const selectedWeek = document.getElementById('filter-week').value;
            const selectedCentre = document.getElementById('filter-centre').value;
            const searchQuery = document.getElementById('filter-search').value.toLowerCase();

            const filteredReports = allReports.filter(report => {
                const yearMatch = (selectedYear === 'ALL' || report.year.toString() === selectedYear);
                const weekMatch = (selectedWeek === 'ALL' || report.week_number.toString() === selectedWeek);
                const centreMatch = (selectedCentre === 'ALL' || report.location === selectedCentre);
                const searchMatch = (report.title.toLowerCase().includes(searchQuery) || report.description.toLowerCase().includes(searchQuery));

                return yearMatch && weekMatch && centreMatch && searchMatch;
            });

            renderReportsList(filteredReports);
        }

        function renderReportsList(reports) {
            const listContainer = document.getElementById('reports-list');
            listContainer.innerHTML = '';

            if (reports.length === 0) {
                listContainer.innerHTML = '<p>No reports found matching the selected criteria.</p>';
                return;
            }

            reports.forEach(report => {
                // *** THE FIX: Generate the correct URL parameters ***
                // We must encode the title and location because they contain spaces and special characters
                const encodedTitle = encodeURIComponent(report.title);
                const encodedLocation = encodeURIComponent(report.location);
                const reportLink = `report-viewer.html?location=${encodedLocation}&reportTitle=${encodedTitle}`;

                const reportElement = document.createElement('div');
                reportElement.className = 'dataset-item';
                
                reportElement.innerHTML = `
                    <a href="${reportLink}">
                        <h3 class="dataset-title">${report.title}</h3>
                        <p class="dataset-description">${report.description}</p>
                        <div class="dataset-meta">
                            <span>Centre: ${report.location}</span>
                            <span>Year: ${report.year || 'N/A'}</span>
                            <span>Week/Sale No: ${report.week_number || 'N/A'}</span>
                        </div>
                    </a>
                `;
                listContainer.appendChild(reportElement);
            });
        }
    </script>
</body>
</html>
