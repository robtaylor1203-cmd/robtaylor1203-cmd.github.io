<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market Reports Library - TeaTrade</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body class="market-reports-page">
    <header class="site-header">
        <div class="header-top-bar">
            <a href="corporate.html" class="header-logo"><h1>Tea<span>Trade</span></h1></a>
            <div class="header-search-wrapper"><input type="text" class="header-search-bar" placeholder="Global site search..."></div>
            <div class="user-actions">
                <a href="#" title="Create Account"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><line x1="20" y1="8" x2="20" y2="14"></line><line x1="17" y1="11" x2="23" y2="11"></line></svg></a>
                <a href="#" title="Sign In"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path><polyline points="10 17 15 12 10 7"></polyline><line x1="15" y1="12" x2="3" y2="12"></line></svg></a>
            </div>
            <button class="mobile-menu-toggle" aria-label="Toggle navigation" aria-expanded="false">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
            </button>
        </div>
        <nav class="secondary-nav">
            <ul>
                <li><a href="data.html">Data</a></li>
                <li><a href="market-reports.html" class="active">Market Reports</a></li>
                <li><a href="#">Auctions</a></li>
                <li><a href="visuals.html">Visuals</a></li>
            </ul>
        </nav>
    </header>

    <main class="page-container">
        <div class="dashboard-header">
            <h2 class="page-title">Market Reports Library</h2>
        </div>

        <div class="filter-controls-wrapper">
            <div class="filter-group">
                <label for="filter-year" class="filter-label">Year</label>
                <select id="filter-year" class="filter-dropdown">
                    <option value="all">All Years</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="filter-centre" class="filter-label">Auction Centre</label>
                <select id="filter-centre" class="filter-dropdown">
                    <option value="all">All Centres</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="filter-source" class="filter-label">Source/Broker</label>
                <select id="filter-source" class="filter-dropdown">
                    <option value="all">All Sources</option>
                </select>
            </div>
             <div class="filter-group">
                <label for="search-reports" class="filter-label">Search</label>
                <input type="text" id="search-reports" class="page-search-bar" placeholder="Search titles and descriptions..." style="margin-bottom: 0;">
            </div>
        </div>
        
        <div id="reports-list">
            <p>Loading reports...</p>
        </div>
    </main>

    <script src="script.js"></script>
    <script>
        let allReports = [];

        document.addEventListener('DOMContentLoaded', () => {
            // CRITICAL FIX: Initialize mobile menu safely
            if (typeof initializeMobileMenu === 'function') {
                initializeMobileMenu();
            } else {
                console.log("Mobile menu initialization skipped - script.js not loaded");
            }

            fetchAndRenderReports();
            
            // Add event listeners for filters and search
            document.getElementById('filter-year').addEventListener('change', filterReports);
            document.getElementById('filter-centre').addEventListener('change', filterReports);
            document.getElementById('filter-source').addEventListener('change', filterReports);
            document.getElementById('search-reports').addEventListener('input', filterReports);
        });

        async function fetchAndRenderReports() {
            try {
                console.log('Fetching market-reports-library.json...');
                const response = await fetch('market-reports-library.json?v=' + Date.now());
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                allReports = await response.json();
                console.log('Loaded reports:', allReports);
                
                if (!Array.isArray(allReports) || allReports.length === 0) {
                    throw new Error('No reports found in library');
                }
                
                // Sort reports: Newest first (by Year, then Week Number)
                allReports.sort((a, b) => {
                    if (b.year !== a.year) {
                        return b.year - a.year;
                    }
                    const weekA = parseInt(a.week_number) || 0;
                    const weekB = parseInt(b.week_number) || 0;
                    return weekB - weekA;
                });

                populateFilters(allReports);
                renderReports(allReports);
                
            } catch (error) {
                console.error('Error fetching reports library:', error);
                document.getElementById('reports-list').innerHTML = `<p>Error loading reports. Please check the connection and file path. ${error.message}</p>`;
            }
        }

        function populateFilters(reports) {
            const years = new Set();
            const centres = new Set();
            const sources = new Set();

            reports.forEach(report => {
                if (report.year) years.add(report.year);
                if (report.auction_centre) centres.add(report.auction_centre);
                if (report.source) sources.add(report.source);
            });

            const yearSelect = document.getElementById('filter-year');
            Array.from(years).sort((a, b) => b - a).forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            });

            const centreSelect = document.getElementById('filter-centre');
            Array.from(centres).sort().forEach(centre => {
                const option = document.createElement('option');
                option.value = centre;
                option.textContent = centre;
                centreSelect.appendChild(option);
            });

            const sourceSelect = document.getElementById('filter-source');
            Array.from(sources).sort().forEach(source => {
                const option = document.createElement('option');
                option.value = source;
                option.textContent = source;
                sourceSelect.appendChild(option);
            });
        }

        function filterReports() {
            const selectedYear = document.getElementById('filter-year').value;
            const selectedCentre = document.getElementById('filter-centre').value;
            const selectedSource = document.getElementById('filter-source').value;
            const searchTerm = document.getElementById('search-reports').value.toLowerCase();

            const filteredReports = allReports.filter(report => {
                // Check filters
                if (selectedYear !== 'all' && report.year != selectedYear) return false;
                if (selectedCentre !== 'all' && report.auction_centre !== selectedCentre) return false;
                if (selectedSource !== 'all' && report.source !== selectedSource) return false;

                // Check search term
                if (searchTerm) {
                    const titleMatch = (report.title || '').toLowerCase().includes(searchTerm);
                    const descriptionMatch = (report.description || '').toLowerCase().includes(searchTerm);
                    if (!titleMatch && !descriptionMatch) return false;
                }

                return true;
            });

            renderReports(filteredReports);
        }

        function renderReports(reports) {
            const listContainer = document.getElementById('reports-list');
            listContainer.innerHTML = '';

            if (reports.length === 0) {
                listContainer.innerHTML = '<p>No reports found matching the selected criteria.</p>';
                return;
            }

            reports.forEach(report => {
                const item = document.createElement('div');
                item.className = 'dataset-item';
                
                // Determine the period text (Week vs Monthly/Other)
                let periodText = '';
                if (report.week_number) {
                    periodText = `Week ${report.week_number}, ${report.year}`;
                } else if (report.year) {
                    periodText = `${report.year}`;
                }

                item.innerHTML = `
                    <a href="${report.report_link}">
                        <h3 class="dataset-title">${report.title} <span class="dataset-period">(${periodText})</span></h3>
                        <p class="dataset-description">${report.description}</p>
                        <div class="dataset-meta">
                            <span>Centre: ${report.auction_centre}</span>
                            <span>Source: ${report.source}</span>
                        </div>
                    </a>
                `;
                listContainer.appendChild(item);
            });
            
            console.log(`Successfully rendered ${reports.length} reports`);
        }
    </script>
</body>
</html>
