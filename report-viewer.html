<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market Report Viewer - TeaTrade</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="market-reports-page">
    <header class="site-header">
        <div class="header-top-bar">
            <a href="corporate.html" class="header-logo"><h1>Tea<span>Trade</span></h1></a>
            <div class="header-search-wrapper"><input type="text" class="header-search-bar" placeholder="Global site search..."></div>
            <div class="user-actions">
                <a href="#" title="Create Account"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><line x1="20" y1="8" x2="20" y2="14"></line><line x1="17" y1="11" x2="23" y2="11"></line></svg></a>
                <a href="#" title="Sign In"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path><polyline points="10 17 15 12 10 7"></polyline><line x1="15" y1="12" x2="3" y2="12"></line></svg></a>
            </div>
            <button class="mobile-menu-toggle" aria-label="Toggle navigation" aria-expanded="false">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
            </button>
        </div>
        <nav class="secondary-nav">
            <ul>
                <li><a href="data.html">Data</a></li>
                <li><a href="market-reports.html" class="active">Market Reports</a></li>
                <li><a href="#">Auctions</a></li>
                <li><a href="visuals.html">Visuals</a></li>
            </ul>
        </nav>
    </header>

    <main class="page-container">
        <div class="dashboard-header">
            <h2 class="page-title" id="report-title">Loading Consolidated Report...</h2>
        </div>
        <p id="report-meta" style="margin-bottom: 24px; color: #5f6368;"></p>

        <div id="report-content" style="display: none;">
            
            <section class="report-section" id="overview-section" style="display: none;">
                <h3>Auction Overview</h3>
                <div class="stat-cards-container" id="summary-stats"></div>
                
                <div class="overview-grid">
                    <div class="commentary-block">
                        <h4>Market Synopsis</h4>
                        <p id="market-comment"></p>
                    </div>
                    <div class="highest-prices-block" id="highest-prices-wrapper" style="display: none;">
                        <h4>Highest Achieved Prices</h4>
                        <table class="data-table compact-table" id="highest-prices-table">
                            <thead>
                                <tr>
                                    <th>Price</th>
                                    <th>Grade</th>
                                    <th>Mark (Factory)</th>
                                    <th>Country</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section class="report-section" id="volume-analysis-section" style="display: none;">
                <h3>Volume Analysis</h3>
                <div class="analysis-grid">
                    <div class="analysis-block" id="country-volume-chart-wrapper" style="display: none;">
                        <h4>Offerings vs Sold by Country (kg)</h4>
                        <div style="position: relative; height: 350px;"><canvas id="countryVolumeChart"></canvas></div>
                    </div>
                    <div class="analysis-block" id="grade-stats-table-wrapper" style="display: none;">
                         <h4>Detailed Grade/Category Statistics</h4>
                         <div class="data-table-container">
                            <table class="data-table stats-table" id="grade-stats-table">
                                <thead>
                                    </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <section class="report-section" id="buyer-activity-section" style="display: none;">
                <h3>Buyer Activity & Market Share</h3>
                 <div class="analysis-grid">
                    <div class="analysis-block">
                         <h4>Buyer Market Share (%)</h4>
                        <div style="position: relative; height: 400px;"><canvas id="buyerChart"></canvas></div>
                    </div>
                    <div class="analysis-block">
                        <h4>Top Buyers & Regional Activity</h4>
                         <div class="data-table-container">
                            <table class="data-table stats-table" id="buyer-activity-table">
                                <thead>
                                    <tr>
                                        <th>Buyer/Region</th>
                                        <th>Volume (kg)</th>
                                        <th>Market Share (%)</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <section class="report-section" id="comparative-analysis-section" style="display: none;">
                <h3>Comparative Analysis</h3>
                <div class="comparison-container">
                    <div class="comparison-block" id="country-comparison-wrapper" style="display: none;">
                         <h4>Country Average Prices (Year-on-Year)</h4>
                        <div class="data-table-container">
                            <table class="data-table stats-table" id="country-comparison-table">
                                <thead>
                                    <tr>
                                        <th rowspan="2" class="header-main">Country</th>
                                        <th colspan="3" class="header-main">Current Sale Avg</th>
                                        <th colspan="3" class="header-main">Year-to-Date Avg</th>
                                    </tr>
                                    <tr>
                                        <th class="header-sub" id="header-current-year-sale"></th>
                                        <th class="header-sub" id="header-prev-year-sale"></th>
                                        <th class="header-sub">Change</th>
                                        <th class="header-sub" id="header-current-year-ytd"></th>
                                        <th class="header-sub" id="header-prev-year-ytd"></th>
                                        <th class="header-sub">Change</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                                <tfoot></tfoot>
                            </table>
                        </div>
                    </div>
                    <div class="comparison-block" id="auction-avg-chart-wrapper" style="display: none;">
                        <h4>Auction Average Visualization</h4>
                        <div style="position: relative; height: 300px;"><canvas id="auctionAvgChart"></canvas></div>
                    </div>
                     <div class="comparison-block" id="generic-comparison-wrapper" style="display: none;">
                         <div class="data-table-container" id="generic-comparison-container">
                            </div>
                    </div>
                </div>
            </section>

             <section class="report-section" id="factory-performance-section" style="display: none;">
                <h3>Factory (Mark) Performance Ranking</h3>
                <p>Top Factories ranked by Average Price achieved during the sale.</p>
                 <div class="data-table-container">
                    <table class="data-table stats-table" id="factory-performance-table">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Mark (Factory)</th>
                                <th>Country</th>
                                <th>Average Price</th>
                                <th>Top Grade</th>
                                <th>Top Price</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </section>

            <section class="report-section" id="price-quotations-section" style="display: none;">
                <h3 id="price-quotations-title">Price Quotations</h3>
                 <div class="data-table-container">
                    <table class="data-table" id="price-quotations-table">
                        <thead></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </section>

            <section class="report-section" id="forecast-section" style="display: none;">
                <h3>Market Forecast & Outlook</h3>
                <div class="forecast-container" id="forecast-container">
                </div>
            </section>

            <section class="report-section" id="forward-look-section" style="display: none;">
                <h3>Weather Impact & Upcoming Offerings</h3>
                <div class="analysis-grid">
                    <div class="analysis-block" id="weather-section" style="display: none;">
                        <h4>Regional Weather & Crop Conditions</h4>
                        <div class="data-table-container">
                            <table class="data-table stats-table" id="weather-table">
                                <thead>
                                    <tr>
                                        <th>Region</th>
                                        <th>Conditions</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="analysis-block" id="upcoming-section" style="display: none;">
                        <h4>Upcoming Auction Offerings</h4>
                        <div class="upcoming-container" id="upcoming-container">
                        </div>
                    </div>
                </div>
            </section>

             <section class="report-section" id="international-section" style="display: none;">
                <h3>International Summaries</h3>
                <div id="international-container"></div>
            </section>

        </div>
        <div id="loading-indicator">Loading data...</div>
    </main>
    <script src="script.js"></script>
    
    <script>
        // --- Configuration ---
        const CHART_COLORS = {
            primary: 'rgba(26, 115, 232, 0.8)', // Blue
            secondary: 'rgba(128, 178, 247, 0.8)', // Lighter Blue
            accent1: 'rgba(251, 188, 4, 0.8)', 
            accent2: 'rgba(52, 168, 83, 0.8)', 
            neutral: 'rgba(160, 160, 160, 0.8)'
        };

        const PIE_COLORS = [
            '#1a73e8', '#34a853', '#fbbc05', '#ea4335', '#9b59b6', 
            '#3498db', '#16a085', '#f39c12', '#d35400', '#7f8c8d'
        ];

        const CHART_OPTIONS_BAR = {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: { display: true, text: 'Value' }
                },
                x: {
                    ticks: { autoSkip: false, maxRotation: 45, minRotation: 45 }
                }
            },
            plugins: { legend: { display: false } }
        };

         const CHART_OPTIONS_PIE = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { 
                legend: { 
                    display: true,
                    position: 'right',
                } 
            }
        };

        // --- Utility Functions (Enhanced) ---
        const formatNumber = (num, decimals = 0) => {
            if (num === null || num === undefined || isNaN(num)) return 'N/A';
            return num.toLocaleString(undefined, { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
        };

        // Format currency dynamically based on the report's currency
        const formatCurrency = (num, currency = 'USD') => {
             if (num === null || num === undefined || isNaN(num)) return 'N/A';
             // Use 2 decimals for USD/USc, 0 decimals for LKR/INR etc.
             const decimals = (currency === 'USD' || currency === 'USc') ? 2 : 0;
             return formatNumber(num, decimals);
        }

        const formatPriceRange = (min, max, currency = 'USD') => {
             if ((min === null || min === undefined) && (max === null || max === undefined)) return 'N/A';
             // Handle cases where min or max might be missing
             if (max === null || max === undefined) return formatCurrency(min, currency);
             if (min === null || min === undefined) return formatCurrency(max, currency);
             return `${formatCurrency(min, currency)} - ${formatCurrency(max, currency)}`;
        }

        // Enhanced formatDiff for financial visualization (Bloomberg Style)
         const formatDiff = (value, decimals = 2, invertColor = false) => {
            if (value === null || value === undefined || isNaN(value)) return 'N/A';
            
            const formatted = formatNumber(value, decimals);
            let className;

            // Standard financial colors: Green for positive, Red for negative
            if (value > 0) {
                className = invertColor ? 'diff-negative' : 'diff-positive';
            } else if (value < 0) {
                className = invertColor ? 'diff-positive' : 'diff-negative';
            } else {
                className = ''; // No color for zero change
            }

            // Add +/- sign explicitly for non-zero values
            const sign = value > 0 ? '+' : ''; 
            return `<span class="${className}">${sign}${formatted}</span>`;
        }

        // Helper to calculate midpoint of a range for price movement calculation
        const getMidpoint = (min, max) => {
            // Ensure both values are present and numeric before calculating midpoint
            if (min === null || min === undefined || max === null || max === undefined) return null;
            return (min + max) / 2;
        }


        // --- Rendering Functions (Optimized for Consolidated Format) ---

        // 1. Overview and Commentary
        const renderOverview = (summary, meta) => {
            if (!summary) return;
            document.getElementById('overview-section').style.display = 'block';

            const statsContainer = document.getElementById('summary-stats');
            statsContainer.innerHTML = '';

            const stats = [
                { label: 'Total Offered (kg)', value: summary.total_offered_kg, format: 0 },
                { label: 'Total Sold (kg)', value: summary.total_sold_kg, format: 0 },
                { label: 'Offered (Packages)', value: summary.total_offered_packages, format: 0 },
                { label: 'Total Lots', value: summary.total_lots, format: 0 },
                { label: 'Unsold (%)', value: summary.percent_unsold, format: 1, suffix: '%' },
                { label: 'Sold (%)', value: summary.percent_sold, format: 1, suffix: '%' },
                { label: 'Auction Average Price', value: summary.auction_average_price, prefix: meta.currency + ' '},
            ];

            stats.forEach(stat => {
                if (stat.value !== undefined && stat.value !== null) {
                    // Determine format dynamically if not specified (for currency)
                    const format = stat.format !== undefined ? stat.format : (stat.label.includes('Price') ? (meta.currency === 'USD' || meta.currency === 'USc' ? 2 : 0) : 0);
                    
                    const card = document.createElement('div');
                    card.className = 'stat-card';
                    card.innerHTML = `
                        <span class="stat-value">${stat.prefix || ''}${formatNumber(stat.value, format)}${stat.suffix || ''}</span>
                        <span class="stat-label">${stat.label}</span>
                    `;
                    statsContainer.appendChild(card);
                }
            });

            // Use synthesized commentary if available, otherwise fall back to market_comment
            document.getElementById('market-comment').textContent = summary.commentary_synthesized || summary.market_comment || 'Commentary not available.';

            // Highest Prices Table
            if (summary.highest_prices && summary.highest_prices.length > 0) {
                document.getElementById('highest-prices-wrapper').style.display = 'block';
                const highestPricesTbody = document.getElementById('highest-prices-table').querySelector('tbody');
                highestPricesTbody.innerHTML = '';
                summary.highest_prices.forEach(item => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${formatCurrency(item.price, meta.currency)}</td>
                        <td>${item.grade}</td>
                        <td>${item.mark}</td>
                        <td>${item.country || ''}</td>
                    `;
                    highestPricesTbody.appendChild(row);
                });
            }
        };

        // 2. Volume Analysis (Dynamic Table Rendering - Enhanced with WoW Movement)
        const renderVolumeAnalysis = (volumeData, meta) => {
            if (!volumeData) return;
            
            // Chart: By Country
            if (volumeData.by_country && volumeData.by_country.length > 0) {
                document.getElementById('volume-analysis-section').style.display = 'block';
                document.getElementById('country-volume-chart-wrapper').style.display = 'block';
                const ctx = document.getElementById('countryVolumeChart').getContext('2d');
                const labels = volumeData.by_country.map(item => item.country);
                const offered = volumeData.by_country.map(item => item.offered_kg);
                const sold = volumeData.by_country.map(item => item.sold_kg);

                const options = JSON.parse(JSON.stringify(CHART_OPTIONS_BAR));
                options.scales.y.title.text = 'Quantity (kg)';
                options.plugins.legend.display = true;

                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Offered (kg)',
                                data: offered,
                                backgroundColor: CHART_COLORS.secondary,
                            },
                            {
                                label: 'Sold (kg)',
                                data: sold,
                                backgroundColor: CHART_COLORS.primary,
                            }
                        ]
                    },
                    options: options
                });
            }

            // Table: By Grade/Category Detailed (Dynamically adapts to available data fields)
            if (volumeData.by_grade_detailed && volumeData.by_grade_detailed.length > 0) {
                document.getElementById('volume-analysis-section').style.display = 'block';
                document.getElementById('grade-stats-table-wrapper').style.display = 'block';
                const data = volumeData.by_grade_detailed;
                const thead = document.getElementById('grade-stats-table').querySelector('thead');
                const tbody = document.getElementById('grade-stats-table').querySelector('tbody');
                tbody.innerHTML = '';
                thead.innerHTML = '';

                // Determine available columns based on data structure
                const hasPackages = data.some(item => item.offered_packages !== undefined || item.sold_packages !== undefined || item.packages !== undefined);
                const hasKg = data.some(item => item.offered_kg !== undefined || item.sold_kg !== undefined || item.quantity_kg !== undefined);
                const hasLots = data.some(item => item.lots !== undefined);
                const hasPercent = data.some(item => item.percent_unsold !== undefined);
                const hasAvgPrice = data.some(item => item.average_price !== undefined);
                const showSoldPkg = data.some(item => item.sold_packages !== undefined);
                // NEW: Check for Week-on-Week movement data
                const hasMovement = data.some(item => item.movement_vs_last_week !== undefined);


                // Build Header
                let headerHtml = '<tr><th>Category/Grade</th>';
                if (hasLots) headerHtml += '<th>Lots</th>';
                if (hasPackages) {
                    headerHtml += '<th>Offered (Pkg)</th>';
                    if (showSoldPkg) {
                        headerHtml += '<th>Sold (Pkg)</th>';
                    }
                }
                if (hasKg) {
                     headerHtml += '<th>Quantity (kg)</th>';
                }
                if (hasPercent) headerHtml += '<th>Unsold (%)</th>';
                if (hasAvgPrice) headerHtml += '<th>Avg Price</th>';
                if (hasMovement) headerHtml += '<th>vs Last Week</th>'; // NEW Header
                headerHtml += '</tr>';
                thead.innerHTML = headerHtml;

                // Build Rows
                data.forEach(item => {
                    // Use 'grade' or 'category' for the first column
                    let rowHtml = `<tr><td>${item.grade || item.category}</td>`;
                    
                    if (hasLots) rowHtml += `<td>${formatNumber(item.lots)}</td>`;
                    
                    if (hasPackages) {
                        // Handle potential missing offered_packages by checking 'packages' as fallback
                        const offeredPkg = item.offered_packages !== undefined ? item.offered_packages : item.packages;
                        rowHtml += `<td>${formatNumber(offeredPkg)}</td>`;
                        if (showSoldPkg) {
                             rowHtml += `<td>${formatNumber(item.sold_packages)}</td>`;
                        }
                    }
                    
                    if (hasKg) {
                        // Handle different key names (prioritize offered_kg, fallback to quantity_kg)
                        const quantity = item.offered_kg !== undefined ? item.offered_kg : item.quantity_kg;
                        rowHtml += `<td>${formatNumber(quantity)}</td>`;
                    }

                    if (hasPercent) rowHtml += `<td>${formatNumber(item.percent_unsold, 1)}%</td>`;
                    if (hasAvgPrice) rowHtml += `<td>${formatCurrency(item.average_price, meta.currency)}</td>`;
                    
                    // NEW: Display movement vs last week with color coding
                    if (hasMovement) {
                        const decimals = (meta.currency === 'USD' || meta.currency === 'USc') ? 2 : 0;
                        rowHtml += `<td>${formatDiff(item.movement_vs_last_week, decimals)}</td>`;
                    }

                    rowHtml += '</tr>';
                    tbody.innerHTML += rowHtml;
                });
            }
        };

        // 3. Buyer Activity
        const renderBuyerActivity = (activity) => {
            if (!activity || activity.length === 0) return;
            document.getElementById('buyer-activity-section').style.display = 'block';

            // Table: Top Buyers
            const tbody = document.getElementById('buyer-activity-table').querySelector('tbody');
            tbody.innerHTML = '';
            // Display top 15 buyers
            const top15 = activity.slice(0, 15); 
            top15.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.buyer}</td>
                    <td>${formatNumber(item.volume_kg)}</td>
                    <td>${formatNumber(item.market_share, 2)}%</td>
                `;
                tbody.appendChild(row);
            });

            // Chart: Market Share (Pie Chart)
            const ctx = document.getElementById('buyerChart').getContext('2d');

            // Prepare data for pie chart: Top 9 + Others
            const sortedActivity = [...activity].sort((a, b) => b.market_share - a.market_share);
            
            // Filter out explicit "Others" categories if they exist in the source data to avoid duplication
            const primaryActivity = sortedActivity.filter(item => !item.buyer.toLowerCase().includes("others (local/misc)") && !item.buyer.toLowerCase().includes("others (calculated)"));
            
            const top9 = primaryActivity.slice(0, 9);
            const others = primaryActivity.slice(9);
            
            const chartData = [...top9];
            if (others.length > 0) {
                const othersTotal = others.reduce((sum, item) => sum + item.market_share, 0);
                 // Ensure 'Others' total is meaningful before adding
                if (othersTotal > 0.1) {
                    chartData.push({ buyer: 'Others (Calculated)', market_share: othersTotal });
                }
            }

            const labels = chartData.map(item => item.buyer);
            const values = chartData.map(item => item.market_share);

            const options = JSON.parse(JSON.stringify(CHART_OPTIONS_PIE));

            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Market Share (%)',
                        data: values,
                        backgroundColor: PIE_COLORS,
                    }]
                },
                options: options
            });
        };

        // 4. Comparative Analysis (Handles both structured YoY and generic comparisons - Enhanced with Diffs)
        const renderComparativeAnalysis = (comparison, meta) => {
            if (!comparison) return;
            
            const currentYear = meta.year;
            const prevYear = currentYear - 1;
            const currencyDecimals = (meta.currency === 'USD' || meta.currency === 'USc') ? 2 : 0;

            // A. Structured YoY Comparison (e.g., Mombasa)
            if (comparison.country_averages_yoy && comparison.country_averages_yoy.length > 0) {
                document.getElementById('comparative-analysis-section').style.display = 'block';
                document.getElementById('country-comparison-wrapper').style.display = 'block';

                // Update Headers
                document.getElementById('header-current-year-sale').textContent = currentYear;
                document.getElementById('header-prev-year-sale').textContent = prevYear;
                document.getElementById('header-current-year-ytd').textContent = currentYear;
                document.getElementById('header-prev-year-ytd').textContent = prevYear;

                const tbody = document.getElementById('country-comparison-table').querySelector('tbody');
                tbody.innerHTML = '';
                comparison.country_averages_yoy.forEach(item => {
                    const row = document.createElement('tr');
                    // Dynamically access properties based on year
                    const avgCurrent = item[`avg_${currentYear}`];
                    const avgPrev = item[`avg_${prevYear}`];
                    const ytdCurrent = item[`ytd_${currentYear}`];
                    const ytdPrev = item[`ytd_${prevYear}`];

                    // Calculate differences
                    const diffSale = (avgCurrent !== undefined && avgPrev !== undefined) ? avgCurrent - avgPrev : null;
                    const diffYtd = (ytdCurrent !== undefined && ytdPrev !== undefined) ? ytdCurrent - ytdPrev : null;

                    // Build Row with Diffs
                    row.innerHTML = `
                        <td>${item.country}</td>
                        <td>${formatCurrency(avgCurrent, meta.currency)}</td>
                        <td>${formatCurrency(avgPrev, meta.currency)}</td>
                        <td>${formatDiff(diffSale, currencyDecimals)}</td>
                        <td>${formatCurrency(ytdCurrent, meta.currency)}</td>
                        <td>${formatCurrency(ytdPrev, meta.currency)}</td>
                        <td>${formatDiff(diffYtd, currencyDecimals)}</td>
                    `;
                    tbody.appendChild(row);
                });
            }

             // Footer and Chart: Total Auction Average Visualization
            if (comparison.auction_average_yoy) {
                document.getElementById('comparative-analysis-section').style.display = 'block';
                const avg = comparison.auction_average_yoy;
                const avgCurrent = avg[`avg_${currentYear}`];
                const avgPrev = avg[`avg_${prevYear}`];
                const ytdCurrent = avg[`ytd_${currentYear}`];
                const ytdPrev = avg[`ytd_${prevYear}`];

                // Update Footer if Country Table exists
                if (comparison.country_averages_yoy && comparison.country_averages_yoy.length > 0) {
                    const tfoot = document.getElementById('country-comparison-table').querySelector('tfoot');
                    
                    const diffSale = (avgCurrent !== undefined && avgPrev !== undefined) ? avgCurrent - avgPrev : null;
                    const diffYtd = (ytdCurrent !== undefined && ytdPrev !== undefined) ? ytdCurrent - ytdPrev : null;

                    // Build Footer with Diffs
                    tfoot.innerHTML = `
                        <tr style="font-weight: bold; background-color: #f1f3f4;">
                            <td>AUCTION AVERAGE</td>
                            <td>${formatCurrency(avgCurrent, meta.currency)}</td>
                            <td>${formatCurrency(avgPrev, meta.currency)}</td>
                            <td>${formatDiff(diffSale, currencyDecimals)}</td>
                            <td>${formatCurrency(ytdCurrent, meta.currency)}</td>
                            <td>${formatCurrency(ytdPrev, meta.currency)}</td>
                            <td>${formatDiff(diffYtd, currencyDecimals)}</td>
                        </tr>
                    `;
                }

                // Render Chart
                document.getElementById('auction-avg-chart-wrapper').style.display = 'block';
                const ctx = document.getElementById('auctionAvgChart').getContext('2d');
                
                const labels = ['Current Sale', 'Year-to-Date'];
                // Handle cases where YTD might not be present
                const currentYearData = [avgCurrent, ytdCurrent].filter(v => v !== undefined);
                const prevYearData = [avgPrev, ytdPrev].filter(v => v !== undefined);

                const chartLabels = currentYearData.length === 2 ? labels : ['Current Sale'];

                const options = JSON.parse(JSON.stringify(CHART_OPTIONS_BAR));
                options.scales.y.title.text = `Price (${meta.currency})`;
                options.plugins.legend.display = true;

                 new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: chartLabels,
                        datasets: [
                            {
                                label: prevYear,
                                data: prevYearData,
                                backgroundColor: CHART_COLORS.secondary,
                            },
                            {
                                label: currentYear,
                                data: currentYearData,
                                backgroundColor: CHART_COLORS.primary,
                            }
                        ]
                    },
                    options: options
                });
            }


            // B. Generic Comparison Tables (e.g., Colombo Quantity Sold, India Averages)
            if (comparison.generic_tables && comparison.generic_tables.length > 0) {
                document.getElementById('comparative-analysis-section').style.display = 'block';
                document.getElementById('generic-comparison-wrapper').style.display = 'block';
                const container = document.getElementById('generic-comparison-container');
                container.innerHTML = ''; // Clear previous content

                comparison.generic_tables.forEach(tableData => {
                    const wrapper = document.createElement('div');
                    wrapper.style.marginBottom = '24px';
                    wrapper.innerHTML = `<h4>${tableData.title}</h4>`;

                    const tableContainer = document.createElement('div');
                    tableContainer.className = 'data-table-container';
                    const table = document.createElement('table');
                    table.className = 'data-table stats-table';

                    // Header (Handles multi-level headers if defined)
                    let headerHtml = '<thead>';
                    tableData.headers.forEach(headerRow => {
                        headerHtml += '<tr>';
                        headerRow.forEach(cell => {
                            headerHtml += `<th rowspan="${cell.rowspan || 1}" colspan="${cell.colspan || 1}" class="${cell.class || ''}">${cell.label}</th>`;
                        });
                        headerHtml += '</tr>';
                    });
                    headerHtml += '</thead>';
                    table.innerHTML = headerHtml;

                    // Body
                    const tbody = document.createElement('tbody');
                    tableData.rows.forEach(rowData => {
                        const row = document.createElement('tr');
                        if (rowData.is_total) {
                             row.style.fontWeight = 'bold';
                             // Slightly different shade for subtotals vs grand totals
                             row.style.backgroundColor = '#f8f9fa'; 
                        }

                        // Iterate over the keys defined in the data_keys map
                        tableData.data_keys.forEach(keyInfo => {
                            const value = rowData[keyInfo.key];
                            let displayValue = value;

                            // Apply formatting based on type
                            if (keyInfo.format === 'currency') {
                                displayValue = formatCurrency(value, meta.currency);
                            } else if (keyInfo.format === 'number') {
                                displayValue = formatNumber(value, keyInfo.decimals || 0);
                            } else if (keyInfo.format === 'diff') {
                                 // Use dynamic decimals for diffs if not specified
                                 const decimals = keyInfo.decimals !== undefined ? keyInfo.decimals : currencyDecimals;
                                 displayValue = formatDiff(value, decimals);
                            }
                            // Add cell
                            row.innerHTML += `<td>${displayValue}</td>`;
                        });
                        tbody.appendChild(row);
                    });

                    table.appendChild(tbody);
                    tableContainer.appendChild(table);
                    wrapper.appendChild(tableContainer);
                    container.appendChild(wrapper);
                });
            }
        };

        // 5. Factory Performance
        const renderFactoryPerformance = (performance, meta) => {
            if (!performance || performance.length === 0) return;
            document.getElementById('factory-performance-section').style.display = 'block';

            const tbody = document.getElementById('factory-performance-table').querySelector('tbody');
            tbody.innerHTML = '';

            // Display Top 50 (or fewer if data is limited)
            const top50 = performance.slice(0, 50);

            top50.forEach((item, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${item.mark}</td>
                    <td>${item.country}</td>
                    <td>${formatCurrency(item.average_price, meta.currency)}</td>
                    <td>${item.top_grade}</td>
                    <td>${formatCurrency(item.top_price, meta.currency)}</td>
                `;
                tbody.appendChild(row);
            });
        };

        // 6. Price Quotations (Enhanced with Movement Calculation)
         const renderPriceQuotations = (quotations, currency) => {
            if (!quotations || quotations.length === 0) return;

            document.getElementById('price-quotations-section').style.display = 'block';
            document.getElementById('price-quotations-title').textContent = `Price Quotations & Movement (${currency}/kg)`;

            const table = document.getElementById('price-quotations-table');
            const thead = table.querySelector('thead');
            const tbody = table.querySelector('tbody');
            tbody.innerHTML = '';
            thead.innerHTML = '';

            // Determine available columns
            const hasElevation = quotations.some(item => item.elevation !== undefined);
            const hasCategory = quotations.some(item => item.category !== undefined);
            // Check if previous data exists and is complete enough for comparison
            const hasPrevious = quotations.some(item => item.previous_min !== undefined && item.previous_max !== undefined);
            
            // Build Header
            let headerHtml = '<tr>';
            if (hasElevation) headerHtml += '<th>Elevation</th>';
            if (hasCategory) headerHtml += '<th>Category/Region</th>';
            headerHtml += '<th>Grade</th><th>Current (Low-High)</th>';
            if (hasPrevious) {
                headerHtml += '<th>Previous (Low-High)</th>';
                headerHtml += '<th>Movement</th>'; // New Column
            }
            headerHtml += '</tr>';
            thead.innerHTML = headerHtml;

            // Build Rows
            quotations.forEach(item => {
                let rowHtml = '<tr>';
                if (hasElevation) rowHtml += `<td>${item.elevation}</td>`;
                if (hasCategory) rowHtml += `<td>${item.category}</td>`;
                rowHtml += `<td>${item.grade}</td><td>${formatPriceRange(item.current_min, item.current_max, currency)}</td>`;
                
                if (hasPrevious) {
                    rowHtml += `<td>${formatPriceRange(item.previous_min, item.previous_max, currency)}</td>`;
                    
                    // Calculate Movement based on midpoints
                    const currentMid = getMidpoint(item.current_min, item.current_max);
                    const previousMid = getMidpoint(item.previous_min, item.previous_max);
                    let movementHtml = 'N/A';

                    if (currentMid !== null && previousMid !== null) {
                        const diff = currentMid - previousMid;
                        const decimals = (currency === 'USD' || currency === 'USc') ? 2 : 0;
                        movementHtml = formatDiff(diff, decimals);
                    }
                    rowHtml += `<td>${movementHtml}</td>`;
                }
                
                rowHtml += '</tr>';
                tbody.innerHTML += rowHtml;
            });
        };

        // 7. Forecast Analysis (NEW)
        const renderForecastAnalysis = (forecast) => {
            if (!forecast || forecast.length === 0) return;
            document.getElementById('forecast-section').style.display = 'block';
            const container = document.getElementById('forecast-container');
            container.innerHTML = '';

            forecast.forEach(item => {
                const block = document.createElement('div');
                block.className = 'forecast-block';

                // Determine color coding based on sentiment
                let sentimentClass = '';
                if (item.sentiment === 'Positive') sentimentClass = 'sentiment-positive';
                else if (item.sentiment === 'Negative') sentimentClass = 'sentiment-negative';
                else if (item.sentiment === 'Neutral') sentimentClass = 'sentiment-neutral';

                block.innerHTML = `
                    <h4>${item.factor}</h4>
                    <p><strong class="${sentimentClass}">Outlook: ${item.outlook}</strong></p>
                    <p>${item.analysis}</p>
                `;
                container.appendChild(block);
            });
        };


        // 8. Weather and Upcoming Offerings
        const renderForwardLook = (weather, upcoming) => {
            
            const weatherExists = weather && weather.length > 0;
            const upcomingExists = upcoming && Object.keys(upcoming).length > 0;

            if (!weatherExists && !upcomingExists) return;
            document.getElementById('forward-look-section').style.display = 'block';

            // Weather Analysis
            if (weatherExists) {
                document.getElementById('weather-section').style.display = 'block';
                const tbody = document.getElementById('weather-table').querySelector('tbody');
                tbody.innerHTML = '';

                weather.forEach(item => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${item.region}</td>
                        <td>${item.conditions}</td>
                    `;
                    tbody.appendChild(row);
                });
            }

            // Upcoming Offerings
            if (upcomingExists) {
                document.getElementById('upcoming-section').style.display = 'block';
                const container = document.getElementById('upcoming-container');
                container.innerHTML = '';

                for (const saleKey in upcoming) {
                    const saleData = upcoming[saleKey];
                    const saleNumber = saleKey.replace('sale_', '');

                    const block = document.createElement('div');
                    block.className = 'upcoming-block';

                    let html = `<h4>Sale ${saleNumber} (${saleData.date})</h4>`;

                    // Handle different metrics (Packages vs M/Kgs)
                    const metric = saleData.total_packages ? 'Packages' : (saleData.total_m_kgs ? 'M/Kgs' : '');
                    const value = saleData.total_packages || saleData.total_m_kgs;

                    if (metric && value) {
                         html += `<p><strong>Total Estimated: ${formatNumber(value, metric === 'M/Kgs' ? 2 : 0)} ${metric}</strong></p>`;
                    }
                   
                    
                    // Check if country breakdown exists (Mombasa)
                    if (saleData.by_country && saleData.by_country.length > 0) {
                        html += `<div class="data-table-container"><table class="data-table compact-table">
                                    <thead><tr><th>Country</th><th>Packages</th></tr></thead><tbody>`;
                        
                        saleData.by_country.forEach(item => {
                            html += `<tr><td>${item.country}</td><td>${formatNumber(item.packages)}</td></tr>`;
                        });

                        html += `</tbody></table></div>`;
                    }
                     // Check if elevation breakdown exists (Colombo)
                    else if (saleData.by_elevation && saleData.by_elevation.length > 0) {
                        html += `<div class="data-table-container"><table class="data-table compact-table">
                                    <thead><tr><th>Elevation</th><th>M/Kgs</th></tr></thead><tbody>`;
                        
                        saleData.by_elevation.forEach(item => {
                            html += `<tr><td>${item.elevation}</td><td>${formatNumber(item.m_kgs, 2)}</td></tr>`;
                        });

                        html += `</tbody></table></div>`;
                    }

                    block.innerHTML = html;
                    container.appendChild(block);
                }
            }
        };

         // 9. International Summaries
        const renderInternationalSummaries = (summaries) => {
             const section = document.getElementById('international-section');
             const container = document.getElementById('international-container');

            if (!summaries || summaries.length === 0) return;
            
            section.style.display = 'block';
            container.innerHTML = '';

             summaries.forEach(summary => {
                    const summaryDiv = document.createElement('div');
                    summaryDiv.className = 'international-summary-item';

                    let contentHtml = `<h4>${summary.centre} (Sale ${summary.sale_no || 'N/A'})</h4>
                                       <p style="font-size: 13px; color: #5f6368;">${summary.date || ''}</p>
                                       <p>${summary.summary || 'Summary not available.'}</p>`;
                    
                    // Handle structured data if present (e.g., Mombasa details)
                    if (summary.structured_data && summary.structured_data.currency) {
                        contentHtml += `<p><strong>Quotations (${summary.structured_data.currency}):</strong></p>`;
                        
                        const renderTable = (grades, title) => {
                            if (!grades || grades.length === 0) return '';
                            let tableHtml = `<div class="data-table-container" style="margin-bottom: 16px; max-width: 500px;">
                                             <p style="font-weight: 500; margin-bottom: 8px;">${title}</p>
                                             <table class="data-table">
                                             <thead><tr><th>Category</th><th>Grade</th><th>Low</th><th>High</th></tr></thead><tbody>`;
                            grades.forEach(grade => {
                                tableHtml += `<tr>
                                                <td>${grade.category}</td>
                                                <td>${grade.grade}</td>
                                                <td>${formatNumber(grade.low, 2)}</td>
                                                <td>${formatNumber(grade.high, 2)}</td>
                                              </tr>`;
                            });
                            tableHtml += `</tbody></table></div>`;
                            return tableHtml;
                        };

                        contentHtml += renderTable(summary.structured_data.ctc_leaf_grades, "CTC Leaf");
                        contentHtml += renderTable(summary.structured_data.ctc_dust_grades, "CTC Dust");
                    }

                    summaryDiv.innerHTML = contentHtml;
                    container.appendChild(summaryDiv);
                });
        };


        // Main Report Rendering Logic (Orchestration)
        const renderReport = (data) => {
            // !! CHANGE START: Adapt to potential nesting when loading from the library !!
            // We attempt to find the data and metadata robustly
            const reportData = data.data || data;
            const meta = reportData.metadata || data.metadata;

            if (!meta) {
                console.error("Metadata not found in the report data structure.", data);
                document.getElementById('report-title').textContent = 'Error: Invalid report structure (Metadata missing).';
                return;
            }
            // !! CHANGE END !!

            // 1. Metadata and Title
            const titlePrefix = meta.report_title || `${meta.auction_centre} Consolidated Auction Report`;
            const weekOrSale = meta.sale_number ? `Sale ${meta.sale_number}` : (meta.week_number ? `Week ${meta.week_number}` : '');
            
            document.getElementById('report-title').textContent = `${titlePrefix} - ${weekOrSale} (${meta.year})`;
            
            let metaText = `Week: ${meta.week_number || 'N/A'}`;
            
            // Date formatting
            const startDate = meta.sale_date_start;
            const endDate = meta.sale_date_end;
            if (startDate && endDate && startDate !== endDate) {
                metaText += ` | Dates: ${startDate} to ${endDate}`;
            } else if (endDate) {
                 metaText += ` | Date: ${endDate}`;
            }

            if (meta.prompt_date) {
                metaText += ` | Prompt Date: ${meta.prompt_date}`;
            }
            metaText += ` | Currency: ${meta.currency}`;
            
            if (meta.exchange_rate_note) {
                metaText += ` | Exchange: ${meta.exchange_rate_note}`;
            }

            document.getElementById('report-meta').textContent = metaText;

            // 2. Render Sections (Order based on typical importance)
            // We use reportData here for the content sections
            renderOverview(reportData.summary, meta);
            renderVolumeAnalysis(reportData.volume_analysis, meta);
            renderBuyerActivity(reportData.buyer_activity);
            renderComparativeAnalysis(reportData.comparative_analysis, meta);
            renderFactoryPerformance(reportData.factory_performance, meta);
            renderPriceQuotations(reportData.price_quotations, meta.currency);
            renderForecastAnalysis(reportData.forecast_analysis); // NEW
            renderForwardLook(reportData.weather_analysis, reportData.upcoming_offerings);
            renderInternationalSummaries(reportData.international_summaries);
        };

        // --- Data Loading ---
        // !! REPLACED LOGIC START - This section replaces the original data loader !!
        document.addEventListener('DOMContentLoaded', async () => {
            // Initialize mobile menu toggle
             if (typeof initializeMobileMenu === 'function') {
                initializeMobileMenu();
            }

            const loadingIndicator = document.getElementById('loading-indicator');
            const reportContentEl = document.getElementById('report-content');
            
            try {
                // 1. Get the report identifier from the URL parameter 'title' (replacing 'dataset')
                const params = new URLSearchParams(window.location.search);
                const reportTitleToFind = params.get('title');

                if (!reportTitleToFind) {
                    // This specifically addresses the error the user originally saw.
                    throw new Error("No report selected (URL parameter 'title' is missing).");
                }

                // 2. Fetch the central library (instead of the Consolidated directory)
                const response = await fetch('market-reports-library.json');
                if (!response.ok) {
                    throw new Error(`Failed to load library (market-reports-library.json). Status: ${response.status}`);
                }
                const library = await response.json();

                // 3. Find the report within the library
                let foundReport = null;
                
                // Search nested structure (e.g., { "Location": { "Title": data } })
                for (const key in library) {
                    const entry = library[key];
                    // Check if the entry is an object (and not an array/null) and contains the report title
                    if (typeof entry === 'object' && entry !== null && !Array.isArray(entry) && entry[reportTitleToFind]) {
                        foundReport = entry[reportTitleToFind];
                        break;
                    }
                }

                // Also check if the report is at the top level (if the library structure happens to be flat)
                if (!foundReport && library[reportTitleToFind]) {
                    foundReport = library[reportTitleToFind];
                }

                if (!foundReport) {
                    throw new Error(`Report "${reportTitleToFind}" not found in the library.`);
                }
                
                // 4. Orchestrate the rendering
                renderReport(foundReport);
                
                // 5. Display content
                loadingIndicator.style.display = 'none';
                reportContentEl.style.display = 'block';

            } catch (error) {
                console.error('Error fetching or processing report data:', error);
                document.getElementById('report-title').textContent = 'Error loading report.';
                // Display the specific error message
                loadingIndicator.textContent = `Error: ${error.message}`;
            }
        });
        // !! REPLACED LOGIC END !!
    </script>
</body>
</html>
