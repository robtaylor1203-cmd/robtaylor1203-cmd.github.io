<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market Report Viewer - TeaTrade</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="market-reports-page">
    <header class="site-header">
        <div class="header-top-bar">
            <a href="corporate.html" class="header-logo"><h1>Tea<span>Trade</span></h1></a>
            <div class="header-search-wrapper"><input type="text" class="header-search-bar" placeholder="Global site search..."></div>
            <div class="user-actions">
                <a href="#" title="Create Account"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><line x1="20" y1="8" x2="20" y2="14"></line><line x1="17" y1="11" x2="23" y2="11"></line></svg></a>
                <a href="#" title="Sign In"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path><polyline points="10 17 15 12 10 7"></polyline><line x1="15" y1="12" x2="3" y2="12"></line></svg></a>
            </div>
            <button class="mobile-menu-toggle" aria-label="Toggle navigation" aria-expanded="false">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
            </button>
        </div>
        <nav class="secondary-nav">
            <ul>
                <li><a href="data.html">Data</a></li>
                <li><a href="market-reports.html" class="active">Market Reports</a></li>
                <li><a href="#">Auctions</a></li>
                <li><a href="visuals.html">Visuals</a></li>
            </ul>
        </nav>
    </header>

    <main class="page-container">
        <div class="dashboard-header">
            <h2 class="page-title" id="report-title">Loading Report...</h2>
        </div>
        <p id="report-meta" style="margin-bottom: 24px; color: #5f6368;"></p>

        <div id="report-content" style="display: none;">
            
            <div class="stat-cards-container" id="summary-stats"></div>

            <section class="report-section" id="global-stats-section" style="display: none;">
                <h3>Global Statistics</h3>
                </section>

            <section class="report-section" id="volume-visualization-section" style="display: none;">
                <h3>Volume Analysis</h3>
                <div class="distribution-container" id="volume-visualization-container">
                    <div class="distribution-block" id="offerings-chart-block" style="display: none;">
                        <h4>Offerings Breakdown (kg)</h4>
                        <div style="position: relative; height: 300px;"><canvas id="offeringsChart"></canvas></div>
                    </div>
                    <div class="distribution-block" id="country-chart-block" style="display: none;">
                         <h4>Offered vs Sold by Country (kg)</h4>
                        <div style="position: relative; height: 300px;"><canvas id="countryChart"></canvas></div>
                    </div>
                </div>
            </section>

            <section class="report-section" id="summary-section" style="display: none;">
                <h3>Market Commentary</h3>
                <p id="market-comment"></p>
                <p id="quality-wrapper" style="display: none;"><strong>Quality:</strong> <span id="quality-comment"></span></p>
            </section>

            <section class="report-section" id="commentary-grid-section" style="display: none;">
                 <h3>Market Synopsis & Buying Analysis</h3>
                <div class="commentary-grid" id="commentary-container"></div>
            </section>

            <section class="report-section" id="buyer-activity-section" style="display: none;">
                <h3>Buyer Activity & Market Share</h3>
                <div class="distribution-container">
                    <div class="distribution-block" style="flex: 1;">
                        <h4>Top Buyers by Volume (Kg)</h4>
                        <div class="data-table-container">
                            <table class="data-table stats-table" id="buyer-activity-table">
                                <thead>
                                    <tr>
                                        <th>Buyer</th>
                                        <th>Packages</th>
                                        <th>Quantity (Kg)</th>
                                        <th>Market Share (%)</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                                <tfoot></tfoot>
                            </table>
                        </div>
                    </div>
                    <div class="distribution-block" style="flex: 1; max-width: 450px;">
                         <h4>Market Share Visualization</h4>
                         <div style="position: relative; height: 350px;"><canvas id="buyerShareChart"></canvas></div>
                    </div>
                </div>
            </section>
            <section class="report-section" id="averages-analysis-section" style="display: none;">
                 <h3>Auction Averages Analysis</h3>
                 <div class="data-table-container" style="max-width: 600px;">
                    <table class="data-table stats-table" id="averages-analysis-table">
                        <thead></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </section>

            <section class="report-section" id="quantity-comparison-section" style="display: none;">
                <h3>Quantity Sold Comparison (kg)</h3>
                 <div class="data-table-container">
                    <table class="data-table stats-table" id="quantity-comparison-table">
                        <thead></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </section>

            <section class="report-section" id="auction-offerings-multi-section" style="display: none;">
                 <h3>Auction Offerings Comparison</h3>
                 <div class="comparison-grid" id="auction-offerings-multi-container"></div>
            </section>

            <section class="report-section" id="offerings-grade-section" style="display: none;">
                <h3 id="offerings-grade-title">Auction Offerings</h3>
                <div class="data-table-container">
                    <table class="data-table" id="offerings-grade-table">
                        <thead></thead>
                        <tbody></tbody>
                        <tfoot></tfoot>
                    </table>
                </div>
            </section>

            <section class="report-section" id="country-breakdown-section" style="display: none;">
                <h3>Offerings vs. Sold (by Country)</h3>
                <div class="comparison-grid" id="country-breakdown-tables">
                    </div>
            </section>

            <section class="report-section" id="prices-section" style="display: none;">
                <h3 id="price-quotations-title">Price Quotations</h3>
                <div class="data-table-container">
                    <table class="data-table" id="prices-table">
                        <thead></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </section>

            <section class="report-section" id="averages-comparison-section" style="display: none;">
                <h3 id="averages-title">Auction Averages Comparison</h3>
                 <div class="data-table-container">
                    <table class="data-table stats-table" id="averages-table">
                        <thead></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </section>

            <section class="report-section" id="price-distribution-section" style="display: none;">
                 <h3 id="price-distribution-title">Price Distribution Analysis (% of Teas Sold)</h3>
                 <div class="distribution-container" id="distribution-container"></div>
            </section>

            <section class="report-section" id="detailed-stats-section" style="display: none;">
                <h3>Detailed Offer/Sold Statistics</h3>
                </section>

            <section class="report-section" id="international-section" style="display: none;">
                <h3>International Summaries</h3>
                <div id="international-container"></div>
            </section>

        </div>
        <div id="loading-indicator">Loading data...</div>
    </main>
    <script src="script.js"></script>
    <script>
        // --- Configuration ---
        const CHART_COLORS = {
            primary: 'rgba(26, 115, 232, 0.8)', // Blue
            secondary: 'rgba(128, 178, 247, 0.8)', // Lighter Blue
            accent1: 'rgba(251, 188, 4, 0.8)', 
            accent2: 'rgba(52, 168, 83, 0.8)', 
            neutral: 'rgba(160, 160, 160, 0.8)'
        };

        // A color palette for Pie Charts (Buyer Activity)
        const PIE_COLORS = [
            '#1a73e8', '#34a853', '#fbbc04', '#ea4335', '#9334e6', 
            '#00c0a3', '#ff7733', '#4e54c8', '#c84e89', '#4dc9f6',
            '#f67019', '#f53794', '#537bc4', '#acc236'
        ];

        const CHART_OPTIONS_BAR = {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: { display: true, text: 'Value' }
                },
                x: {
                    ticks: { autoSkip: false, maxRotation: 45, minRotation: 45 }
                }
            },
            plugins: { legend: { display: false } }
        };

        const CHART_OPTIONS_PIE = {
             responsive: true,
            maintainAspectRatio: false,
            plugins: { 
                legend: { 
                    display: true,
                    position: 'right',
                    labels: {
                        boxWidth: 12,
                        padding: 10
                    }
                } 
            }
        };

        // --- Utility Functions ---
        const formatNumber = (num, decimals = 0) => {
            if (num === null || num === undefined || isNaN(num)) return 'N/A';
            return num.toLocaleString(undefined, { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
        };

        const formatCurrency = (num) => formatNumber(num, 2);

        const formatPriceRange = (min, max) => {
             if ((min === null || min === undefined) && (max === null || max === undefined)) return 'N/A';
             return `${formatNumber(min, 2)} - ${formatNumber(max, 2)}`;
        }

        const formatDiff = (num, decimals = 2) => {
            if (num === null || num === undefined) return 'N/A';
            const formatted = formatNumber(num, decimals);
            const className = num > 0 ? 'diff-positive' : (num < 0 ? 'diff-negative' : '');
             // Add +/- sign explicitly for non-zero values
            const sign = num > 0 ? '+' : ''; 
            return `<span class="${className}">${sign}${formatted}</span>`;
        }

        // --- Rendering Functions (Modularized by Data Type) ---

        // Renderer for Global Statistics (Contemporary Brokers style)
        const renderGlobalStatistics = (globalStats, meta) => {
            if (!globalStats || Object.keys(globalStats).length === 0) return;

            const section = document.getElementById('global-stats-section');
            
            // Prevent re-rendering if already processed
            if (section.dataset.processed === "true") return;
            section.style.display = 'block';

            // World Crop Comparison
            if (globalStats.world_crop_comparison) {
                const comparison = globalStats.world_crop_comparison;
                const wrapper = document.createElement('div');
                wrapper.style.marginBottom = '24px';
                wrapper.innerHTML = `<h4>World Crop Comparison (M.Kg)</h4>`;

                // Visualization
                const chartWrapper = document.createElement('div');
                chartWrapper.className = 'distribution-block';
                chartWrapper.style.marginBottom = '16px';
                const canvasId = 'worldCropChart';
                chartWrapper.innerHTML = `<div style="position: relative; height: 350px;"><canvas id="${canvasId}"></canvas></div>`;
                section.appendChild(chartWrapper); // Append chart directly to section

                const ctx = chartWrapper.querySelector(`#${canvasId}`).getContext('2d');
                // Filter out the total row for the chart data, include major regions
                const chartData = comparison.filter(item => item.region !== 'TOTAL' && item.region !== 'ALL INDIA');
                const labels = chartData.map(item => item.region);
                const currentYearValues = chartData.map(item => item.current_year_todate);
                const previousYearValues = chartData.map(item => item.previous_year_todate);

                const options = JSON.parse(JSON.stringify(CHART_OPTIONS_BAR));
                options.scales.y.title.text = 'Volume (M.Kg) To Date';
                options.plugins.legend.display = true;

                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: `${meta.year-1} To Date`,
                                data: previousYearValues,
                                backgroundColor: CHART_COLORS.secondary,
                            },
                            {
                                label: `${meta.year} To Date`,
                                data: currentYearValues,
                                backgroundColor: CHART_COLORS.primary,
                            }
                        ]
                    },
                    options: options
                });

                // Table
                const tableContainer = document.createElement('div');
                tableContainer.className = 'data-table-container';
                
                const table = document.createElement('table');
                table.className = 'data-table stats-table';
                
                // Header
                table.innerHTML = `
                    <thead>
                        <tr>
                            <th rowspan="2" class="header-main">Region</th>
                            <th rowspan="2" class="header-main">Month</th>
                            <th colspan="2" class="header-main">${meta.year}</th>
                            <th colspan="2" class="header-main">${meta.year-1}</th>
                            <th rowspan="2" class="header-main">+/- To Date</th>
                        </tr>
                        <tr>
                            <th class="header-sub">Monthly</th>
                            <th class="header-sub">To Date</th>
                            <th class="header-sub">Monthly</th>
                            <th class="header-sub">To Date</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                `;
                
                const tbody = table.querySelector('tbody');
                comparison.forEach(item => {
                    const row = document.createElement('tr');
                     if (item.region === "TOTAL" || item.region === "ALL INDIA") {
                        row.style.fontWeight = 'bold';
                        row.style.backgroundColor = '#f1f3f4';
                    }
                    row.innerHTML = `
                        <td>${item.region}</td>
                        <td>${item.month || ''}</td>
                        <td>${formatNumber(item.current_year_monthly, 1)}</td>
                        <td>${formatNumber(item.current_year_todate, 1)}</td>
                        <td>${formatNumber(item.previous_year_monthly, 1)}</td>
                        <td>${formatNumber(item.previous_year_todate, 1)}</td>
                        <td>${formatDiff(item.difference_todate, 1)}</td>
                    `;
                    tbody.appendChild(row);
                });
                
                tableContainer.appendChild(table);
                wrapper.appendChild(tableContainer);
                section.appendChild(wrapper);
            }
            section.dataset.processed = "true";
        };


        // Renderer for General Summary (Colombo/Mombasa/Jakarta style)
        const renderGeneralSummary = (summary) => {
            if (!summary) return;
            
            const statsContainer = document.getElementById('summary-stats');
            // statsContainer.innerHTML = ''; // Keep existing content if other renderers add stats

            const stats = [
                { label: 'Total Quantity (kg)', value: summary.total_quantity_kg, format: 0 },
                { label: 'Total Packages', value: summary.total_packages, format: 0 },
                { label: 'Total Lots', value: summary.total_lots, format: 0 },
                // Prioritize 'percent_sold' if available (Jakarta), otherwise use 'percent_unsold' (Mombasa/Colombo)
                { label: '% Sold', value: summary.percent_sold, format: 2, suffix: '%' },
                { label: '% Unsold', value: summary.percent_unsold, format: 2, suffix: '%' },
            ];

            stats.forEach(stat => {
                if (stat.value !== undefined && stat.value !== null) {
                    // Check if a Sold/Unsold stat has already been added to avoid duplicates
                    if ((stat.label === '% Sold' || stat.label === '% Unsold') && statsContainer.dataset.soldUnsoldAdded) {
                        return;
                    }

                    const card = document.createElement('div');
                    card.className = 'stat-card';
                    card.innerHTML = `
                        <span class="stat-value">${formatNumber(stat.value, stat.format)}${stat.suffix || ''}</span>
                        <span class="stat-label">${stat.label}</span>
                    `;
                    statsContainer.appendChild(card);

                    if (stat.label === '% Sold' || stat.label === '% Unsold') {
                        statsContainer.dataset.soldUnsoldAdded = true;
                    }
                }
            });

            if (summary.market_comment) {
                 document.getElementById('summary-section').style.display = 'block';
                 document.getElementById('market-comment').textContent = summary.market_comment;
            }
           
            if (summary.quality_comment) {
                document.getElementById('summary-section').style.display = 'block';
                document.getElementById('quality-wrapper').style.display = 'block';
                document.getElementById('quality-comment').textContent = summary.quality_comment;
            }
        };

        // NEW: Renderer for Buyer Activity (Jakarta style)
        const renderBuyerActivity = (activity, summary) => {
            if (!activity || activity.length === 0) return;

            document.getElementById('buyer-activity-section').style.display = 'block';
            const table = document.getElementById('buyer-activity-table');
            const tbody = table.querySelector('tbody');
            const tfoot = table.querySelector('tfoot');
            tbody.innerHTML = '';

            // Sort by Quantity Kg descending
            const sortedActivity = [...activity].sort((a, b) => b.quantity_kg - a.quantity_kg);

            sortedActivity.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.buyer}</td>
                    <td>${formatNumber(item.packages)}</td>
                    <td>${formatNumber(item.quantity_kg)}</td>
                    <td>${formatNumber(item.market_share_percent, 2)}%</td>
                `;
                tbody.appendChild(row);
            });

            // Footer (Totals)
            if (summary && summary.sold_packages && summary.sold_quantity_kg) {
                tfoot.innerHTML = `<tr style="font-weight: bold; background-color: #f1f3f4;">
                    <td>TOTAL SOLD</td>
                    <td>${formatNumber(summary.sold_packages)}</td>
                    <td>${formatNumber(summary.sold_quantity_kg)}</td>
                    <td>100.00%</td>
                </tr>`;
            }

            // Visualization (Pie Chart)
            const ctx = document.getElementById('buyerShareChart').getContext('2d');
            
            // Prepare data for Pie Chart: Group smaller buyers if there are too many
            const MAX_SLICES = 10;
            let chartData = [];
            if (sortedActivity.length > MAX_SLICES) {
                chartData = sortedActivity.slice(0, MAX_SLICES);
                const others = sortedActivity.slice(MAX_SLICES).reduce((acc, item) => {
                    acc.quantity_kg += item.quantity_kg;
                    return acc;
                }, { buyer: 'Others', quantity_kg: 0 });
                if (others.quantity_kg > 0) {
                    chartData.push(others);
                }
            } else {
                chartData = sortedActivity;
            }

            const labels = chartData.map(item => item.buyer);
            const values = chartData.map(item => item.quantity_kg);

            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Market Share (Kg)',
                        data: values,
                        backgroundColor: PIE_COLORS.slice(0, chartData.length),
                        hoverOffset: 4
                    }]
                },
                options: CHART_OPTIONS_PIE
            });
        };

         // NEW: Renderer for Auction Averages Analysis (ITBB/Limbe style)
        const renderAveragesAnalysis = (analysis, meta) => {
            if (!analysis || analysis.length === 0) return;

            document.getElementById('averages-analysis-section').style.display = 'block';
            const table = document.getElementById('averages-analysis-table');
            const thead = table.querySelector('thead');
            const tbody = table.querySelector('tbody');
            tbody.innerHTML = '';

            const currentYear = meta.year;
            const previousYear = currentYear - 1;

            // Determine column names dynamically based on available data keys
            const has2025 = analysis.some(item => item.avg_2025 !== undefined);
            const has2024 = analysis.some(item => item.avg_2024 !== undefined);


            let headerHtml = `<tr><th class="header-main">Period</th>`;
            if (has2025) headerHtml += `<th class="header-main">Avg ${currentYear} (${meta.currency})</th>`;
            if (has2024) headerHtml += `<th class="header-main">Avg ${previousYear} (${meta.currency})</th>`;
            headerHtml += `<th class="header-main">Change (${meta.currency})</th>
                           <th class="header-main">Change (%)</th></tr>`;
            
            thead.innerHTML = headerHtml;

            analysis.forEach(item => {
                let rowHtml = `<tr><td>${item.period}</td>`;
                if (has2025) rowHtml += `<td>${formatCurrency(item.avg_2025)}</td>`;
                if (has2024) rowHtml += `<td>${formatCurrency(item.avg_2024)}</td>`;
                rowHtml += `<td>${formatDiff(item.change_value, 2)}</td>
                            <td>${formatDiff(item.change_percent, 1)}%</td></tr>`;
                
                tbody.innerHTML += rowHtml;
            });
        };


        // [THE REMAINING RENDERER FUNCTIONS ARE INCLUDED BELOW FOR A COMPLETE FILE]

        // Renderer for Multi-Center Auction Offerings (Contemporary Brokers style)
        const renderAuctionOfferingsMultiCenter = (offeringsData, meta) => {
             if (!offeringsData || Object.keys(offeringsData).length === 0) return;

             const section = document.getElementById('auction-offerings-multi-section');
             const container = document.getElementById('auction-offerings-multi-container');
             
             // Prevent re-rendering
             if (section.dataset.processed === "true") return;
             section.style.display = 'block';

             const renderOfferingsTable = (data, title, metric = "Packages") => {
                 if (!data || data.length === 0) return;

                 const wrapper = document.createElement('div');
                wrapper.style.marginBottom = '24px';
                wrapper.innerHTML = `<h4>${title} (${metric})</h4>`;
                
                const tableContainer = document.createElement('div');
                tableContainer.className = 'data-table-container';
                
                const table = document.createElement('table');
                table.className = 'data-table stats-table';
                
                // Header
                table.innerHTML = `
                    <thead>
                        <tr>
                            <th rowspan="2" class="header-main">Type</th>
                            <th colspan="2" class="header-main">This Week</th>
                            <th colspan="2" class="header-main">To Date</th>
                        </tr>
                        <tr>
                            <th class="header-sub">${meta.year}</th>
                            <th class="header-sub">${meta.year-1}</th>
                            <th class="header-sub">${meta.year}</th>
                            <th class="header-sub">${meta.year-1}</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                `;
                
                const tbody = table.querySelector('tbody');
                data.forEach(item => {
                    const row = document.createElement('tr');
                     if (item.type === "Total") {
                        row.style.fontWeight = 'bold';
                        row.style.backgroundColor = '#f1f3f4';
                    }
                    row.innerHTML = `
                        <td>${item.type}</td>
                        <td>${formatNumber(item.current_weekly)}</td>
                        <td>${formatNumber(item.previous_weekly)}</td>
                        <td>${formatNumber(item.current_todate)}</td>
                        <td>${formatNumber(item.previous_todate)}</td>
                    `;
                    tbody.appendChild(row);
                });
                
                tableContainer.appendChild(table);
                wrapper.appendChild(tableContainer);
                container.appendChild(wrapper);
             };

             // Render tables for each center found in the data
             for (const [center, data] of Object.entries(offeringsData)) {
                 renderOfferingsTable(data, center);
             }
             section.dataset.processed = "true";
        };


        // Renderer for Offerings by Grade/Category (Colombo/Mombasa style)
        const renderOfferingsByGrade = (data) => {
            const offerings = data.offerings || data.offerings_by_grade;
            const summary = data.summary;

            if (!offerings || offerings.length === 0) return;

            document.getElementById('offerings-grade-section').style.display = 'block';
            const table = document.getElementById('offerings-grade-table');
            const thead = table.querySelector('thead');
            const tbody = table.querySelector('tbody');
            const tfoot = table.querySelector('tfoot');
            tbody.innerHTML = '';
            tfoot.innerHTML = '';

            const hasLots = offerings.some(item => item.lots !== undefined);
            const hasPackages = offerings.some(item => item.packages !== undefined);
            // Handle both unsold and sold percentages
            const hasUnsold = offerings.some(item => item.percent_unsold !== undefined);
            const hasSold = offerings.some(item => item.percent_sold !== undefined);


            if (hasLots) {
                 document.getElementById('offerings-grade-title').textContent = "Auction Offerings (by Category)";
            } else if (hasPackages) {
                 document.getElementById('offerings-grade-title').textContent = "Auction Offerings (by Grade Type)";
            }

            let headerHtml = '<tr><th>Category</th>';
            if (hasLots) headerHtml += '<th>Lots</th>';
            if (hasPackages) headerHtml += '<th>Packages</th>';
            headerHtml += '<th>Quantity (kg)</th>';
            if (hasUnsold) headerHtml += '<th>Unsold (%)</th>';
            if (hasSold) headerHtml += '<th>Sold (%)</th>';
            headerHtml += '</tr>';
            thead.innerHTML = headerHtml;

            offerings.forEach(item => {
                let rowHtml = `<tr><td>${item.category}</td>`;
                if (hasLots) rowHtml += `<td>${formatNumber(item.lots)}</td>`;
                if (hasPackages) rowHtml += `<td>${formatNumber(item.packages)}</td>`;
                rowHtml += `<td>${formatNumber(item.quantity_kg)}</td>`;
                if (hasUnsold) rowHtml += `<td>${formatNumber(item.percent_unsold, 2)}%</td>`;
                if (hasSold) rowHtml += `<td>${formatNumber(item.percent_sold, 2)}%</td>`;
                rowHtml += '</tr>';
                tbody.innerHTML += rowHtml;
            });

            if (summary) {
                let footCells = [`<td>TOTAL</td>`];
                if (hasLots && summary.total_lots) footCells.push(`<td>${formatNumber(summary.total_lots)}</td>`);
                if (hasPackages && summary.total_packages) footCells.push(`<td>${formatNumber(summary.total_packages)}</td>`);
                
                if (summary.total_quantity_kg) footCells.push(`<td>${formatNumber(summary.total_quantity_kg)}</td>`);
                
                // Use summary level percentages if available for the footer
                if (hasUnsold) {
                    const summaryUnsold = summary.percent_unsold !== undefined ? formatNumber(summary.percent_unsold, 2) + '%' : '';
                    footCells.push(`<td>${summaryUnsold}</td>`);
                }
                 if (hasSold) {
                    const summarySold = summary.percent_sold !== undefined ? formatNumber(summary.percent_sold, 2) + '%' : '';
                    footCells.push(`<td>${summarySold}</td>`);
                }

                 tfoot.innerHTML = `<tr style="font-weight: bold; background-color: #f1f3f4;">${footCells.join('')}</tr>`;

                if (summary.reprints_lots) {
                     // Assuming standard Colombo structure for reprints (Lots, Quantity). Need to ensure column alignment.
                     let reprintHtml = `<tr style="font-style: italic; color: #5f6368;"><td>Re-Prints</td>`;
                     
                     if (hasLots) reprintHtml += `<td>${formatNumber(summary.reprints_lots)}</td>`;
                     if (hasPackages) reprintHtml += `<td>N/A</td>`; // Assuming reprints don't usually list packages separately if lots are present
                     
                     reprintHtml += `<td>${formatNumber(summary.reprints_quantity_kg)}</td>`;

                     if (hasUnsold) {
                        reprintHtml += `<td></td>`;
                     }
                      if (hasSold) {
                        reprintHtml += `<td></td>`;
                     }
                     reprintHtml += `</tr>`;
                     tfoot.innerHTML += reprintHtml;
                }
            }

            // Render Visualization
            document.getElementById('volume-visualization-section').style.display = 'block';
            document.getElementById('offerings-chart-block').style.display = 'block';
            const ctx = document.getElementById('offeringsChart').getContext('2d');
            
            const labels = offerings.map(item => item.category);
            const values = offerings.map(item => item.quantity_kg);

            const options = JSON.parse(JSON.stringify(CHART_OPTIONS_BAR)); 
            options.scales.y.title.text = 'Quantity (kg)';

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Quantity (kg)',
                        data: values,
                        backgroundColor: CHART_COLORS.primary,
                    }]
                },
                options: options
            });
        };

        // Renderer for Offerings by Country (Mombasa style)
        const renderOfferingsByCountry = (countryData, meta) => {
            if (!countryData || Object.keys(countryData).length === 0) return;
            
            document.getElementById('country-breakdown-section').style.display = 'block';
            const container = document.getElementById('country-breakdown-tables');
            container.innerHTML = '';

            const years = Object.keys(countryData).sort((a, b) => b - a);

            years.forEach(year => {
                const data = countryData[year];
                if (!data || data.length === 0) return;

                const wrapper = document.createElement('div');
                wrapper.innerHTML = `<h4>Year ${year}</h4>`;
                
                const tableContainer = document.createElement('div');
                tableContainer.className = 'data-table-container';

                const table = document.createElement('table');
                table.className = 'data-table';
                table.innerHTML = `
                    <thead>
                        <tr>
                            <th>Country</th>
                            <th>Offered (Pkg)</th>
                            <th>Sold (Pkg)</th>
                            <th>Offered (Kg)</th>
                            <th>Sold (Kg)</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                `;
                
                const tbody = table.querySelector('tbody');
                data.forEach(item => {
                    tbody.innerHTML += `
                        <tr>
                            <td>${item.country}</td>
                            <td>${formatNumber(item.offered_packages)}</td>
                            <td>${formatNumber(item.sold_packages)}</td>
                            <td>${formatNumber(item.offered_kg)}</td>
                            <td>${formatNumber(item.sold_kg)}</td>
                        </tr>
                    `;
                });
                
                tableContainer.appendChild(table);
                wrapper.appendChild(tableContainer);
                container.appendChild(wrapper);
            });

            // Render Visualization
            // Ensure meta.year exists before trying to access data[meta.year]
            const currentYearData = meta.year ? countryData[meta.year] : null;
            if (currentYearData) {
                document.getElementById('volume-visualization-section').style.display = 'block';
                document.getElementById('country-chart-block').style.display = 'block';
                const ctx = document.getElementById('countryChart').getContext('2d');

                const labels = currentYearData.map(item => item.country);
                const offeredValues = currentYearData.map(item => item.offered_kg);
                const soldValues = currentYearData.map(item => item.sold_kg);

                const options = JSON.parse(JSON.stringify(CHART_OPTIONS_BAR));
                options.scales.y.title.text = 'Quantity (kg)';
                options.plugins.legend.display = true;

                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Offered (kg)',
                                data: offeredValues,
                                backgroundColor: CHART_COLORS.secondary,
                            },
                            {
                                label: 'Sold (kg)',
                                data: soldValues,
                                backgroundColor: CHART_COLORS.primary,
                            }
                        ]
                    },
                    options: options
                });
            }
        };

        // Renderer for Price Quotations (Colombo/Mombasa/Jakarta style)
        const renderPriceQuotations = (quotations, currency) => {
            if (!quotations || quotations.length === 0) return;

            document.getElementById('prices-section').style.display = 'block';
            document.getElementById('price-quotations-title').textContent = `Price Quotations (${currency}/kg)`;

            const table = document.getElementById('prices-table');
            const thead = table.querySelector('thead');
            const tbody = table.querySelector('tbody');
            tbody.innerHTML = '';

            const hasElevation = quotations.some(item => item.elevation !== undefined);
            const hasCategory = quotations.some(item => item.category !== undefined);
            const hasPrevious = quotations.some(item => item.previous_min !== undefined || item.previous_max !== undefined);
            
            let headerHtml = '<tr>';
            if (hasElevation) headerHtml += '<th>Elevation</th>';
            if (hasCategory) headerHtml += '<th>Category/Region</th>';
            headerHtml += '<th>Grade</th><th>Current (Low-High)</th>';
            if (hasPrevious) headerHtml += '<th>Previous (Low-High)</th>';
            headerHtml += '</tr>';
            thead.innerHTML = headerHtml;

            quotations.forEach(item => {
                let rowHtml = '<tr>';
                if (hasElevation) rowHtml += `<td>${item.elevation}</td>`;
                if (hasCategory) rowHtml += `<td>${item.category}</td>`;
                rowHtml += `<td>${item.grade}</td><td>${formatPriceRange(item.current_min, item.current_max)}</td>`;
                if (hasPrevious) rowHtml += `<td>${formatPriceRange(item.previous_min, item.previous_max)}</td>`;
                rowHtml += '</tr>';
                tbody.innerHTML += rowHtml;
            });
        };
        
        // Renderer for Commentary Grid (Kolkata/Contemporary style)
        const renderCommentaryGrid = (commentary) => {
            if (!commentary || Object.keys(commentary).length === 0) return;

            document.getElementById('commentary-grid-section').style.display = 'block';
            const container = document.getElementById('commentary-container');
            container.innerHTML = '';

            for (const category in commentary) {
                const item = commentary[category];
                // Handle both detailed (market/buying) and simple (just text string) structures
                
                let marketText = null;
                let buyingText = null;

                if (typeof item === 'string') {
                    // Simple structure (e.g., Contemporary Buying Commentary)
                    marketText = item;
                } else if (typeof item === 'object' && item !== null) {
                     // Detailed structure (e.g., J Thomas Commentary)
                    marketText = item.market;
                    buyingText = item.buying;
                }

                if (marketText || buyingText) {
                    const card = document.createElement('div');
                    card.className = 'commentary-card';
                    let contentHtml = `<h4>${category}</h4>`;
                    // If it's the detailed structure, label the sections
                    if (buyingText) {
                        if (marketText) contentHtml += `<p><strong>Market:</strong> ${marketText}</p>`;
                        contentHtml += `<p><strong>Buying:</strong> ${buyingText}</p>`;
                    } else {
                        // Otherwise just display the text
                         contentHtml += `<p>${marketText}</p>`;
                    }
                    
                    card.innerHTML = contentHtml;
                    container.appendChild(card);
                }
            }
        };
         
        // Renderer for Auction Averages Comparison (Kolkata/Contemporary Brokers style)
        const renderAveragesComparison = (comparison, meta) => {
            if (!comparison || comparison.length === 0) return;
            
            document.getElementById('averages-comparison-section').style.display = 'block';
            document.getElementById('averages-title').textContent = `Auction Averages Comparison (${meta.currency}/kg)`;

            const table = document.getElementById('averages-table');
            const thead = table.querySelector('thead');
            const tbody = table.querySelector('tbody');
            tbody.innerHTML = '';

            // Detect format: Kolkata (J Thomas) vs Contemporary Brokers
            // Assuming 'current_sale_avg_25_26' is specific to the J Thomas format based on previous context
            const isJThomasFormat = comparison.some(item => item.hasOwnProperty('current_sale_avg_25_26'));
            
            if (isJThomasFormat) {
                // J Thomas Format (Multi-level Header)
                // Assuming 2025/26 structure based on previous context
                if (!meta.sale_number) return; // This format requires a sale number

                thead.innerHTML = `
                    <thead>
                        <tr>
                            <th rowspan="2" class="header-main">Category</th>
                            <th colspan="3" class="header-main">Current Sale (2025/26)</th>
                            <th colspan="3" class="header-main">To Date Averages</th>
                        </tr>
                        <tr>
                            <th class="header-sub">Avg (S${meta.sale_number})</th>
                            <th class="header-sub">Avg (S${meta.sale_number - 1})</th>
                            <th class="header-sub">+/-</th>
                            <th class="header-sub">2025/26</th>
                            <th class="header-sub">2024/25</th>
                            <th class="header-sub">2023/24</th>
                        </tr>
                    </thead>
                `;

                comparison.forEach(item => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${item.category}</td>
                        <td>${formatCurrency(item.current_sale_avg_25_26)}</td>
                        <td>${formatCurrency(item.previous_sale_avg_25_26)}</td>
                        <td>${formatDiff(item.diff_25_26)}</td>
                        <td>${formatCurrency(item.ytd_avg_25_26)}</td>
                        <td>${formatCurrency(item.ytd_avg_24_25)}</td>
                        <td>${formatCurrency(item.ytd_avg_23_24)}</td>
                    `;
                    tbody.appendChild(row);
                });
            } else {
                // Contemporary Brokers Format (Simple comparison across centers)
                 thead.innerHTML = `
                    <thead>
                        <tr>
                            <th class="header-main">Centre</th>
                            <th class="header-main">Type</th>
                            <th class="header-main">Current Avg (${meta.year})</th>
                            <th class="header-main">Previous Avg (${meta.year-1})</th>
                            <th class="header-main">Difference</th>
                        </tr>
                    </thead>
                `;

                comparison.forEach(item => {
                    const row = document.createElement('tr');
                     if (item.type === "ALL") {
                        row.style.fontWeight = 'bold';
                        row.style.backgroundColor = '#f8f9fa';
                    }
                    row.innerHTML = `
                        <td>${item.centre}</td>
                        <td>${item.type}</td>
                        <td>${formatCurrency(item.current_avg)}</td>
                        <td>${formatCurrency(item.previous_avg)}</td>
                        <td>${formatDiff(item.difference)}</td>
                    `;
                    tbody.appendChild(row);
                });
            }
        };

         // Renderer for Price Distribution (Kolkata/Contemporary style)
        const renderPriceDistribution = (distribution, meta) => {
            if (!distribution || Object.keys(distribution).length === 0) return;

            document.getElementById('price-distribution-section').style.display = 'block';
            const container = document.getElementById('distribution-container');
            container.innerHTML = '';

            // Determine format
            const firstCategory = Object.values(distribution)[0];
            const firstDataPoint = firstCategory ? Object.values(firstCategory)[0] : {};

            // Assuming 'YTD_25_26' is the key for the current YTD based on context.
            const isJThomasFormat = meta.sale_number && firstDataPoint.hasOwnProperty(`Sale_${meta.sale_number}`) && !firstDataPoint.hasOwnProperty('YTD_25_26');
            const isContemporaryFormat = firstDataPoint.hasOwnProperty('YTD_25_26'); 


            if (isJThomasFormat) {
                 // J Thomas Format
                document.getElementById('price-distribution-title').textContent = `Price Distribution Analysis (% Sold) - Sale ${meta.sale_number}`;
            } else if (isContemporaryFormat) {
                // Contemporary Format
                 document.getElementById('price-distribution-title').textContent = `Price Distribution Analysis (% Sold) - Week ${meta.week_number} vs YTD`;
            }
           

            for (const [category, ranges] of Object.entries(distribution)) {
                 if (!ranges || Object.keys(ranges).length === 0) continue;

                const chartWrapper = document.createElement('div');
                chartWrapper.className = 'distribution-block';

                const canvasId = `chart-${category.replace(/[^a-zA-Z0-9]/g, '-')}`;
                // Adjust height slightly if it's a multi-bar chart for better readability
                const chartHeight = (isContemporaryFormat) ? 280 : 250;
                chartWrapper.innerHTML = `<h4>${category.replace(/_/g, ' ')}</h4><div style="position: relative; height: ${chartHeight}px;"><canvas id="${canvasId}"></canvas></div>`;
                container.appendChild(chartWrapper);

                const ctx = document.getElementById(canvasId).getContext('2d');
                const labels = Object.keys(ranges);
                
                const datasets = [];

                if (isJThomasFormat) {
                    // J Thomas (Single Bar)
                    const currentSaleKey = `Sale_${meta.sale_number}`;
                    const values = Object.values(ranges).map(r => r[currentSaleKey]);
                    datasets.push({
                        label: `Sale ${meta.sale_number}`,
                        data: values,
                        backgroundColor: CHART_COLORS.primary,
                    });
                } else if (isContemporaryFormat) {
                    // Contemporary (Grouped Bar)
                    const currentWeekKey = `Sale_${meta.week_number}`;
                    const currentYTDKey = 'YTD_25_26';
                    const previousYTDKey = 'YTD_24_25';

                    const currentWeekValues = Object.values(ranges).map(r => r[currentWeekKey]);
                    const currentYTDValues = Object.values(ranges).map(r => r[currentYTDKey]);
                    const previousYTDValues = Object.values(ranges).map(r => r[previousYTDKey]);


                    datasets.push({
                        label: `YTD ${meta.year-1}`,
                        data: previousYTDValues,
                        backgroundColor: CHART_COLORS.neutral,
                    });
                     datasets.push({
                        label: `YTD ${meta.year}`,
                        data: currentYTDValues,
                        backgroundColor: CHART_COLORS.secondary,
                    });
                    datasets.push({
                        label: `Week ${meta.week_number}`,
                        data: currentWeekValues,
                        backgroundColor: CHART_COLORS.primary,
                    });
                   
                }

                // Use the reusable options and customize
                const options = JSON.parse(JSON.stringify(CHART_OPTIONS_BAR));
                options.scales.y.title.text = 'Percentage (%)';
                // Show legend if there are multiple datasets (grouped bar)
                if (datasets.length > 1) {
                    options.plugins.legend.display = true;
                }

                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: datasets
                    },
                    options: options
                });
            }
        };

        // Renderer for Detailed Offer/Sold Statistics (Kolkata style)
        const renderDetailedStatistics = (statistics, meta) => {
            if (!statistics || Object.keys(statistics).length === 0) return;
            if (!meta.sale_number) return; // Requires sale number for headers

            const section = document.getElementById('detailed-stats-section');
            section.style.display = 'block';

             const renderDetailTable = (details, title) => {
                if (!details || details.length === 0) return;

                const wrapper = document.createElement('div');
                wrapper.style.marginBottom = '24px';
                wrapper.innerHTML = `<h4>${title} Details</h4>`;
                
                const tableContainer = document.createElement('div');
                tableContainer.className = 'data-table-container';
                
                const table = document.createElement('table');
                table.className = 'data-table stats-table';
                
                // Complex Multi-level Header
                table.innerHTML = `
                    <thead>
                        <tr>
                            <th rowspan="2" class="header-main">Grade</th>
                            <th colspan="4" class="header-main" style="text-align: center; border-left: 2px solid #dadce0;">This Sale (S${meta.sale_number})</th>
                            <th colspan="4" class="header-main" style="text-align: center; border-left: 2px solid #dadce0;">Last Sale (S${meta.sale_number-1})</th>
                            <th colspan="4" class="header-main" style="text-align: center; border-left: 2px solid #dadce0;">To Date</th>
                        </tr>
                        <tr>
                            <th class="header-sub" style="border-left: 2px solid #dadce0;">Offered (kg)</th><th class="header-sub">Sold (kg)</th><th class="header-sub">Avg (${meta.currency})</th><th class="header-sub">Out %</th>
                            <th class="header-sub" style="border-left: 2px solid #dadce0;">Offered (kg)</th><th class="header-sub">Sold (kg)</th><th class="header-sub">Avg (${meta.currency})</th><th class="header-sub">Out %</th>
                            <th class="header-sub" style="border-left: 2px solid #dadce0;">Offered (kg)</th><th class="header-sub">Sold (kg)</th><th class="header-sub">Avg (${meta.currency})</th><th class="header-sub">Out %</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                `;
                
                const tbody = table.querySelector('tbody');
                details.forEach(item => {
                    const row = document.createElement('tr');
                    if (item.Grade.includes("TOTAL")) {
                        row.style.fontWeight = 'bold';
                        row.style.backgroundColor = '#f1f3f4';
                    }
                    row.innerHTML = `
                        <td>${item.Grade}</td>
                        <td style="border-left: 2px solid #dadce0;">${formatNumber(item.This_Sale.Offered)}</td>
                        <td>${formatNumber(item.This_Sale.Sold)}</td>
                        <td>${formatCurrency(item.This_Sale.Average)}</td>
                        <td>${formatNumber(item.This_Sale.Out_Percent)}%</td>
                        <td style="border-left: 2px solid #dadce0;">${formatNumber(item.Last_Sale.Offered)}</td>
                        <td>${formatNumber(item.Last_Sale.Sold)}</td>
                        <td>${formatCurrency(item.Last_Sale.Average)}</td>
                        <td>${formatNumber(item.Last_Sale.Out_Percent)}%</td>
                        <td style="border-left: 2px solid #dadce0;">${formatNumber(item.To_Date.Offered)}</td>
                        <td>${formatNumber(item.To_Date.Sold)}</td>
                        <td>${formatCurrency(item.To_Date.Average)}</td>
                        <td>${formatNumber(item.To_Date.Out_Percent)}%</td>
                    `;
                    tbody.appendChild(row);
                });
                
                tableContainer.appendChild(table);
                wrapper.appendChild(tableContainer);
                section.appendChild(wrapper);
            };

            if (statistics.CTC_Dust) renderDetailTable(statistics.CTC_Dust, "CTC & Dust");
            if (statistics.Orthodox) renderDetailTable(statistics.Orthodox, "Orthodox");
            if (statistics.Darjeeling) renderDetailTable(statistics.Darjeeling, "Darjeeling");
        };
        
        // Renderer for Quantity Sold Comparison (Asia Siyaka style)
        const renderQuantityComparison = (comparison, meta) => {
             if (!comparison || comparison.length === 0) return;

            document.getElementById('quantity-comparison-section').style.display = 'block';
            const table = document.getElementById('quantity-comparison-table');
            const thead = table.querySelector('thead');
            const tbody = table.querySelector('tbody');
            tbody.innerHTML = '';

            // Header (Assumes Current Year vs Previous Year)
            const currentYear = meta.year;
            const previousYear = currentYear - 1;

            thead.innerHTML = `
                <thead>
                    <tr>
                        <th rowspan="2" class="header-main">Category</th>
                        <th colspan="2" class="header-main">${currentYear}</th>
                        <th colspan="2" class="header-main">${previousYear}</th>
                    </tr>
                    <tr>
                        <th class="header-sub">Weekly</th>
                        <th class="header-sub">To Date</th>
                        <th class="header-sub">Weekly</th>
                        <th class="header-sub">To Date</th>
                    </tr>
                </thead>
            `;

            comparison.forEach(item => {
                const row = document.createElement('tr');
                 if (item.category.includes("Total")) {
                        row.style.fontWeight = 'bold';
                        row.style.backgroundColor = '#f1f3f4';
                    }
                row.innerHTML = `
                    <td>${item.category}</td>
                    <td>${formatNumber(item.weekly_current_year)}</td>
                    <td>${formatNumber(item.todate_current_year)}</td>
                    <td>${formatNumber(item.weekly_previous_year)}</td>
                    <td>${formatNumber(item.todate_previous_year)}</td>
                `;
                tbody.appendChild(row);
            });
        };

         // Renderer for International Summaries (Specific to Colombo)
        const renderInternationalSummaries = (summaries) => {
             const section = document.getElementById('international-section');
             const container = document.getElementById('international-container');

            if (!summaries || summaries.length === 0) return;
            
            section.style.display = 'block';
            container.innerHTML = '';

             summaries.forEach(summary => {
                    const summaryDiv = document.createElement('div');
                    summaryDiv.className = 'international-summary-item';

                    let contentHtml = `<h4>${summary.centre} (Sale ${summary.sale_no || 'N/A'})</h4>
                                       <p style="font-size: 13px; color: #5f6368;">${summary.date || ''}</p>
                                       <p>${summary.summary || 'Summary not available.'}</p>`;
                    
                    if (summary.structured_data && summary.structured_data.currency) {
                        contentHtml += `<p><strong>Quotations (${summary.structured_data.currency}):</strong></p>`;
                        
                        const renderTable = (grades, title) => {
                            if (!grades || grades.length === 0) return '';
                            let tableHtml = `<div class="data-table-container" style="margin-bottom: 16px; max-width: 500px;">
                                             <p style="font-weight: 500; margin-bottom: 8px;">${title}</p>
                                             <table class="data-table">
                                             <thead><tr><th>Category</th><th>Grade</th><th>Low</th><th>High</th></tr></thead><tbody>`;
                            grades.forEach(grade => {
                                tableHtml += `<tr>
                                                <td>${grade.category}</td>
                                                <td>${grade.grade}</td>
                                                <td>${formatNumber(grade.low, 2)}</td>
                                                <td>${formatNumber(grade.high, 2)}</td>
                                              </tr>`;
                            });
                            tableHtml += `</tbody></table></div>`;
                            return tableHtml;
                        };

                        contentHtml += renderTable(summary.structured_data.ctc_leaf_grades, "CTC Leaf");
                        contentHtml += renderTable(summary.structured_data.ctc_dust_grades, "CTC Dust");
                    }

                    summaryDiv.innerHTML = contentHtml;
                    container.appendChild(summaryDiv);
                });
        };


        // Main Report Rendering Logic (Orchestration)
        const renderReport = (data) => {
            const meta = data.metadata;

            // 1. Metadata and Title
            // Use specific report title if available (e.g., Contemporary), otherwise generate standard title
            const titlePrefix = meta.report_title || `${meta.auction_centre || meta.region} Auction Report`;
            document.getElementById('report-title').textContent = `${titlePrefix} - Week ${meta.week_number} (${meta.year})`;
            
            let metaText = `Broker: ${meta.broker}`;
            if (meta.sale_number) metaText += ` | Sale No: ${meta.sale_number}`;
            
            // Determine the best date representation
            const startDate = meta.sale_date_start;
            const endDate = meta.sale_date_end || meta.date_end;

            if (startDate && endDate && startDate !== endDate) {
                metaText += ` | Dates: ${startDate} to ${endDate}`;
            } else if (endDate) {
                 metaText += ` | Date: ${endDate}`;
            }

            if (meta.currency) {
                metaText += ` | Currency: ${meta.currency}`;
            }
            // Add exchange rate if present (Jakarta)
            if (meta.exchange_rate_note) {
                 metaText += ` | Exchange Rate: ${meta.exchange_rate_note}`;
            }
            document.getElementById('report-meta').textContent = metaText;

            // 2. Global Statistics (e.g., Contemporary World Crop)
            renderGlobalStatistics(data.global_statistics, meta);

            // 3. Commentary and Summary
            if (data.commentary) {
                renderCommentaryGrid(data.commentary);
            } 
            // Only render general summary if commentary grid is not present, or if specific summary fields exist
            if (data.summary) {
                 renderGeneralSummary(data.summary);
            }

            // 4. Buyer Activity (e.g., Jakarta)
            renderBuyerActivity(data.buyer_activity, data.summary);

            // 5. Offerings and Volume Analysis
            renderOfferingsByGrade(data);
            renderOfferingsByCountry(data.offerings_by_country, meta);
           

            // 6. Prices and Statistics
            renderPriceQuotations(data.price_quotations, meta.currency);
            
            // Handle statistical summaries
            if (data.statistical_summaries) {
                const stats = data.statistical_summaries;
                renderAveragesComparison(stats.auction_averages_comparison, meta);
                renderPriceDistribution(stats.price_distribution_analysis, meta);
                renderDetailedStatistics(stats.offer_sold_statistics, meta);
                renderQuantityComparison(stats.quantity_sold_comparison, meta);
                renderAuctionOfferingsMultiCenter(stats.auction_offerings_packages, meta);
                
                // NEW: Handle Averages Analysis (ITBB/Limbe)
                renderAveragesAnalysis(stats.auction_averages_analysis, meta);
            }
            
            // 7. International Summaries
            renderInternationalSummaries(data.international_summaries);
        };

        // --- Data Loading ---
        document.addEventListener('DOMContentLoaded', async () => {
            // Initialize mobile menu toggle
             if (typeof initializeMobileMenu === 'function') {
                initializeMobileMenu();
            }
            
            const params = new URLSearchParams(window.location.search);
            const datasetFile = params.get('dataset');
            
            if (!datasetFile) {
                document.getElementById('report-title').textContent = 'Error: No report selected.';
                document.getElementById('loading-indicator').style.display = 'none';
                return;
            }

            try {
                const response = await fetch(`Data/Market_Reports/${datasetFile}.json`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const reportData = await response.json();
                
                // Orchestrate the rendering
                renderReport(reportData);
                
                document.getElementById('loading-indicator').style.display = 'none';
                document.getElementById('report-content').style.display = 'block';

            } catch (error) {
                console.error('Error fetching report data:', error);
                document.getElementById('report-title').textContent = 'Error loading report.';
                document.getElementById('loading-indicator').textContent = `Could not load the dataset: ${datasetFile}.json. Error: ${error.message}`;
            }
        });
    </script>
</body>
</html>