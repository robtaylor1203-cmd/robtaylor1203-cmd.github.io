<script>
        // All of your original helper functions for rendering are still needed
        // I am including a few of them here for completeness.
        // In your actual file, ALL of your original render... and format... functions should be here.

        const formatNumber = (num, decimals = 0) => {
            if (num === null || num === undefined || isNaN(num)) return 'N/A';
            return num.toLocaleString(undefined, { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
        };
        const formatCurrency = (num, currency = 'USD') => {
             if (num === null || num === undefined || isNaN(num)) return 'N/A';
             const decimals = (currency === 'USD' || currency === 'USc') ? 2 : 0;
             return formatNumber(num, decimals);
        };
        const formatPriceRange = (min, max, currency = 'USD') => {
             if ((min === null || min === undefined) && (max === null || max === undefined)) return 'N/A';
             if (max === null || max === undefined) return formatCurrency(min, currency);
             if (min === null || min === undefined) return formatCurrency(max, currency);
             return `${formatCurrency(min, currency)} - ${formatCurrency(max, currency)}`;
        };

        const renderPriceQuotations = (quotations, currency) => {
            const section = document.getElementById('price-quotations-section');
            if (!quotations || quotations.length === 0 || !section) return;
            section.style.display = 'block';
            
            const table = section.querySelector('table');
            const tbody = table.querySelector('tbody');
            const thead = table.querySelector('thead');
            tbody.innerHTML = '<thead><tr><th>Lot No</th><th>Garden</th><th>Grade</th><th>Invoice</th><th>Packages</th><th>Price</th></tr></thead>';
            
            quotations.forEach(item => {
                let rowHtml = '<tr>';
                rowHtml += `<td>${item.lot_no || 'N/A'}</td>`;
                rowHtml += `<td>${item.garden || 'N/A'}</td>`;
                rowHtml += `<td>${item.grade || 'N/A'}</td>`;
                rowHtml += `<td>${item.invoice || 'N/A'}</td>`;
                rowHtml += `<td>${item.packages || 'N/A'}</td>`;
                rowHtml += `<td>${item.price || 'N/A'}</td>`;
                rowHtml += '</tr>';
                tbody.innerHTML += rowHtml;
            });
        };

        const renderOverview = (summary, meta) => {
            const section = document.getElementById('overview-section');
            if (!summary || !section) return;
            section.style.display = 'block';

            const statsContainer = document.getElementById('summary-stats');
            statsContainer.innerHTML = '';
             const stats = [
                { label: 'Total Lots', value: summary.total_lots, format: 0 },
                { label: 'Lots Sold', value: summary.lots_sold, format: 0 },
                { label: 'Top Buyer', value: summary.top_buyer }
            ];
            stats.forEach(stat => {
                if (stat.value !== undefined && stat.value !== null) {
                    const card = document.createElement('div');
                    card.className = 'stat-card';
                    card.innerHTML = `<span class="stat-value">${stat.value}</span><span class="stat-label">${stat.label}</span>`;
                    statsContainer.appendChild(card);
                }
            });
            document.getElementById('market-comment').textContent = summary.notes || 'Commentary not available.';
        };

        // --- THE FINAL DATA LOADING LOGIC ---
        document.addEventListener('DOMContentLoaded', async () => {
            const loadingIndicator = document.getElementById('loading-indicator');
            const reportTitleEl = document.getElementById('report-title');
            const reportContentEl = document.getElementById('report-content');
            
            try {
                const params = new URLSearchParams(window.location.search);
                const reportTitleToFind = params.get('title');

                if (!reportTitleToFind) throw new Error("No report title specified in URL.");

                const response = await fetch('market-reports-library.json');
                if (!response.ok) throw new Error(`Could not load library. Status: ${response.status}`);
                const library = await response.json();

                let foundReport = null;
                for (const location in library) {
                    if (library[location][reportTitleToFind]) {
                        foundReport = library[location][reportTitleToFind];
                        break;
                    }
                }

                if (!foundReport) throw new Error(`Could not find report "${reportTitleToFind}" in library.`);
                
                // --- THIS IS THE KEY ---
                // We now call your rendering functions with the data we found
                
                reportTitleEl.textContent = foundReport.title;
                document.getElementById('report-meta').textContent = foundReport.description;

                const reportData = foundReport.data; // This holds the different "slices of the pie"
                const metaData = foundReport;

                // Call the render functions based on the data available in this report
                if (reportData.buyer_summary && typeof renderOverview === 'function') {
                    renderOverview(reportData.buyer_summary, metaData);
                }
                if (reportData.auction_prices_S37 && typeof renderPriceQuotations === 'function') {
                     // The key name is based on the filename, e.g., 'auction_prices_S37'
                    renderPriceQuotations(reportData.auction_prices_S37, metaData.currency);
                }
                // Add more 'if' blocks here for your other render functions as you add more scrapers
                
                reportContentEl.style.display = 'block';
                loadingIndicator.style.display = 'none';

            } catch (error) {
                console.error('Error loading report:', error);
                reportTitleEl.textContent = 'Error loading report.';
                loadingIndicator.textContent = `Error: ${error.message}`;
            }
        });
    </script>
