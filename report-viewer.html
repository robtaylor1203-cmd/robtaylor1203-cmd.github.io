<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market Report Viewer - TeaTrade</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="market-reports-page">
    <header class="site-header">
        <div class="header-top-bar">
            <a href="corporate.html" class="header-logo"><h1>Tea<span>Trade</span></h1></a>
            <div class="header-search-wrapper"><input type="text" class="header-search-bar" placeholder="Global site search..."></div>
            <div class="user-actions">
                <a href="#" title="Create Account"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><line x1="20" y1="8" x2="20" y2="14"></line><line x1="17" y1="11" x2="23" y2="11"></line></svg></a>
                <a href="#" title="Sign In"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path><polyline points="10 17 15 12 10 7"></polyline><line x1="15" y1="12" x2="3" y2="12"></line></svg></a>
            </div>
            <button class="mobile-menu-toggle" aria-label="Toggle navigation" aria-expanded="false">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
            </button>
        </div>
        <nav class="secondary-nav">
            <ul>
                <li><a href="data.html">Data</a></li>
                <li><a href="market-reports.html" class="active">Market Reports</a></li>
                <li><a href="#">Auctions</a></li>
                <li><a href="visuals.html">Visuals</a></li>
            </ul>
        </nav>
    </header>

    <main class="page-container">
        <div class="dashboard-header">
            <h2 class="page-title" id="report-title">Loading Report...</h2>
        </div>
        <p id="report-meta" class="report-meta"></p>

        <div id="report-content" style="display: none;">
            
            <section class="report-section" id="commentary-section" style="display: none;">
                <h3>Market Commentary</h3>
                <p id="synthesized-commentary"></p>
            </section>

            <section class="report-section" id="drivers-forecast-section" style="display: none;">
                <h3 id="drivers-forecast-title">Market Forecast & Drivers</h3>
                <div class="analysis-grid" id="drivers-forecast-container">
                    </div>
            </section>

            <section class="report-section" id="supply-offerings-section" style="display: none;">
                <h3 id="supply-offerings-title">Supply & Offerings Analysis</h3>
                <div class="analysis-text">
                     <p id="supply-offerings-analysis-text"></p>
                </div>
                <div class="data-table-container" id="offerings-wow-table-container" style="display: none; max-width: 700px; margin-top: 16px;">
                    <table class="data-table stats-table" id="offerings-wow-table">
                        <thead>
                            <tr>
                                <th>Metric</th>
                                <th>Current Week</th>
                                <th>Previous Week</th>
                                <th>WoW Change</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </section>

            <section class="report-section" id="demand-price-section" style="display: none;">
                <h3 id="demand-price-title">Demand & Price Analysis</h3>
                <div class="analysis-grid" id="price-analysis-grid-container">
                </div>
                <div class="analysis-text" id="demand-analysis-text-container">
                </div>
            </section>

            <section class="report-section" id="visualizations-section" style="display: none;">
                <h3>Market Visualizations</h3>
                <div class="visualizations-grid" id="visualizations-container">
                </div>
            </section>

            <section class="report-section" id="production-analysis-section" style="display: none;">
                <h3>Production Analysis Summary</h3>
                 <div class="analysis-layout">
                    <div class="analysis-text" style="flex: 1;">
                        <p id="production-analysis-text"></p>
                    </div>
                    <div class="analysis-visual" style="flex: 0 0 350px;">
                         <div class="data-table-container">
                            <table class="data-table stats-table" id="production-table">
                                <thead>
                                    <tr>
                                        <th>Period</th>
                                        <th>Total (M/Kgs)</th>
                                        <th>YoY Change (M/Kgs)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <section class="report-section" id="statistical-summaries-section" style="display: none;">
                <h3>Detailed Statistics</h3>
                <div id="statistical-summaries-container">
                    </div>
            </section>

            <section class="report-section" id="prices-section" style="display: none;">
                <h3 id="price-quotations-title">Price Quotations</h3>
                <div class="data-table-container" id="prices-container">
                     </div>
            </section>

        </div>
        <div id="loading-indicator">Loading data...</div>
    </main>
    <script src="script.js"></script>
    
    <script>
        // --- Configuration ---
        const CHART_COLORS = {
            // Using distinct colors suitable for both line and bar charts
            primary: '#1a73e8',
            secondary: 'rgba(128, 178, 247, 0.9)',
            accent1: '#fbbc05',
            accent2: '#34a853',
            neutral: 'rgba(160, 160, 160, 0.9)',
            dark: 'rgba(32, 33, 36, 0.9)'
        };

         const BAR_CHART_OPTIONS = {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: { display: true, text: 'Volume (M/Kgs)' }
                },
                x: {
                    ticks: { autoSkip: false, maxRotation: 45, minRotation: 0 }
                }
            },
            plugins: { legend: { display: true, position: 'top' } }
        };

        // --- Utility Functions (Robust) ---
        // Robust number formatting
        const formatNumber = (num, decimals = 0) => {
            const parsed = parseFloat(num);
            if (isNaN(parsed)) return 'N/A';
            return parsed.toLocaleString(undefined, { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
        };

        // Robust price range formatting
        const formatPriceRange = (min, max) => {
             const numMin = parseFloat(min);
             const numMax = parseFloat(max);

             if (isNaN(numMin) && isNaN(numMax)) return 'N/A';
             if (isNaN(numMax)) return formatNumber(numMin, 2);
             if (isNaN(numMin)) return formatNumber(numMax, 2);
             return `${formatNumber(numMin, 2)} - ${formatNumber(numMax, 2)}`;
        }

        // Robust differential formatting
        const formatDiff = (num, decimals = 2, forceSign = false) => {
            const parsed = parseFloat(num);
            if (isNaN(parsed) || parsed === 0) return `<span class="diff-neutral">-</span>`;
            
            const formatted = formatNumber(Math.abs(parsed), decimals);
            const className = parsed > 0 ? 'diff-positive' : 'diff-negative';
            const arrow = parsed > 0 ? '▲' : '▼';
            const sign = forceSign ? (parsed > 0 ? '+' : '-') : '';
            
            return `<span class="${className}">${arrow} ${sign}${formatted}</span>`;
        }

        // Robust average calculation
        const calculateAverage = (min, max) => {
             const numMin = parseFloat(min);
             const numMax = parseFloat(max);
            if (isNaN(numMin) || isNaN(numMax)) return null;
            return (numMin + numMax) / 2;
        }
        
        // Helper to safely get elevation name (handles case differences)
        const getElevationName = (item) => (item && (item.elevation || item.Elevation)) || 'N/A';


        // --- Universal Rendering Functions ---

        // 1. Render Synthesized Commentary
        const renderCommentary = (summary) => {
            if (summary && typeof summary.commentary_synthesized === 'string') {
                document.getElementById('commentary-section').style.display = 'block';
                document.getElementById('synthesized-commentary').textContent = summary.commentary_synthesized;
            }
        };

        // 2. Render Forecast and Drivers (Universal)
        const renderUnifiedForecastAndDrivers = (data) => {
            // Defensively check for existence and array type
            const forecastData = Array.isArray(data.forecast_analysis) ? data.forecast_analysis : [];
            const driversData = Array.isArray(data.market_drivers) ? data.market_drivers : [];

            if (forecastData.length === 0 && driversData.length === 0) {
                return;
            }

            const section = document.getElementById('drivers-forecast-section');
            section.style.display = 'block';
            const container = document.getElementById('drivers-forecast-container');
            container.innerHTML = '';

            const renderCard = (item) => {
                if (!item) return;

                const card = document.createElement('div');
                card.className = 'analysis-card';
                
                let sentimentHtml = '';
                if (item.sentiment) {
                    let sentimentClass = '';
                    if (item.sentiment.includes("Bullish")) sentimentClass = 'sentiment-bullish';
                    if (item.sentiment.includes("Negative") || item.sentiment.includes("Bearish")) sentimentClass = 'sentiment-negative';
                    sentimentHtml = `<p class="sentiment ${sentimentClass}">${item.sentiment}</p>`;
                }

                const title = item.driver || item.factor || 'N/A';
                
                let analysis = '';
                if (item.impact) {
                    // Mombasa style
                    analysis = `<strong>Impact:</strong> ${item.impact}`;
                } else {
                    // Colombo style
                    if (item.outlook) {
                        analysis += `<strong>Outlook:</strong> ${item.outlook}<br>`;
                    }
                    if (item.analysis) {
                        analysis += `<strong>Analysis:</strong> ${item.analysis}`;
                    }
                }

                card.innerHTML = `
                    <h4>${title}</h4>
                    ${sentimentHtml}
                    <p>${analysis}</p>
                `;
                container.appendChild(card);
            };

            // Render whichever data source is present
            if (forecastData.length > 0) {
                forecastData.forEach(renderCard);
            } else if (driversData.length > 0) {
                driversData.forEach(renderCard);
            }
        };

        // 3. Render Supply & Offerings Analysis (Universal)
        const renderUnifiedSupplyAnalysis = (data) => {
            const offeringsData = data.offerings_analysis;
            const supplyData = data.supply_analysis;

            if (!offeringsData && !supplyData) {
                return;
            }

            const section = document.getElementById('supply-offerings-section');
            section.style.display = 'block';
            const analysisTextElement = document.getElementById('supply-offerings-analysis-text');
            analysisTextElement.innerHTML = '';

            let analysisText = '';
            if (offeringsData && offeringsData.analysis) {
                analysisText = offeringsData.analysis;
            } else if (supplyData && supplyData.analysis) {
                analysisText = supplyData.analysis;
            }
            
            // Add detailed breakdown if available (Mombasa style)
            if (supplyData && Array.isArray(supplyData.details) && supplyData.details.length > 0) {
                analysisText += '<br><br><strong>Details:</strong><ul>';
                supplyData.details.forEach(detail => {
                    if (detail) analysisText += `<li>${detail}</li>`;
                });
                analysisText += '</ul>';
            }
            
            analysisTextElement.innerHTML = analysisText;

            // Render WoW Table if data exists (Standardized style)
            if (offeringsData && offeringsData.current_week_kg !== undefined) {
                document.getElementById('offerings-wow-table-container').style.display = 'block';
                const tableBody = document.querySelector('#offerings-wow-table tbody');
                tableBody.innerHTML = `
                    <tr>
                        <td>Total Quantity (Kg)</td>
                        <td>${formatNumber(offeringsData.current_week_kg)}</td>
                        <td>${formatNumber(offeringsData.previous_week_kg)}</td>
                        <td>${formatDiff(offeringsData.wow_change_kg, 0)} (${formatDiff(offeringsData.wow_change_percent, 2)}%)</td>
                    </tr>
                `;
            }
        };

        // 4. Render Demand & Price Analysis (Universal)
        const renderUnifiedDemandAndPriceAnalysis = (data) => {
            const priceData = data.price_analysis;
            const demandData = data.demand_analysis;

            if (!priceData && !demandData) {
                return;
            }

            const section = document.getElementById('demand-price-section');
            section.style.display = 'block';
            const gridContainer = document.getElementById('price-analysis-grid-container');
            const textContainer = document.getElementById('demand-analysis-text-container');
            gridContainer.innerHTML = '';
            textContainer.innerHTML = '';

            // Render Grid-based analysis (Colombo style)
            if (priceData) {
                const analysisPoints = [
                    { title: "High Grown", text: priceData.analysis_high_grown },
                    { title: "Medium Grown", text: priceData.analysis_medium_grown },
                    { title: "Low Grown", text: priceData.analysis_low_grown },
                    { title: "CTC", text: priceData.analysis_ctc }
                ];

                analysisPoints.forEach(item => {
                    if (item.text) {
                        const card = document.createElement('div');
                        card.className = 'analysis-card';
                        card.innerHTML = `
                            <h4>${item.title}</h4>
                            <p>${item.text}</p>
                        `;
                        gridContainer.appendChild(card);
                    }
                });
            }

            // Render Narrative-based analysis (Mombasa style)
            if (demandData && demandData.analysis) {
                let analysisText = `<p>${demandData.analysis}</p>`;
                
                if (Array.isArray(demandData.details) && demandData.details.length > 0) {
                    analysisText += '<br><strong>Details:</strong><ul>';
                    demandData.details.forEach(detail => {
                         if (detail) analysisText += `<li>${detail}</li>`;
                    });
                    analysisText += '</ul>';
                }
                textContainer.innerHTML = analysisText;
            }
        };

        // 5. Render Visualizations (Line Charts - Mombasa Gold Standard)
        const renderVisualizations = (vizData) => {
            // Ensure vizData is a valid array
            if (!vizData || !Array.isArray(vizData) || vizData.length === 0) {
                return;
            }

            const section = document.getElementById('visualizations-section');
            section.style.display = 'block';
            const container = document.getElementById('visualizations-container');
            container.innerHTML = '';

            vizData.forEach((viz, index) => {
                // Defensive checks for required visualization properties
                if (!viz || !viz.data || !viz.labels) return;

                const wrapper = document.createElement('div');
                wrapper.className = 'visualization-block';
                const canvasId = `vizChart-${index}`;
                wrapper.innerHTML = `
                    <h4>${viz.title || 'Visualization'}</h4>
                    <div class="chart-container-line">
                        <canvas id="${canvasId}"></canvas>
                    </div>
                `;
                container.appendChild(wrapper);

                const ctx = document.getElementById(canvasId).getContext('2d');
                
                const datasets = viz.data.map((series, i) => {
                    const colors = [CHART_COLORS.primary, CHART_COLORS.accent2, CHART_COLORS.accent1, CHART_COLORS.neutral];
                    const color = colors[i % colors.length];
                    return {
                        label: series.label || 'Series ' + (i+1),
                        data: series.values || [],
                        borderColor: color,
                        backgroundColor: color, // Solid color for points/legend
                        tension: 0.1,
                        fill: false
                    };
                });

                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: viz.labels,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                title: {
                                    display: true,
                                    text: viz.y_axis_label || 'Value'
                                }
                            }
                        }
                    }
                });
            });
        };


        // 6. Render Production Analysis (Summary Table)
        const renderProductionAnalysis = (prodData) => {
            if (!prodData || !prodData.analysis) {
                return;
            }
            
            document.getElementById('production-analysis-section').style.display = 'block';

            // Text Analysis
            document.getElementById('production-analysis-text').textContent = prodData.analysis;

            // Table
            const tableBody = document.querySelector('#production-table tbody');
            // Clear previous content defensively
            tableBody.innerHTML = ''; 

            if (prodData.monthly_total !== undefined) {
                tableBody.innerHTML += `
                    <tr>
                        <td>${prodData.monthly_period || 'Monthly'}</td>
                        <td>${formatNumber(prodData.monthly_total, 2)}</td>
                        <td>${formatDiff(prodData.yoy_monthly_change, 2)}</td>
                    </tr>`;
            }
             if (prodData.cumulative_total !== undefined) {
                tableBody.innerHTML += `
                     <tr>
                        <td>${prodData.cumulative_period || 'Cumulative'}</td>
                        <td>${formatNumber(prodData.cumulative_total, 2)}</td>
                        <td>${formatDiff(prodData.yoy_cumulative_change, 2)}</td>
                    </tr>
                `;
            }
        };

        // 7. Render Detailed Statistical Summaries (Enhanced with Bar Charts)
        const renderStatisticalSummaries = (stats, meta) => {
            if (!stats || typeof stats !== 'object') return;

            const section = document.getElementById('statistical-summaries-section');
            const container = document.getElementById('statistical-summaries-container');
            container.innerHTML = '';
            
            let renderedStats = false;

            // 7.1 Elevation Averages
            if (stats.elevation_averages && Array.isArray(stats.elevation_averages.data)) {
                // (Table rendering logic omitted for brevity - see full code)
                // ... renders table ...
                renderedStats = true;
            }

            // 7.2 Quantity Sold Comparison
            if (stats.quantity_sold_comparison && Array.isArray(stats.quantity_sold_comparison.data)) {
                 // (Table rendering logic omitted for brevity - see full code)
                // ... renders table ...
                renderedStats = true;
            }
            
            // 7.3 Production Statistics (Enhanced with Bar Charts)
             if (stats.production_statistics) {
                const prodStats = stats.production_statistics;

                // Function to render both Table and Bar Chart
                const renderProdBlock = (dataObj, titlePrefix, blockId) => {
                    if (!dataObj || !Array.isArray(dataObj.data) || dataObj.data.length === 0) return;
                    
                    const data = dataObj.data;
                    const title = `${titlePrefix} (${dataObj.period})`;

                    const wrapper = document.createElement('div');
                    // Use analysis-layout for side-by-side table and chart (requires corresponding CSS in style.css)
                    wrapper.className = 'stat-summary-block analysis-layout';
                    wrapper.innerHTML = `<h4 style="flex-basis: 100%;">${title}</h4>`;

                    // --- Table Rendering ---
                    const tableContainer = document.createElement('div');
                    tableContainer.className = 'data-table-container';
                    tableContainer.style.flex = '1'; // Allow table to grow
                    const table = document.createElement('table');
                    table.className = 'data-table stats-table';

                    // Dynamically identify years
                    const years = Object.keys(data[0]).filter(k => k !== 'elevation' && k !== 'Elevation').sort((a, b) => b - a);
                    
                    let headerHtml = `<thead><tr><th>Elevation</th>`;
                    years.forEach(year => headerHtml += `<th>${year}</th>`);
                    if (years.length > 1) {
                        headerHtml += `<th>YoY Change</th>`;
                    }
                    headerHtml += `</tr></thead><tbody></tbody>`;
                    table.innerHTML = headerHtml;

                    const tbody = table.querySelector('tbody');
                    data.forEach(item => {
                        const elevationName = getElevationName(item);
                        let rowHtml = `<tr ${elevationName === 'TOTAL' ? 'class="total-row"' : ''}><td>${elevationName}</td>`;
                        years.forEach(year => {
                            rowHtml += `<td>${formatNumber(item[year], 2)}</td>`;
                        });
                        
                        if (years.length > 1) {
                            const currentVal = item[years[0]];
                            const previousVal = item[years[1]];
                            const yoyChange = (currentVal !== undefined && previousVal !== undefined) ? (currentVal - previousVal) : null;
                            rowHtml += `<td>${formatDiff(yoyChange, 2)}</td>`;
                        }
                        
                        rowHtml += `</tr>`;
                        tbody.innerHTML += rowHtml;
                    });
                    
                    tableContainer.appendChild(table);
                    wrapper.appendChild(tableContainer);

                    // --- Bar Chart Rendering (ENHANCEMENT) ---
                    const chartWrapper = document.createElement('div');
                    // Use standard chart container styling
                    chartWrapper.className = 'chart-container-bar'; 
                    chartWrapper.style.flex = '1'; // Allow chart to grow
                    const canvasId = `chart-prod-${blockId}`;
                    chartWrapper.innerHTML = `<canvas id="${canvasId}"></canvas>`;
                    wrapper.appendChild(chartWrapper);

                    container.appendChild(wrapper);
                    renderedStats = true;

                    // Generate Chart Data
                    const ctx = document.getElementById(canvasId).getContext('2d');
                    // Exclude Total row for visualization
                    const chartData = data.filter(item => getElevationName(item) !== 'TOTAL');
                    const labels = chartData.map(item => getElevationName(item));
                    
                    const datasets = years.map((year, index) => {
                        const colorMap = [CHART_COLORS.primary, CHART_COLORS.secondary, CHART_COLORS.neutral];
                        const color = colorMap[index] || CHART_COLORS.dark;
                        return {
                            label: year,
                            data: chartData.map(item => item[year]),
                            backgroundColor: color
                        };
                    });

                    // Use the predefined options
                    const options = JSON.parse(JSON.stringify(BAR_CHART_OPTIONS));
                    
                    new Chart(ctx, {
                        type: 'bar',
                        data: { labels: labels, datasets: datasets },
                        options: options
                    });
                };

                // Render description if present
                if (prodStats.description && (prodStats.monthly || prodStats.cumulative)) {
                    const desc = document.createElement('p');
                    desc.textContent = prodStats.description;
                    container.appendChild(desc);
                    // renderedStats=true will be set by the render function below
                }
                
                renderProdBlock(prodStats.monthly, "Monthly Production (M/Kgs)", "monthly");
                renderProdBlock(prodStats.cumulative, "Cumulative Production (M/Kgs)", "cumulative");
            }

            if (renderedStats) {
                section.style.display = 'block';
            }
        };


        // 8. Render Price Quotations (Universal and Stable)
        const renderPriceQuotations = (quotations, currency) => {
            // Defensive check for input validity
            if (!quotations || !Array.isArray(quotations) || quotations.length === 0) return;

            const section = document.getElementById('prices-section');
            const container = document.getElementById('prices-container');
            container.innerHTML = '';
            document.getElementById('price-quotations-title').textContent = `Price Quotations (${currency}/kg)`;
            section.style.display = 'block';

            // Check structure: Structured data (Mombasa) vs Flat array (Colombo).
            // Added extra check to ensure quotations[0] is an object and not null
            if (typeof quotations[0] === 'object' && quotations[0] !== null && quotations[0].structured_data) {
                // Mombasa/Structured CTC Rendering (Restored functionality)
                quotations.forEach(auction => {
                    const data = auction.structured_data;
                    if (!data) return;

                    const renderGradeTable = (grades, title) => {
                        if (!grades || !Array.isArray(grades) || grades.length === 0) return;

                        const wrapper = document.createElement('div');
                        wrapper.className = 'stat-summary-block';
                        wrapper.innerHTML = `<h4>${title}</h4>`;

                        const table = document.createElement('table');
                        table.className = 'data-table';
                        table.innerHTML = `<thead><tr><th>Category</th><th>Grade</th><th>Low</th><th>High</th></tr></thead><tbody></tbody>`;
                        
                        const tbody = table.querySelector('tbody');
                        grades.forEach(item => {
                            tbody.innerHTML += `
                                <tr>
                                    <td>${item.category || ''}</td>
                                    <td>${item.grade || ''}</td>
                                    <td>${formatNumber(item.low, 2)}</td>
                                    <td>${formatNumber(item.high, 2)}</td>
                                </tr>
                            `;
                        });
                        wrapper.appendChild(table);
                        container.appendChild(wrapper);
                    };

                    renderGradeTable(data.ctc_leaf_grades, "CTC Leaf Grades");
                    renderGradeTable(data.ctc_dust_grades, "CTC Dust Grades");
                });

            } else {
                // Colombo/Simple Range Rendering (Maintained functionality)
                const table = document.createElement('table');
                table.className = 'data-table';
                const thead = document.createElement('thead');
                const tbody = document.createElement('tbody');
                
                const hasElevation = quotations.some(item => item && item.elevation !== undefined);
                const hasCategory = quotations.some(item => item && item.category !== undefined);
                const hasPrevious = quotations.some(item => item && (item.previous_min !== undefined || item.previous_max !== undefined));
                
                let headerHtml = '<tr>';
                if (hasElevation) headerHtml += '<th>Elevation</th>';
                if (hasCategory) headerHtml += '<th>Category/Region</th>';
                headerHtml += '<th>Grade</th><th>Current Range</th>';
                
                if (hasPrevious) {
                    headerHtml += '<th>Previous Range</th><th style="text-align: center;">WoW Change (Avg)</th>';
                }
                headerHtml += '</tr>';
                thead.innerHTML = headerHtml;

                quotations.forEach(item => {
                    if (!item) return; // Skip null items defensively

                    let rowHtml = '<tr>';
                    if (hasElevation) rowHtml += `<td>${item.elevation || ''}</td>`;
                    if (hasCategory) rowHtml += `<td>${item.category || ''}</td>`;
                    rowHtml += `<td>${item.grade || ''}</td><td>${formatPriceRange(item.current_min, item.current_max)}</td>`;
                    
                    if (hasPrevious) {
                        rowHtml += `<td>${formatPriceRange(item.previous_min, item.previous_max)}</td>`;
                        
                        const currentAvg = calculateAverage(item.current_min, item.current_max);
                        const previousAvg = calculateAverage(item.previous_min, item.previous_max);
                        
                        let diffHtml = '<td style="text-align: center;">N/A</td>';
                        if (currentAvg !== null && previousAvg !== null) {
                            const diff = currentAvg - previousAvg;
                            diffHtml = `<td style="text-align: center;">${formatDiff(diff)}</td>`;
                        }
                        rowHtml += diffHtml;
                    }
                    rowHtml += '</tr>';
                    tbody.innerHTML += rowHtml;
                });

                table.appendChild(thead);
                table.appendChild(tbody);
                container.appendChild(table);
            }
        };

        // Main Report Rendering Logic (Orchestration)
        const renderReport = (data) => {
            if (!data || !data.metadata) {
                console.error("Invalid report data structure.");
                return;
            }
            const meta = data.metadata;

            // 0. Metadata and Title
            const titlePrefix = meta.report_title || `${meta.auction_centre || meta.region || ''} Consolidated Report`;
            document.getElementById('report-title').textContent = `${titlePrefix} - Week ${meta.week_number} (${meta.year})`;
            
            // Handle data sources flexibly and defensively
            let dataSourceText = 'N/A';
            if (Array.isArray(meta.data_sources) && meta.data_sources.length > 0) {
                dataSourceText = meta.data_sources.join(', ');
            } else if (meta.broker) {
                dataSourceText = meta.broker;
            }

            let metaText = `Data Sources: ${dataSourceText}`;
            if (meta.sale_number) metaText += ` | Sale No: ${meta.sale_number}`;
            
            const startDate = meta.sale_date_start;
            const endDate = meta.sale_date_end;

            if (startDate && endDate && startDate !== endDate) {
                metaText += ` | Dates: ${startDate} to ${endDate}`;
            } else if (endDate) {
                 metaText += ` | Date: ${endDate}`;
            }
            document.getElementById('report-meta').textContent = metaText;

            // Render Sections (following the standardized order)
            try {
                renderCommentary(data.summary);
                renderUnifiedForecastAndDrivers(data);
                renderUnifiedSupplyAnalysis(data);
                renderUnifiedDemandAndPriceAnalysis(data);
                renderVisualizations(data.visualizations); // Handles Mombasa Line Charts
                renderProductionAnalysis(data.production_analysis);
                renderStatisticalSummaries(data.statistical_summaries, meta); // Handles Tables and Colombo Bar Charts
                
                // Use 'international_summaries' for Mombasa structure if 'price_quotations' is absent
                const priceData = data.price_quotations || data.international_summaries;
                renderPriceQuotations(priceData, meta.currency);

            } catch (error) {
                console.error("Error during report rendering:", error);
                alert("An error occurred while rendering the report sections. Some visualizations may be incomplete.");
            }
        };

        // --- Data Loading ---
        document.addEventListener('DOMContentLoaded', async () => {
            // Initialize mobile menu toggle (from script.js)
             if (typeof initializeMobileMenu === 'function') {
                initializeMobileMenu();
            }
            
            const params = new URLSearchParams(window.location.search);
            const datasetFile = params.get('dataset');
            
            if (!datasetFile) {
                document.getElementById('report-title').textContent = 'Error: No report selected.';
                document.getElementById('loading-indicator').style.display = 'none';
                return;
            }

            // Ensure correct directory pathing
            const directory = datasetFile.includes("Consolidated") ? "Data/Consolidated/" : "Data/Market_Reports/";

            try {
                const response = await fetch(`${directory}${datasetFile}.json`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const reportData = await response.json();
                
                // Orchestrate the rendering
                renderReport(reportData);
                
                document.getElementById('loading-indicator').style.display = 'none';
                document.getElementById('report-content').style.display = 'block';

            } catch (error) {
                console.error('Error fetching report data:', error);
                document.getElementById('report-title').textContent = 'Error loading report.';
                document.getElementById('loading-indicator').textContent = `Could not load the dataset: ${directory}${datasetFile}.json. Error: ${error.message}`;
            }
        });
    </script>
</body>
</html>