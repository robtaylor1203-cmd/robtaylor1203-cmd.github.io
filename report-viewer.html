<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market Report Viewer - TeaTrade</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="market-reports-page">
    <header class="site-header">
        <div class="header-top-bar">
            <a href="corporate.html" class="header-logo"><h1>Tea<span>Trade</span></h1></a>
            <div class="header-search-wrapper"><input type="text" class="header-search-bar" placeholder="Global site search..."></div>
            <div class="user-actions">
                <a href="#" title="Create Account"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><line x1="20" y1="8" x2="20" y2="14"></line><line x1="17" y1="11" x2="23" y2="11"></line></svg></a>
                <a href="#" title="Sign In"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path><polyline points="10 17 15 12 10 7"></polyline><line x1="15" y1="12" x2="3" y2="12"></line></svg></a>
            </div>
            <button class="mobile-menu-toggle" aria-label="Toggle navigation" aria-expanded="false">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
            </button>
        </div>
        <nav class="secondary-nav">
            <ul>
                <li><a href="data.html">Data</a></li>
                <li><a href="market-reports.html" class="active">Market Reports</a></li>
                <li><a href="#">Auctions</a></li>
                <li><a href="visuals.html">Visuals</a></li>
            </ul>
        </nav>
    </header>

    <main class="page-container">
        <div class="dashboard-header">
            <h2 class="page-title" id="report-title">Loading Report...</h2>
        </div>
        <p id="report-meta" class="report-meta"></p>

        <div id="report-content" style="display: none;">
            
            <section class="report-section" id="commentary-section" style="display: none;">
                <h3>Market Commentary</h3>
                <p id="synthesized-commentary"></p>
            </section>

            <section class="report-section" id="drivers-forecast-section" style="display: none;">
                <h3 id="drivers-forecast-title">Market Forecast & Drivers</h3>
                <div class="analysis-grid" id="drivers-forecast-container">
                    </div>
            </section>

            <section class="report-section" id="supply-offerings-section" style="display: none;">
                <h3 id="supply-offerings-title">Supply & Offerings Analysis</h3>
                <div class="analysis-text">
                     <p id="supply-offerings-analysis-text"></p>
                </div>
                <div class="data-table-container" id="offerings-wow-table-container" style="display: none; max-width: 700px; margin-top: 16px;">
                    <table class="data-table stats-table" id="offerings-wow-table">
                        <thead>
                            <tr>
                                <th>Metric</th>
                                <th>Current Week</th>
                                <th>Previous Week</th>
                                <th>WoW Change</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </section>

             <section class="report-section" id="demand-price-section" style="display: none;">
                <h3 id="demand-price-title">Demand & Price Analysis</h3>
                <div class="analysis-grid" id="price-analysis-grid-container">
                </div>
                <div class="analysis-text" id="demand-analysis-text-container">
                </div>
            </section>

            <section class="report-section" id="visualizations-section" style="display: none;">
                <h3>Market Visualizations</h3>
                <div class="visualizations-grid" id="visualizations-container">
                </div>
            </section>

            <section class="report-section" id="production-analysis-section" style="display: none;">
                <h3>Production Analysis</h3>
                 <div class="analysis-layout">
                    <div class="analysis-text" style="flex: 1;">
                        <p id="production-analysis-text"></p>
                    </div>
                    <div class="analysis-visual" style="flex: 0 0 350px;">
                         <div class="data-table-container">
                            <table class="data-table stats-table" id="production-table">
                                <thead>
                                    <tr>
                                        <th>Period</th>
                                        <th>Total (M/Kgs)</th>
                                        <th>YoY Change (M/Kgs)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

             <section class="report-section" id="statistical-summaries-section" style="display: none;">
                <h3>Detailed Statistics</h3>
                <div id="statistical-summaries-container">
                    </div>
            </section>

            <section class="report-section" id="prices-section" style="display: none;">
                <h3 id="price-quotations-title">Price Quotations</h3>
                <div class="data-table-container" id="prices-container">
                     </div>
            </section>

        </div>
        <div id="loading-indicator">Loading data...</div>
    </main>
    <script src="script.js"></script>
    
    <script>
        // --- Configuration ---
        const CHART_COLORS = {
            primary: '#1a73e8',
            secondary: '#4285f4',
            accent1: '#fbbc05',
            accent2: '#34a853',
            neutral: '#5f6368',
            background: '#f1f3f4'
        };

        // --- Utility Functions ---
        const formatNumber = (num, decimals = 0) => {
            if (num === null || num === undefined || isNaN(num)) return 'N/A';
            return num.toLocaleString(undefined, { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
        };

        const formatPriceRange = (min, max) => {
             if ((min === null || min === undefined) && (max === null || max === undefined)) return 'N/A';
             if (max === null || max === undefined) return formatNumber(min, 2);
             if (min === null || min === undefined) return formatNumber(max, 2);
             return `${formatNumber(min, 2)} - ${formatNumber(max, 2)}`;
        }

        const formatDiff = (num, decimals = 2, forceSign = false) => {
            if (num === null || num === undefined || isNaN(num) || num === 0) return `<span class="diff-neutral">-</span>`;
            
            const formatted = formatNumber(Math.abs(num), decimals);
            const className = num > 0 ? 'diff-positive' : 'diff-negative';
            const arrow = num > 0 ? '▲' : '▼';
            const sign = forceSign ? (num > 0 ? '+' : '-') : '';
            
            return `<span class="${className}">${arrow} ${sign}${formatted}</span>`;
        }

        const calculateAverage = (min, max) => {
            if (min === null || max === null || min === undefined || max === undefined || isNaN(min) || isNaN(max)) return null;
            return (Number(min) + Number(max)) / 2;
        }

        // --- Universal Rendering Functions ---

        // 1. Render Synthesized Commentary
        const renderCommentary = (summary) => {
            if (summary && summary.commentary_synthesized) {
                document.getElementById('commentary-section').style.display = 'block';
                document.getElementById('synthesized-commentary').textContent = summary.commentary_synthesized;
            }
        };

        // 2. Render Forecast and Drivers (Universal)
        // Handles both 'forecast_analysis' (Colombo) and 'market_drivers' (Mombasa)
        const renderUnifiedForecastAndDrivers = (data) => {
            const forecastData = data.forecast_analysis;
            const driversData = data.market_drivers;

            if ((!forecastData || forecastData.length === 0) && (!driversData || driversData.length === 0)) {
                return;
            }

            const section = document.getElementById('drivers-forecast-section');
            section.style.display = 'block';
            const container = document.getElementById('drivers-forecast-container');
            container.innerHTML = '';

            // Helper function to render the cards
            const renderCard = (item) => {
                const card = document.createElement('div');
                card.className = 'analysis-card';
                
                let sentimentHtml = '';
                if (item.sentiment) {
                    let sentimentClass = '';
                    if (item.sentiment.includes("Bullish")) sentimentClass = 'sentiment-bullish';
                    if (item.sentiment.includes("Negative") || item.sentiment.includes("Bearish")) sentimentClass = 'sentiment-negative';
                    sentimentHtml = `<p class="sentiment ${sentimentClass}">${item.sentiment}</p>`;
                }

                // Handle different structures (Mombasa 'driver' vs Colombo 'factor')
                const title = item.driver || item.factor;
                // Handle different structures (Mombasa 'impact' vs Colombo 'analysis'/'outlook')
                const analysis = item.impact || `${item.outlook ? '<strong>Outlook:</strong> ' + item.outlook + '<br>' : ''}<strong>Analysis:</strong> ${item.analysis}`;


                card.innerHTML = `
                    <h4>${title}</h4>
                    ${sentimentHtml}
                    <p>${analysis}</p>
                `;
                container.appendChild(card);
            };

            if (forecastData && forecastData.length > 0) {
                forecastData.forEach(renderCard);
            } else if (driversData && driversData.length > 0) {
                driversData.forEach(renderCard);
            }
        };

        // 3. Render Supply & Offerings Analysis (Universal)
        // Handles 'offerings_analysis' (Colombo) and 'supply_analysis' (Mombasa)
        const renderUnifiedSupplyAnalysis = (data) => {
            const offeringsData = data.offerings_analysis;
            const supplyData = data.supply_analysis;

            if (!offeringsData && !supplyData) {
                return;
            }

            const section = document.getElementById('supply-offerings-section');
            section.style.display = 'block';
            const analysisTextElement = document.getElementById('supply-offerings-analysis-text');
            analysisTextElement.innerHTML = '';

            // Determine the primary analysis text
            let analysisText = '';
            if (offeringsData && offeringsData.analysis) {
                analysisText = offeringsData.analysis;
            } else if (supplyData && supplyData.analysis) {
                analysisText = supplyData.analysis;
            }
            
            // Add detailed breakdown if available (Mombasa style)
            if (supplyData && supplyData.details) {
                analysisText += '<br><br><strong>Details:</strong><ul>';
                supplyData.details.forEach(detail => {
                    analysisText += `<li>${detail}</li>`;
                });
                analysisText += '</ul>';
            }
            
            analysisTextElement.innerHTML = analysisText;

            // Render WoW Table if data exists (Standardized style)
            // Note: Doughnut chart is intentionally removed for consistency.
            if (offeringsData && offeringsData.current_week_kg !== undefined) {
                document.getElementById('offerings-wow-table-container').style.display = 'block';
                const tableBody = document.querySelector('#offerings-wow-table tbody');
                tableBody.innerHTML = `
                    <tr>
                        <td>Total Quantity (Kg)</td>
                        <td>${formatNumber(offeringsData.current_week_kg)}</td>
                        <td>${formatNumber(offeringsData.previous_week_kg)}</td>
                        <td>${formatDiff(offeringsData.wow_change_kg, 0)} (${formatDiff(offeringsData.wow_change_percent, 2)}%)</td>
                    </tr>
                `;
            }
        };

        // 4. Render Demand & Price Analysis (Universal)
        // Handles 'price_analysis' (Colombo) and 'demand_analysis' (Mombasa)
        const renderUnifiedDemandAndPriceAnalysis = (data) => {
            const priceData = data.price_analysis;
            const demandData = data.demand_analysis;

            if (!priceData && !demandData) {
                return;
            }

            const section = document.getElementById('demand-price-section');
            section.style.display = 'block';
            const gridContainer = document.getElementById('price-analysis-grid-container');
            const textContainer = document.getElementById('demand-analysis-text-container');
            gridContainer.innerHTML = '';
            textContainer.innerHTML = '';

            // Render Grid-based analysis (Colombo style)
            if (priceData) {
                const analysisPoints = [
                    { title: "High Grown", text: priceData.analysis_high_grown },
                    { title: "Medium Grown", text: priceData.analysis_medium_grown },
                    { title: "Low Grown", text: priceData.analysis_low_grown },
                    { title: "CTC", text: priceData.analysis_ctc }
                ];

                analysisPoints.forEach(item => {
                    if (item.text) {
                        const card = document.createElement('div');
                        card.className = 'analysis-card';
                        card.innerHTML = `
                            <h4>${item.title}</h4>
                            <p>${item.text}</p>
                        `;
                        gridContainer.appendChild(card);
                    }
                });
            }

            // Render Narrative-based analysis (Mombasa style)
            if (demandData && demandData.analysis) {
                let analysisText = `<p>${demandData.analysis}</p>`;
                
                if (demandData.details) {
                    analysisText += '<br><strong>Details:</strong><ul>';
                    demandData.details.forEach(detail => {
                        analysisText += `<li>${detail}</li>`;
                    });
                    analysisText += '</ul>';
                }
                textContainer.innerHTML = analysisText;
            }
        };

        // 5. Render Visualizations (e.g., Price Trends - Mombasa Gold Standard)
        const renderVisualizations = (vizData) => {
            if (!vizData || vizData.length === 0) {
                return;
            }

            const section = document.getElementById('visualizations-section');
            section.style.display = 'block';
            const container = document.getElementById('visualizations-container');
            container.innerHTML = '';

            vizData.forEach((viz, index) => {
                const wrapper = document.createElement('div');
                wrapper.className = 'visualization-block';
                const canvasId = `vizChart-${index}`;
                // Uses the standardized CSS class for line charts
                wrapper.innerHTML = `
                    <h4>${viz.title}</h4>
                    <div class="chart-container-line">
                        <canvas id="${canvasId}"></canvas>
                    </div>
                `;
                container.appendChild(wrapper);

                const ctx = document.getElementById(canvasId).getContext('2d');
                
                const datasets = viz.data.map((series, i) => {
                    const colors = [CHART_COLORS.primary, CHART_COLORS.accent2, CHART_COLORS.accent1, CHART_COLORS.neutral];
                    return {
                        label: series.label,
                        data: series.values,
                        borderColor: colors[i % colors.length],
                        backgroundColor: colors[i % colors.length] + '33', // Add transparency
                        tension: 0.1,
                        fill: false
                    };
                });

                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: viz.labels,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                title: {
                                    display: true,
                                    text: viz.y_axis_label || 'Value'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: viz.x_axis_label || 'Period'
                                }
                            }
                        }
                    }
                });
            });
        };


        // 6. Render Production Analysis (Standardized)
        const renderProductionAnalysis = (prodData) => {
            if (!prodData || !prodData.analysis) {
                return;
            }
            
            document.getElementById('production-analysis-section').style.display = 'block';

            // Text Analysis
            document.getElementById('production-analysis-text').textContent = prodData.analysis;

            // Table
            const tableBody = document.querySelector('#production-table tbody');
            tableBody.innerHTML = `
                <tr>
                    <td>${prodData.monthly_period || 'Monthly'}</td>
                    <td>${formatNumber(prodData.monthly_total, 2)}</td>
                    <td>${formatDiff(prodData.yoy_monthly_change, 2)}</td>
                </tr>
                <tr>
                    <td>${prodData.cumulative_period || 'Cumulative'}</td>
                    <td>${formatNumber(prodData.cumulative_total, 2)}</td>
                    <td>${formatDiff(prodData.yoy_cumulative_change, 2)}</td>
                </tr>
            `;
        };

        // 7. Render Detailed Statistical Summaries (Standardized, handles various table structures)
        const renderStatisticalSummaries = (stats, meta) => {
            if (!stats || Object.keys(stats).length === 0) return;

            const section = document.getElementById('statistical-summaries-section');
            const container = document.getElementById('statistical-summaries-container');
            container.innerHTML = '';
            
            // Internal flag to track if any stats were rendered
            let renderedStats = false;

            // 7.1 Elevation Averages
            if (stats.elevation_averages && stats.elevation_averages.data) {
                const data = stats.elevation_averages.data;
                const title = stats.elevation_averages.description || "Elevation Averages";

                const wrapper = document.createElement('div');
                wrapper.className = 'stat-summary-block';
                wrapper.innerHTML = `<h4>${title}</h4>`;

                const tableContainer = document.createElement('div');
                tableContainer.className = 'data-table-container';
                const table = document.createElement('table');
                table.className = 'data-table stats-table';

                // Assuming standard structure for this specific table type
                table.innerHTML = `
                    <thead><tr><th>Elevation</th><th>Average (LKR)</th><th>Average (USD)</th></tr></thead>
                    <tbody></tbody>
                `;

                const tbody = table.querySelector('tbody');
                data.forEach(item => {
                    // Handle potential variations in the key name (case sensitivity)
                    const elevationName = item.elevation || item.Elevation;
                    let rowHtml = `<tr ${elevationName === 'Total' ? 'class="total-row"' : ''}>
                        <td>${elevationName}</td>
                        <td>${formatNumber(item.average_lkr, 2)}</td>
                        <td>${formatNumber(item.average_usd, 2)}</td>
                    </tr>`;
                    tbody.innerHTML += rowHtml;
                });

                tableContainer.appendChild(table);
                wrapper.appendChild(tableContainer);
                container.appendChild(wrapper);
                renderedStats = true;
            }

            // 7.2 Quantity Sold Comparison
            if (stats.quantity_sold_comparison && stats.quantity_sold_comparison.data) {
                 const data = stats.quantity_sold_comparison.data;
                 const title = stats.quantity_sold_comparison.description || "Quantity Sold Comparison (Kg)";

                 const wrapper = document.createElement('div');
                wrapper.className = 'stat-summary-block';
                wrapper.innerHTML = `<h4>${title}</h4>`;
                
                const tableContainer = document.createElement('div');
                tableContainer.className = 'data-table-container';
                const table = document.createElement('table');
                table.className = 'data-table stats-table';
                
                const year = meta.year;
                table.innerHTML = `
                    <thead>
                        <tr>
                            <th rowspan="2" class="header-main">Category</th>
                            <th colspan="2" class="header-main">Weekly</th>
                            <th colspan="2" class="header-main">To Date</th>
                            <th rowspan="2" class="header-main">To Date +/-</th>
                        </tr>
                        <tr>
                            <th class="header-sub">${year}</th>
                            <th class="header-sub">${year-1}</th>
                            <th class="header-sub">${year}</th>
                            <th class="header-sub">${year-1}</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                `;
                
                const tbody = table.querySelector('tbody');
                data.forEach(item => {
                    const diff = item.todate_current_year - item.todate_previous_year;
                    const row = document.createElement('tr');
                     if (item.category === "Total") {
                        row.className = 'total-row';
                    }
                    row.innerHTML = `
                        <td>${item.category}</td>
                        <td>${formatNumber(item.weekly_current_year)}</td>
                        <td>${formatNumber(item.weekly_previous_year)}</td>
                        <td>${formatNumber(item.todate_current_year)}</td>
                        <td>${formatNumber(item.todate_previous_year)}</td>
                        <td>${formatDiff(diff, 0)}</td>
                    `;
                    tbody.appendChild(row);
                });
                
                tableContainer.appendChild(table);
                wrapper.appendChild(tableContainer);
                container.appendChild(wrapper);
                renderedStats = true;
            }
            
            // 7.3 Production Statistics (Detailed Tables)
             if (stats.production_statistics) {
                const prodStats = stats.production_statistics;

                const renderProdTable = (dataObj, titlePrefix) => {
                    if (!dataObj || !dataObj.data || dataObj.data.length === 0) return;
                    
                    const data = dataObj.data;
                    const title = `${titlePrefix} (${dataObj.period})`;

                    const wrapper = document.createElement('div');
                    wrapper.className = 'stat-summary-block';
                    wrapper.innerHTML = `<h4>${title}</h4>`;

                    const tableContainer = document.createElement('div');
                    tableContainer.className = 'data-table-container';
                    const table = document.createElement('table');
                    table.className = 'data-table stats-table';

                    // Dynamically identify years
                    const years = Object.keys(data[0]).filter(k => k !== 'elevation' && k !== 'Elevation').sort((a, b) => b - a);
                    
                    let headerHtml = `<thead><tr><th>Elevation</th>`;
                    years.forEach(year => headerHtml += `<th>${year}</th>`);
                    // Add YoY comparison (Current vs Previous)
                    if (years.length > 1) {
                        headerHtml += `<th>YoY Change</th>`;
                    }
                    headerHtml += `</tr></thead><tbody></tbody>`;
                    table.innerHTML = headerHtml;

                    const tbody = table.querySelector('tbody');
                    data.forEach(item => {
                        const elevationName = item.elevation || item.Elevation;
                        let rowHtml = `<tr ${elevationName === 'TOTAL' ? 'class="total-row"' : ''}><td>${elevationName}</td>`;
                        years.forEach(year => {
                            rowHtml += `<td>${formatNumber(item[year], 2)}</td>`;
                        });
                        
                        // Calculate YoY Change
                        if (years.length > 1) {
                            const currentVal = item[years[0]];
                            const previousVal = item[years[1]];
                            const yoyChange = (currentVal !== undefined && previousVal !== undefined) ? (currentVal - previousVal) : null;
                            rowHtml += `<td>${formatDiff(yoyChange, 2)}</td>`;
                        }
                        
                        rowHtml += `</tr>`;
                        tbody.innerHTML += rowHtml;
                    });
                    
                    tableContainer.appendChild(table);
                    wrapper.appendChild(tableContainer);
                    container.appendChild(wrapper);
                    renderedStats = true;
                };

                if (prodStats.description) {
                    const desc = document.createElement('p');
                    desc.textContent = prodStats.description;
                    // Only add description if tables are also present
                    if (prodStats.monthly || prodStats.cumulative) {
                         container.appendChild(desc);
                         renderedStats = true;
                    }
                }
                renderProdTable(prodStats.monthly, "Monthly Production (M/Kgs)");
                renderProdTable(prodStats.cumulative, "Cumulative Production (M/Kgs)");
            }

            if (renderedStats) {
                section.style.display = 'block';
            }
        };


        // 8. Render Price Quotations (Universal - handles Simple Range and Structured CTC)
        const renderPriceQuotations = (quotations, currency) => {
            if (!quotations || quotations.length === 0) return;

            const section = document.getElementById('prices-section');
            const container = document.getElementById('prices-container');
            container.innerHTML = '';
            document.getElementById('price-quotations-title').textContent = `Price Quotations (${currency}/kg)`;
            section.style.display = 'block';

            // Check structure: Structured data (Mombasa) vs Flat array (Colombo).
            if (quotations[0] && quotations[0].structured_data) {
                // Mombasa/Structured CTC Rendering
                quotations.forEach(auction => {
                    const data = auction.structured_data;
                    if (!data) return;

                    const renderGradeTable = (grades, title) => {
                        if (!grades || grades.length === 0) return;

                        const wrapper = document.createElement('div');
                        wrapper.className = 'stat-summary-block';
                        wrapper.innerHTML = `<h4>${title}</h4>`;

                        const table = document.createElement('table');
                        table.className = 'data-table';
                        table.innerHTML = `<thead><tr><th>Category</th><th>Grade</th><th>Low</th><th>High</th></tr></thead><tbody></tbody>`;
                        
                        const tbody = table.querySelector('tbody');
                        grades.forEach(item => {
                            tbody.innerHTML += `
                                <tr>
                                    <td>${item.category}</td>
                                    <td>${item.grade}</td>
                                    <td>${formatNumber(item.low, 2)}</td>
                                    <td>${formatNumber(item.high, 2)}</td>
                                </tr>
                            `;
                        });
                        wrapper.appendChild(table);
                        container.appendChild(wrapper);
                    };

                    renderGradeTable(data.ctc_leaf_grades, "CTC Leaf Grades");
                    renderGradeTable(data.ctc_dust_grades, "CTC Dust Grades");
                });

            } else {
                // Colombo/Simple Range Rendering
                const table = document.createElement('table');
                table.className = 'data-table';
                const thead = document.createElement('thead');
                const tbody = document.createElement('tbody');
                
                const hasElevation = quotations.some(item => item.elevation !== undefined);
                const hasCategory = quotations.some(item => item.category !== undefined);
                const hasPrevious = quotations.some(item => item.previous_min !== undefined || item.previous_max !== undefined);
                
                let headerHtml = '<tr>';
                if (hasElevation) headerHtml += '<th>Elevation</th>';
                if (hasCategory) headerHtml += '<th>Category/Region</th>';
                headerHtml += '<th>Grade</th><th>Current Range</th>';
                
                if (hasPrevious) {
                    headerHtml += '<th>Previous Range</th><th style="text-align: center;">WoW Change (Avg)</th>';
                }
                headerHtml += '</tr>';
                thead.innerHTML = headerHtml;

                quotations.forEach(item => {
                    let rowHtml = '<tr>';
                    if (hasElevation) rowHtml += `<td>${item.elevation || ''}</td>`;
                    if (hasCategory) rowHtml += `<td>${item.category || ''}</td>`;
                    rowHtml += `<td>${item.grade}</td><td>${formatPriceRange(item.current_min, item.current_max)}</td>`;
                    
                    if (hasPrevious) {
                        rowHtml += `<td>${formatPriceRange(item.previous_min, item.previous_max)}</td>`;
                        
                        const currentAvg = calculateAverage(item.current_min, item.current_max);
                        const previousAvg = calculateAverage(item.previous_min, item.previous_max);
                        
                        let diffHtml = '<td style="text-align: center;">N/A</td>';
                        if (currentAvg !== null && previousAvg !== null) {
                            const diff = currentAvg - previousAvg;
                            diffHtml = `<td style="text-align: center;">${formatDiff(diff)}</td>`;
                        }
                        rowHtml += diffHtml;
                    }
                    rowHtml += '</tr>';
                    tbody.innerHTML += rowHtml;
                });

                table.appendChild(thead);
                table.appendChild(tbody);
                container.appendChild(table);
            }
        };

        // Main Report Rendering Logic (Orchestration)
        const renderReport = (data) => {
            const meta = data.metadata;

            // 0. Metadata and Title
            const titlePrefix = meta.report_title || `${meta.auction_centre || meta.region} Consolidated Report`;
            document.getElementById('report-title').textContent = `${titlePrefix} - Week ${meta.week_number} (${meta.year})`;
            
            // Handle data sources flexibly
            let dataSourceText = 'N/A';
            if (meta.data_sources && Array.isArray(meta.data_sources)) {
                dataSourceText = meta.data_sources.join(', ');
            } else if (meta.broker) {
                dataSourceText = meta.broker;
            }

            let metaText = `Data Sources: ${dataSourceText}`;
            if (meta.sale_number) metaText += ` | Sale No: ${meta.sale_number}`;
            
            const startDate = meta.sale_date_start;
            const endDate = meta.sale_date_end;

            if (startDate && endDate && startDate !== endDate) {
                metaText += ` | Dates: ${startDate} to ${endDate}`;
            } else if (endDate) {
                 metaText += ` | Date: ${endDate}`;
            }
            document.getElementById('report-meta').textContent = metaText;

            // Render Sections (following the standardized order)
            renderCommentary(data.summary);
            renderUnifiedForecastAndDrivers(data);
            renderUnifiedSupplyAnalysis(data);
            renderUnifiedDemandAndPriceAnalysis(data);
            renderVisualizations(data.visualizations);
            renderProductionAnalysis(data.production_analysis);
            renderStatisticalSummaries(data.statistical_summaries, meta);
            
            // Use 'international_summaries' for Mombasa structure if 'price_quotations' is absent
            const priceData = data.price_quotations || data.international_summaries;
            renderPriceQuotations(priceData, meta.currency);
        };

        // --- Data Loading ---
        document.addEventListener('DOMContentLoaded', async () => {
            // Initialize mobile menu toggle (from script.js)
             if (typeof initializeMobileMenu === 'function') {
                initializeMobileMenu();
            }
            
            const params = new URLSearchParams(window.location.search);
            const datasetFile = params.get('dataset');
            
            if (!datasetFile) {
                document.getElementById('report-title').textContent = 'Error: No report selected.';
                document.getElementById('loading-indicator').style.display = 'none';
                return;
            }

            // Determine the directory based on the dataset name convention
            // All consolidated reports should be in Data/Consolidated/
            const directory = datasetFile.includes("Consolidated") ? "Data/Consolidated/" : "Data/Market_Reports/";


            try {
                const response = await fetch(`${directory}${datasetFile}.json`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const reportData = await response.json();
                
                // Orchestrate the rendering
                renderReport(reportData);
                
                document.getElementById('loading-indicator').style.display = 'none';
                document.getElementById('report-content').style.display = 'block';

            } catch (error) {
                console.error('Error fetching report data:', error);
                document.getElementById('report-title').textContent = 'Error loading report.';
                document.getElementById('loading-indicator').textContent = `Could not load the dataset: ${directory}${datasetFile}.json. Error: ${error.message}`;
            }
        });
    </script>
</body>
</html>