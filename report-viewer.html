<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Market Report Viewer - TeaTrade</title>
<link rel="stylesheet" href="style.css">
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="market-reports-page">
<header class="site-header">
<div class="header-top-bar">
<a href="corporate.html" class="header-logo"><h1>Tea<span>Trade</span></h1></a>
<div class="header-search-wrapper"><input type="text" class="header-search-bar" placeholder="Global site search"></div>
<div class="user-actions">
<a href="#" title="Create Account"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg></a>
<a href="#" title="Sign In"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 3h6v6"></path><path d="M10 14 21 3"></path><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path></svg></a>
</div>
</div>
<nav class="secondary-nav">
<ul>
<li><a href="data.html">Data</a></li>
<li><a href="market-reports.html" class="active">Market Reports</a></li>
<li><a href="#">Auctions</a></li>
<li><a href="visuals.html">Visuals</a></li>
</ul>
</nav>
</header>
<main class="page-container">
<h2 id="report-title">Loading Report...</h2>
<div id="report-content">
<p id="loading-message">Loading report data...</p>
<div id="report-details" style="display: none;">
<!-- Report content will be populated here -->
</div>
</div>
</main>

<script>
document.addEventListener('DOMContentLoaded', async () => {
const params = new URLSearchParams(window.location.search);
const dataset = params.get('dataset');

console.log('Dataset parameter:', dataset);

if (!dataset) {
document.getElementById('report-title').textContent = 'Error: No dataset specified';
document.getElementById('loading-message').innerHTML = '<p style="color:red;">Please provide a dataset parameter.</p>';
return;
}

const dataFile = `Data/Consolidated/${dataset}.json`;
console.log('Loading data file:', dataFile);

try {
const response = await fetch(dataFile);
console.log('Response status:', response.status, response.statusText);

if (!response.ok) {
throw new Error(`Failed to load report: HTTP ${response.status} - ${response.statusText}`);
}

const data = await response.json();
console.log('Report data loaded successfully');
displayReport(data);

} catch (error) {
console.error('Error loading report:', error);
document.getElementById('report-title').textContent = 'Error Loading Report';
document.getElementById('loading-message').innerHTML = `
<div style="color:red; padding: 20px; border: 1px solid #red; border-radius: 5px;">
<h3>Report Loading Failed</h3>
<p><strong>Error:</strong> ${error.message}</p>
<p><strong>Dataset:</strong> ${dataset}</p>
<p><strong>File Path:</strong> ${dataFile}</p>
<p><strong>Debug Steps:</strong></p>
<ol>
<li>Check if the file exists: <code>ls -la ${dataFile}</code></li>
<li>Test file access: <code>curl -s http://localhost:8000/${dataFile} | head -5</code></li>
<li>Check browser console for detailed error messages</li>
</ol>
</div>
`;
}
});

function displayReport(data) {
const metadata = data.metadata || {};
const summary = data.summary || {};
const marketIntelligence = data.market_intelligence || {};
const volumeAnalysis = data.volume_analysis || {};
const priceAnalysis = data.price_analysis || {};
const weatherAnalysis = data.weather_analysis || {};
const forecastAnalysis = data.forecast_analysis || {};

// Update title
document.getElementById('report-title').textContent = 
metadata.report_title || `${metadata.auction_centre} Market Report - Week ${metadata.week_number}, ${metadata.year}`;

// Display comprehensive report
const reportHtml = `
<div style="background:#f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0;">
<h3>Report Successfully Loaded! ‚úÖ</h3>

<!-- Executive Summary -->
<div style="background: white; padding: 15px; border-radius: 5px; margin: 15px 0;">
<h4>Executive Summary</h4>
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 10px;">
<div><strong>Centre:</strong> ${metadata.auction_centre || 'N/A'}</div>
<div><strong>Week:</strong> ${metadata.week_number || 'N/A'}</div>
<div><strong>Year:</strong> ${metadata.year || 'N/A'}</div>
<div><strong>Currency:</strong> ${metadata.currency || 'N/A'}</div>
<div><strong>Total Lots:</strong> ${summary.total_lots || 'N/A'}</div>
<div><strong>Offered (kg):</strong> ${summary.total_offered_kg ? summary.total_offered_kg.toLocaleString() : 'N/A'}</div>
<div><strong>Sold (kg):</strong> ${summary.total_sold_kg ? summary.total_sold_kg.toLocaleString() : 'N/A'}</div>
<div><strong>Avg Price:</strong> ${summary.auction_average_price || 'N/A'}</div>
</div>
</div>

<!-- Market Intelligence -->
${marketIntelligence.executive_commentary ? `
<div style="background: white; padding: 15px; border-radius: 5px; margin: 15px 0;">
<h4>Market Intelligence</h4>
<p><strong>Executive Commentary:</strong></p>
<p>${marketIntelligence.executive_commentary}</p>
<p><strong>Detailed Analysis:</strong></p>
<p>${marketIntelligence.detailed_analysis || 'Analysis in progress...'}</p>
</div>
` : ''}

<!-- Volume Analysis -->
${volumeAnalysis.by_grade_detailed ? `
<div style="background: white; padding: 15px; border-radius: 5px; margin: 15px 0;">
<h4>Volume Analysis by Grade</h4>
<div style="overflow-x: auto;">
<table style="width: 100%; border-collapse: collapse;">
<thead>
<tr style="background: #f8f9fa;">
<th style="padding: 8px; border: 1px solid #dee2e6;">Grade</th>
<th style="padding: 8px; border: 1px solid #dee2e6;">Lots</th>
<th style="padding: 8px; border: 1px solid #dee2e6;">Packages</th>
<th style="padding: 8px; border: 1px solid #dee2e6;">Weight (kg)</th>
<th style="padding: 8px; border: 1px solid #dee2e6;">% of Offering</th>
</tr>
</thead>
<tbody>
${volumeAnalysis.by_grade_detailed.map(grade => `
<tr>
<td style="padding: 8px; border: 1px solid #dee2e6;"><strong>${grade.grade}</strong></td>
<td style="padding: 8px; border: 1px solid #dee2e6;">${grade.lot_count}</td>
<td style="padding: 8px; border: 1px solid #dee2e6;">${grade.total_packages.toLocaleString()}</td>
<td style="padding: 8px; border: 1px solid #dee2e6;">${grade.total_weight_kg.toLocaleString()}</td>
<td style="padding: 8px; border: 1px solid #dee2e6;">${grade.percentage_of_offering}%</td>
</tr>
`).join('')}
</tbody>
</table>
</div>
</div>
` : ''}

<!-- Price Analysis -->
${priceAnalysis.by_grade ? `
<div style="background: white; padding: 15px; border-radius: 5px; margin: 15px 0;">
<h4>Price Analysis by Grade</h4>
<div style="overflow-x: auto;">
<table style="width: 100%; border-collapse: collapse;">
<thead>
<tr style="background: #f8f9fa;">
<th style="padding: 8px; border: 1px solid #dee2e6;">Grade</th>
<th style="padding: 8px; border: 1px solid #dee2e6;">Average Price</th>
<th style="padding: 8px; border: 1px solid #dee2e6;">Highest Price</th>
<th style="padding: 8px; border: 1px solid #dee2e6;">Lowest Price</th>
<th style="padding: 8px; border: 1px solid #dee2e6;">Lots</th>
</tr>
</thead>
<tbody>
${Object.entries(priceAnalysis.by_grade).map(([grade, priceData]) => `
<tr>
<td style="padding: 8px; border: 1px solid #dee2e6;"><strong>${grade}</strong></td>
<td style="padding: 8px; border: 1px solid #dee2e6;">${priceData.average}</td>
<td style="padding: 8px; border: 1px solid #dee2e6;">${priceData.highest}</td>
<td style="padding: 8px; border: 1px solid #dee2e6;">${priceData.lowest}</td>
<td style="padding: 8px; border: 1px solid #dee2e6;">${priceData.lot_count}</td>
</tr>
`).join('')}
</tbody>
</table>
</div>
</div>
` : ''}

<!-- Weather Analysis -->
${weatherAnalysis.current_conditions ? `
<div style="background: white; padding: 15px; border-radius: 5px; margin: 15px 0;">
<h4>Weather & Seasonal Analysis</h4>
<p><strong>Current Conditions:</strong> ${weatherAnalysis.current_conditions}</p>
<p><strong>Impact Assessment:</strong> ${weatherAnalysis.impact_assessment}</p>
<p><strong>Seasonal Outlook:</strong> ${weatherAnalysis.seasonal_outlook}</p>
</div>
` : ''}

<!-- Market Forecast -->
${forecastAnalysis.supply_dynamics ? `
<div style="background: white; padding: 15px; border-radius: 5px; margin: 15px 0;">
<h4>Market Forecast & Outlook</h4>
<p><strong>Supply Dynamics:</strong> ${forecastAnalysis.supply_dynamics}</p>
<p><strong>Price Trends:</strong> ${forecastAnalysis.price_trends}</p>
<p><strong>Demand Indicators:</strong> ${forecastAnalysis.demand_indicators}</p>
<p><strong>Market Opportunities:</strong> ${forecastAnalysis.opportunities}</p>
</div>
` : ''}

<!-- Commentary -->
<div style="background: white; padding: 15px; border-radius: 5px; margin: 15px 0;">
<h4>Market Commentary</h4>
<p>${summary.market_comment || summary.commentary_synthesized || 'Dynamic market commentary based on current auction data and trading patterns.'}</p>
</div>

<div style="margin-top: 30px;">
<h3>Report Status: Complete ‚úÖ</h3>
<p>üìä This comprehensive report includes market intelligence, volume analysis, price trends, and forecast insights.</p>
<p>üîç Data sources: ${data.metadata?.source_files?.length || 1} file(s) processed</p>
<p>‚è∞ Generated: ${data.metadata?.generated_at || 'Recently'}</p>
</div>
</div>
`;

document.getElementById('loading-message').style.display = 'none';
document.getElementById('report-details').innerHTML = reportHtml;
document.getElementById('report-details').style.display = 'block';
}
</script>
</body>
</html>
