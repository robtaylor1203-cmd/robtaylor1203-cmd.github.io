<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market Report Viewer - TeaTrade</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="market-reports-page">
    <header class="site-header">
        <div class="header-top-bar">
            <a href="corporate.html" class="header-logo"><h1>Tea<span>Trade</span></h1></a>
            <div class="header-search-wrapper"><input type="text" class="header-search-bar" placeholder="Global site search..."></div>
            <div class="user-actions">
                <a href="#" title="Create Account"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><line x1="20" y1="8" x2="20" y2="14"></line><line x1="17" y1="11" x2="23" y2="11"></line></svg></a>
                <a href="#" title="Sign In"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path><polyline points="10 17 15 12 10 7"></polyline><line x1="15" y1="12" x2="3" y2="12"></line></svg></a>
            </div>
            <button class="mobile-menu-toggle" aria-label="Toggle navigation" aria-expanded="false">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
            </button>
        </div>
        <nav class="secondary-nav">
            <ul>
                <li><a href="data.html">Data</a></li>
                <li><a href="market-reports.html" class="active">Market Reports</a></li>
                <li><a href="#">Auctions</a></li>
                <li><a href="visuals.html">Visuals</a></li>
            </ul>
        </nav>
    </header>

    <main class="page-container">
        <div class="dashboard-header">
            <h2 class="page-title" id="report-title">Loading Report...</h2>
        </div>
        <p id="report-meta" style="margin-bottom: 24px; color: #5f6368;"></p>

        <div id="report-content" style="display: none;">
            
            <section class="report-section" id="overview-section" style="display: none;">
                <h3>Auction Overview</h3>
                <div class="stat-cards-container" id="summary-stats"></div>
                
                <div class="overview-grid">
                    <div class="commentary-block">
                        <h4>Market Synopsis</h4>
                        <p id="market-comment"></p>
                        <p id="quality-wrapper" style="display: none;"><strong>Quality:</strong> <span id="quality-comment"></span></p>
                    </div>
                    <div class="highest-prices-block" id="highest-prices-wrapper" style="display: none;">
                        <h4>Highest Achieved Prices</h4>
                        <table class="data-table compact-table" id="highest-prices-table">
                            <thead>
                                <tr>
                                    <th>Price</th>
                                    <th>Grade</th>
                                    <th>Mark (Factory)</th>
                                    <th>Country</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section class="report-section" id="price-analysis-mark-section" style="display: none;">
                <div class="dashboard-header" style="margin-bottom: 16px; align-items: baseline;">
                     <h3 id="price-analysis-mark-title">Price Analysis by Factory (Mark)</h3>
                     <div class="page-search-wrapper" style="margin-bottom: 0; padding-bottom: 0; border-bottom: none;">
                        <input type="text" id="factory-search-bar" class="page-search-bar" placeholder="Search by Factory Name or Group...">
                    </div>
                </div>
               
                 <div class="data-table-container">
                    <table class="data-table stats-table" id="price-analysis-mark-table">
                        <thead>
                            <tr>
                                <th rowspan="2" class="header-main">Group</th>
                                <th rowspan="2" class="header-main">Mark (Factory)</th>
                                <th colspan="3" class="header-main" style="text-align: center; border-left: 2px solid #dadce0;">BP1</th>
                                <th colspan="3" class="header-main" style="text-align: center; border-left: 2px solid #dadce0;">PF1</th>
                            </tr>
                            <tr>
                                <th class="header-sub" style="border-left: 2px solid #dadce0;">Previous</th>
                                <th class="header-sub">Low</th>
                                <th class="header-sub">High</th>
                                <th class="header-sub" style="border-left: 2px solid #dadce0;">Previous</th>
                                <th class="header-sub">Low</th>
                                <th class="header-sub">High</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </section>

            <section class="report-section" id="global-stats-section" style="display: none;">
                <h3>Global Statistics</h3>
                </section>

            <section class="report-section" id="volume-visualization-section" style="display: none;">
                <h3>Volume & Activity Analysis</h3>
                <div class="distribution-container" id="volume-visualization-container">
                    <div class="distribution-block" id="offerings-chart-block" style="display: none;">
                        <h4>Offerings Breakdown (kg)</h4>
                        <div style="position: relative; height: 300px;"><canvas id="offeringsChart"></canvas></div>
                    </div>
                    <div class="distribution-block" id="country-chart-block" style="display: none;">
                         <h4>Offered vs Sold by Country (kg)</h4>
                        <div style="position: relative; height: 300px;"><canvas id="countryChart"></canvas></div>
                    </div>
                    <div class="distribution-block" id="buyer-chart-block" style="display: none;">
                         <h4>Buyer Market Share (%)</h4>
                        <div style="position: relative; height: 350px;"><canvas id="buyerChart"></canvas></div>
                    </div>
                </div>
            </section>

            <section class="report-section" id="commentary-grid-section" style="display: none;">
                 <h3>Market Synopsis & Buying Analysis</h3>
                <div class="commentary-grid" id="commentary-container"></div>
            </section>

            <section class="report-section" id="buyer-activity-section" style="display: none;">
                <h3>Buyer Activity (Sold Volume)</h3>
                 <div class="data-table-container">
                    <table class="data-table stats-table" id="buyer-activity-table">
                        <thead>
                            </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </section>

            <section class="report-section" id="quantity-comparison-section" style="display: none;">
                <h3>Quantity Sold Comparison (kg)</h3>
                 <div class="data-table-container">
                    <table class="data-table stats-table" id="quantity-comparison-table">
                        <thead></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </section>

            <section class="report-section" id="auction-offerings-multi-section" style="display: none;">
                 <h3>Auction Offerings Comparison</h3>
                 <div class="comparison-grid" id="auction-offerings-multi-container"></div>
            </section>

            <section class="report-section" id="offerings-grade-section" style="display: none;">
                <h3 id="offerings-grade-title">Auction Offerings</h3>
                <div class="data-table-container">
                    <table class="data-table" id="offerings-grade-table">
                        <thead></thead>
                        <tbody></tbody>
                        <tfoot></tfoot>
                    </table>
                </div>
            </section>

            <section class="report-section" id="country-breakdown-section" style="display: none;">
                <h3>Offerings vs. Sold (by Country)</h3>
                <div class="comparison-grid" id="country-breakdown-tables">
                    </div>
            </section>

            <section class="report-section" id="prices-section" style="display: none;">
                <h3 id="price-quotations-title">Price Quotations</h3>
                <div class="data-table-container">
                    <table class="data-table" id="prices-table">
                        <thead></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </section>

            <section class="report-section" id="averages-analysis-section" style="display: none;">
                <h3 id="averages-analysis-title">Auction Averages Analysis</h3>
                 <div class="data-table-container">
                    <table class="data-table stats-table" id="averages-analysis-table">
                        <thead></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </section>

            <section class="report-section" id="averages-comparison-section" style="display: none;">
                <h3 id="averages-title">Auction Averages Comparison</h3>
                 <div class="data-table-container">
                    <table class="data-table stats-table" id="averages-table">
                        <thead></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </section>

            <section class="report-section" id="price-distribution-section" style="display: none;">
                 <h3 id="price-distribution-title">Price Distribution Analysis (% of Teas Sold)</h3>
                 <div class="distribution-container" id="distribution-container"></div>
            </section>

            <section class="report-section" id="detailed-stats-section" style="display: none;">
                <h3>Detailed Offer/Sold Statistics</h3>
                </section>

            <section class="report-section" id="international-section" style="display: none;">
                <h3>International Summaries</h3>
                <div id="international-container"></div>
            </section>

        </div>
        <div id="loading-indicator">Loading data...</div>
    </main>
    <script src="script.js"></script>
    
    <script>
        // --- Configuration ---
        const CHART_COLORS = {
            primary: 'rgba(26, 115, 232, 0.8)', // Blue
            secondary: 'rgba(128, 178, 247, 0.8)', // Lighter Blue
            accent1: 'rgba(251, 188, 4, 0.8)', 
            accent_green: 'rgba(52, 168, 83, 0.8)', // Renamed from accent2 for clarity
            neutral: 'rgba(160, 160, 160, 0.8)'
        };

        // Standard color palette for Pie/Doughnut charts (e.g., Buyer Activity)
        const PIE_COLORS = [
            '#1a73e8', '#34a853', '#fbbc05', '#ea4335', '#9b59b6', 
            '#3498db', '#16a085', '#f39c12', '#d35400', '#7f8c8d',
            '#2c3e50', '#8e44ad', '#c0392b', '#27ae60', '#2980b9'
        ];

        const CHART_OPTIONS_BAR = {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: { display: true, text: 'Value' }
                },
                x: {
                    ticks: { autoSkip: false, maxRotation: 45, minRotation: 45 }
                }
            },
            plugins: { legend: { display: false } }
        };

        const CHART_OPTIONS_PIE = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { 
                legend: { 
                    display: true,
                    position: 'right',
                } 
            }
        };


        // --- Utility Functions ---
        const formatNumber = (num, decimals = 0) => {
            // Ensure input is parsed as a float before checking NaN
            const parsedNum = parseFloat(num);
            if (num === null || num === undefined || isNaN(parsedNum)) return 'N/A';
            return parsedNum.toLocaleString(undefined, { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
        };

        const formatCurrency = (num) => formatNumber(num, 2);

        const formatPriceRange = (min, max) => {
             // Handle cases where one value might be null (e.g., Limbe "Best 185")
             if ((min === null || min === undefined) && (max === null || max === undefined)) return 'N/A';
             if (max === null || max === undefined) return formatCurrency(min);
             if (min === null || min === undefined) return formatCurrency(max);
             return `${formatCurrency(min)} - ${formatCurrency(max)}`;
        }

        const formatDiff = (num, decimals = 2) => {
            if (num === null || num === undefined) return 'N/A';
            const formatted = formatNumber(num, decimals);
            const className = num > 0 ? 'diff-positive' : (num < 0 ? 'diff-negative' : '');
             // Add +/- sign explicitly for non-zero values
            const sign = num > 0 ? '+' : ''; 
            return `<span class="${className}">${sign}${formatted}</span>`;
        }

        // --- Rendering Functions (Modularized by Data Type) ---

        // Renderer for Global Statistics (Contemporary Brokers style)
        const renderGlobalStatistics = (globalStats, meta) => {
            if (!globalStats || Object.keys(globalStats).length === 0) return;

            const section = document.getElementById('global-stats-section');
            section.style.display = 'block';

            // World Crop Comparison
            if (globalStats.world_crop_comparison) {
                const comparison = globalStats.world_crop_comparison;
                const wrapper = document.createElement('div');
                wrapper.style.marginBottom = '24px';
                wrapper.innerHTML = `<h4>World Crop Comparison (M.Kg)</h4>`;

                // Visualization
                const chartWrapper = document.createElement('div');
                chartWrapper.className = 'distribution-block';
                chartWrapper.style.marginBottom = '16px';
                const canvasId = 'worldCropChart';
                chartWrapper.innerHTML = `<div style="position: relative; height: 350px;"><canvas id="${canvasId}"></canvas></div>`;
                section.appendChild(chartWrapper); // Append chart directly to section

                const ctx = chartWrapper.querySelector(`#${canvasId}`).getContext('2d');
                // Filter out the total row for the chart data, include major regions
                const chartData = comparison.filter(item => item.region !== 'TOTAL' && item.region !== 'ALL INDIA');
                const labels = chartData.map(item => item.region);
                const currentYearValues = chartData.map(item => item.current_year_todate);
                const previousYearValues = chartData.map(item => item.previous_year_todate);

                const options = JSON.parse(JSON.stringify(CHART_OPTIONS_BAR));
                options.scales.y.title.text = 'Volume (M.Kg) To Date';
                options.plugins.legend.display = true;

                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: `${meta.year-1} To Date`,
                                data: previousYearValues,
                                backgroundColor: CHART_COLORS.secondary,
                            },
                            {
                                label: `${meta.year} To Date`,
                                data: currentYearValues,
                                backgroundColor: CHART_COLORS.primary,
                            }
                        ]
                    },
                    options: options
                });

                // Table
                const tableContainer = document.createElement('div');
                tableContainer.className = 'data-table-container';
                
                const table = document.createElement('table');
                table.className = 'data-table stats-table';
                
                // Header
                table.innerHTML = `
                    <thead>
                        <tr>
                            <th rowspan="2" class="header-main">Region</th>
                            <th rowspan="2" class="header-main">Month</th>
                            <th colspan="2" class="header-main">${meta.year}</th>
                            <th colspan="2" class="header-main">${meta.year-1}</th>
                            <th rowspan="2" class="header-main">+/- To Date</th>
                        </tr>
                        <tr>
                            <th class="header-sub">Monthly</th>
                            <th class="header-sub">To Date</th>
                            <th class="header-sub">Monthly</th>
                            <th class="header-sub">To Date</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                `;
                
                const tbody = table.querySelector('tbody');
                comparison.forEach(item => {
                    const row = document.createElement('tr');
                     if (item.region === "TOTAL" || item.region === "ALL INDIA") {
                        row.style.fontWeight = 'bold';
                        row.style.backgroundColor = '#f1f3f4';
                    }
                    row.innerHTML = `
                        <td>${item.region}</td>
                        <td>${item.month || ''}</td>
                        <td>${formatNumber(item.current_year_monthly, 1)}</td>
                        <td>${formatNumber(item.current_year_todate, 1)}</td>
                        <td>${formatNumber(item.previous_year_monthly, 1)}</td>
                        <td>${formatNumber(item.previous_year_todate, 1)}</td>
                        <td>${formatDiff(item.difference_todate, 1)}</td>
                    `;
                    tbody.appendChild(row);
                });
                
                tableContainer.appendChild(table);
                wrapper.appendChild(tableContainer);
                section.appendChild(wrapper);
            }
        };


        // Renderer for General Overview (Stat Cards, Market Comment, Highest Prices)
        const renderOverview = (summary, highestPrices, currency) => {
            if (!summary) return;
            
            // Use the dedicated Overview section
            document.getElementById('overview-section').style.display = 'block';
            const statsContainer = document.getElementById('summary-stats');
            statsContainer.innerHTML = ''; // Clear previous content

            const stats = [
                { label: 'Total Quantity (kg)', value: summary.total_quantity_kg, format: 0 },
                { label: 'Total Packages', value: summary.total_packages, format: 0 },
                { label: 'Total Lots', value: summary.total_lots, format: 0 },
                { label: '% Unsold', value: summary.percent_unsold, format: 2, suffix: '%' },
            ];

            stats.forEach(stat => {
                if (stat.value !== undefined && stat.value !== null) {
                    const card = document.createElement('div');
                    card.className = 'stat-card';
                    card.innerHTML = `
                        <span class="stat-value">${formatNumber(stat.value, stat.format)}${stat.suffix || ''}</span>
                        <span class="stat-label">${stat.label}</span>
                    `;
                    statsContainer.appendChild(card);
                }
            });

            if (summary.market_comment) {
                 document.getElementById('market-comment').textContent = summary.market_comment;
            }
           
            if (summary.quality_comment) {
                document.getElementById('quality-wrapper').style.display = 'block';
                document.getElementById('quality-comment').textContent = summary.quality_comment;
            }

             // Highest Prices Table (Mombasa/Jakarta specific)
            if (highestPrices && highestPrices.length > 0) {
                document.getElementById('highest-prices-wrapper').style.display = 'block';
                const tbody = document.getElementById('highest-prices-table').querySelector('tbody');
                tbody.innerHTML = '';
                highestPrices.forEach(item => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${formatCurrency(item.price)}</td>
                        <td>${item.grade}</td>
                        <td>${item.mark}</td>
                        <td>${item.country || ''}</td>
                    `;
                    tbody.appendChild(row);
                });
            }
        };

        // NEW RENDERER: Price Analysis by Mark (Mombasa Specific)
        const renderPriceAnalysisByMark = (analysisData, currency) => {
            if (!analysisData || analysisData.length === 0) return;

            const section = document.getElementById('price-analysis-mark-section');
            section.style.display = 'block';
            // Update title with currency
            document.getElementById('price-analysis-mark-title').textContent = `Price Analysis by Factory (Mark) (${currency})`;

            const tbody = document.getElementById('price-analysis-mark-table').querySelector('tbody');
            
            const renderTableRows = (data) => {
                tbody.innerHTML = '';
                data.forEach(item => {
                    const row = document.createElement('tr');

                    // We use formatCurrency which handles nulls/undefined and formats appropriately
                    row.innerHTML = `
                        <td>${item.group}</td>
                        <td>${item.mark}</td>
                        <td style="border-left: 2px solid #dadce0;">${formatCurrency(item.BP1_previous)}</td>
                        <td>${formatCurrency(item.BP1_low)}</td>
                        <td>${formatCurrency(item.BP1_high)}</td>
                        <td style="border-left: 2px solid #dadce0;">${formatCurrency(item.PF1_previous)}</td>
                        <td>${formatCurrency(item.PF1_low)}</td>
                        <td>${formatCurrency(item.PF1_high)}</td>
                    `;
                    tbody.appendChild(row);
                });
            };

            // Initial render
            renderTableRows(analysisData);

            // Add search functionality
            const searchInput = document.getElementById('factory-search-bar');
            // Use 'input' event for live filtering
            searchInput.addEventListener('input', () => {
                const searchTerm = searchInput.value.toLowerCase();
                const filteredData = analysisData.filter(item => 
                    (item.mark && item.mark.toLowerCase().includes(searchTerm)) || 
                    (item.group && item.group.toLowerCase().includes(searchTerm))
                );
                renderTableRows(filteredData);
            });
        };


        // Renderer for Multi-Center Auction Offerings (Contemporary Brokers style)
        const renderAuctionOfferingsMultiCenter = (offeringsData, meta) => {
             if (!offeringsData || Object.keys(offeringsData).length === 0) return;

             const section = document.getElementById('auction-offerings-multi-section');
             const container = document.getElementById('auction-offerings-multi-container');
             section.style.display = 'block';

             const renderOfferingsTable = (data, title, metric = "Packages") => {
                 if (!data || data.length === 0) return;

                 const wrapper = document.createElement('div');
                wrapper.style.marginBottom = '24px';
                wrapper.innerHTML = `<h4>${title} (${metric})</h4>`;
                
                const tableContainer = document.createElement('div');
                tableContainer.className = 'data-table-container';
                
                const table = document.createElement('table');
                table.className = 'data-table stats-table';
                
                // Header
                table.innerHTML = `
                    <thead>
                        <tr>
                            <th rowspan="2" class="header-main">Type</th>
                            <th colspan="2" class="header-main">This Week</th>
                            <th colspan="2" class="header-main">To Date</th>
                        </tr>
                        <tr>
                            <th class="header-sub">${meta.year}</th>
                            <th class="header-sub">${meta.year-1}</th>
                            <th class="header-sub">${meta.year}</th>
                            <th class="header-sub">${meta.year-1}</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                `;
                
                const tbody = table.querySelector('tbody');
                data.forEach(item => {
                    const row = document.createElement('tr');
                     if (item.type === "Total") {
                        row.style.fontWeight = 'bold';
                        row.style.backgroundColor = '#f1f3f4';
                    }
                    row.innerHTML = `
                        <td>${item.type}</td>
                        <td>${formatNumber(item.current_weekly)}</td>
                        <td>${formatNumber(item.previous_weekly)}</td>
                        <td>${formatNumber(item.current_todate)}</td>
                        <td>${formatNumber(item.previous_todate)}</td>
                    `;
                    tbody.appendChild(row);
                });
                
                tableContainer.appendChild(table);
                wrapper.appendChild(tableContainer);
                container.appendChild(wrapper);
             };

             // Render tables for each center found in the data
             for (const [center, data] of Object.entries(offeringsData)) {
                 renderOfferingsTable(data, center);
             }
        };


        // Renderer for Offerings by Grade/Category (Colombo/Mombasa style)
        const renderOfferingsByGrade = (data) => {
            const offerings = data.offerings || data.offerings_by_grade;
            const summary = data.summary;

            if (!offerings || offerings.length === 0) return;

            document.getElementById('offerings-grade-section').style.display = 'block';
            const table = document.getElementById('offerings-grade-table');
            const thead = table.querySelector('thead');
            const tbody = table.querySelector('tbody');
            const tfoot = table.querySelector('tfoot');
            tbody.innerHTML = '';
            tfoot.innerHTML = '';

            const hasLots = offerings.some(item => item.lots !== undefined);
            const hasPackages = offerings.some(item => item.packages !== undefined);
            const hasUnsold = offerings.some(item => item.percent_unsold !== undefined && item.percent_unsold !== null);

            if (hasLots) {
                 document.getElementById('offerings-grade-title').textContent = "Auction Offerings (by Category)";
            } else if (hasPackages) {
                 document.getElementById('offerings-grade-title').textContent = "Auction Offerings (by Grade Type)";
            }

            let headerHtml = '<tr><th>Category</th>';
            if (hasLots) headerHtml += '<th>Lots</th>';
            if (hasPackages) headerHtml += '<th>Packages</th>';
            headerHtml += '<th>Quantity (kg)</th>';
            if (hasUnsold) headerHtml += '<th>Unsold (%)</th>';
            headerHtml += '</tr>';
            thead.innerHTML = headerHtml;

            offerings.forEach(item => {
                let rowHtml = `<tr><td>${item.category}</td>`;
                if (hasLots) rowHtml += `<td>${formatNumber(item.lots)}</td>`;
                if (hasPackages) rowHtml += `<td>${formatNumber(item.packages)}</td>`;
                rowHtml += `<td>${formatNumber(item.quantity_kg)}</td>`;
                if (hasUnsold) rowHtml += `<td>${formatNumber(item.percent_unsold, 2)}%</td>`;
                rowHtml += '</tr>';
                tbody.innerHTML += rowHtml;
            });

            if (summary) {
                let footCells = [`<td>TOTAL</td>`];
                if (hasLots && summary.total_lots) footCells.push(`<td>${formatNumber(summary.total_lots)}</td>`);
                if (hasPackages && summary.total_packages) footCells.push(`<td>${formatNumber(summary.total_packages)}</td>`);
                
                if (summary.total_quantity_kg) footCells.push(`<td>${formatNumber(summary.total_quantity_kg)}</td>`);
                
                // Only show total unsold % if the column exists AND the summary value is defined/not null
                if (hasUnsold && summary.percent_unsold !== undefined && summary.percent_unsold !== null) {
                    footCells.push(`<td>${formatNumber(summary.percent_unsold, 2)}%</td>`);
                } else if (hasUnsold) {
                    // If the column exists but the total is missing, add an empty cell for alignment
                    footCells.push(`<td></td>`);
                }

                 tfoot.innerHTML = `<tr style="font-weight: bold; background-color: #f1f3f4;">${footCells.join('')}</tr>`;

                if (summary.reprints_lots || summary.reprints_quantity_kg) {
                     // Handle reprints display
                     let reprintHtml = `<tr style="font-style: italic; color: #5f6368;"><td>Re-Prints</td>`;
                     
                     if (hasLots) reprintHtml += `<td>${formatNumber(summary.reprints_lots)}</td>`;
                     // If packages column exists, we need to check if reprint packages are provided or just align
                     if (hasPackages) {
                        reprintHtml += `<td>${formatNumber(summary.reprints_packages) || (hasLots ? 'N/A' : '')}</td>`;
                     }
                     
                     reprintHtml += `<td>${formatNumber(summary.reprints_quantity_kg)}</td>`;

                     if (hasUnsold) {
                        reprintHtml += `<td></td>`;
                     }
                     reprintHtml += `</tr>`;
                     tfoot.innerHTML += reprintHtml;
                }
            }

            // Render Visualization
            document.getElementById('volume-visualization-section').style.display = 'block';
            document.getElementById('offerings-chart-block').style.display = 'block';
            const ctx = document.getElementById('offeringsChart').getContext('2d');
            
            const labels = offerings.map(item => item.category);
            const values = offerings.map(item => item.quantity_kg);

            const options = JSON.parse(JSON.stringify(CHART_OPTIONS_BAR)); 
            options.scales.y.title.text = 'Quantity (kg)';

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Quantity (kg)',
                        data: values,
                        backgroundColor: CHART_COLORS.primary,
                    }]
                },
                options: options
            });
        };

        // Renderer for Offerings by Country (Mombasa/Jakarta style)
        const renderOfferingsByCountry = (countryData, meta) => {
            if (!countryData || Object.keys(countryData).length === 0) return;
            
            document.getElementById('country-breakdown-section').style.display = 'block';
            const container = document.getElementById('country-breakdown-tables');
            container.innerHTML = '';

            const years = Object.keys(countryData).sort((a, b) => b - a);

            years.forEach(year => {
                const data = countryData[year];
                if (!data || data.length === 0) return;

                const wrapper = document.createElement('div');
                wrapper.innerHTML = `<h4>Year ${year}</h4>`;
                
                const tableContainer = document.createElement('div');
                tableContainer.className = 'data-table-container';

                const table = document.createElement('table');
                table.className = 'data-table';
                table.innerHTML = `
                    <thead>
                        <tr>
                            <th>Country</th>
                            <th>Offered (Pkg)</th>
                            <th>Sold (Pkg)</th>
                            <th>Offered (Kg)</th>
                            <th>Sold (Kg)</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                `;
                
                const tbody = table.querySelector('tbody');
                data.forEach(item => {
                    tbody.innerHTML += `
                        <tr>
                            <td>${item.country}</td>
                            <td>${formatNumber(item.offered_packages)}</td>
                            <td>${formatNumber(item.sold_packages)}</td>
                            <td>${formatNumber(item.offered_kg)}</td>
                            <td>${formatNumber(item.sold_kg)}</td>
                        </tr>
                    `;
                });
                
                tableContainer.appendChild(table);
                wrapper.appendChild(tableContainer);
                container.appendChild(wrapper);
            });

            // Render Visualization
            // Ensure meta.year exists before trying to access data[meta.year]
            const currentYearData = meta.year ? countryData[meta.year] : null;
            if (currentYearData) {
                document.getElementById('volume-visualization-section').style.display = 'block';
                document.getElementById('country-chart-block').style.display = 'block';
                const ctx = document.getElementById('countryChart').getContext('2d');

                const labels = currentYearData.map(item => item.country);
                const offeredValues = currentYearData.map(item => item.offered_kg);
                // Handle potentially null sold values gracefully
                const soldValues = currentYearData.map(item => item.sold_kg || 0);

                const options = JSON.parse(JSON.stringify(CHART_OPTIONS_BAR));
                options.scales.y.title.text = 'Quantity (kg)';
                options.plugins.legend.display = true;

                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Offered (kg)',
                                data: offeredValues,
                                backgroundColor: CHART_COLORS.secondary,
                            },
                            {
                                label: 'Sold (kg)',
                                data: soldValues,
                                backgroundColor: CHART_COLORS.accent_green, // Using green for sold/activity
                            }
                        ]
                    },
                    options: options
                });
            }
        };

        // Renderer for Price Quotations (Colombo/Mombasa/Jakarta/Limbe style)
        const renderPriceQuotations = (quotations, currency) => {
            if (!quotations || quotations.length === 0) return;

            document.getElementById('prices-section').style.display = 'block';
            document.getElementById('price-quotations-title').textContent = `Price Quotations (${currency}/kg)`;

            const table = document.getElementById('prices-table');
            const thead = table.querySelector('thead');
            const tbody = table.querySelector('tbody');
            tbody.innerHTML = '';

            const hasElevation = quotations.some(item => item.elevation !== undefined);
            const hasCategory = quotations.some(item => item.category !== undefined);
            const hasPrevious = quotations.some(item => item.previous_min !== undefined || item.previous_max !== undefined);
            
            let headerHtml = '<tr>';
            if (hasElevation) headerHtml += '<th>Elevation</th>';
            if (hasCategory) headerHtml += '<th>Category/Region</th>';
            headerHtml += '<th>Grade</th><th>Current (Low-High)</th>';
            if (hasPrevious) headerHtml += '<th>Previous (Low-High)</th>';
            headerHtml += '</tr>';
            thead.innerHTML = headerHtml;

            quotations.forEach(item => {
                let rowHtml = '<tr>';
                if (hasElevation) rowHtml += `<td>${item.elevation}</td>`;
                if (hasCategory) rowHtml += `<td>${item.category}</td>`;
                rowHtml += `<td>${item.grade}</td><td>${formatPriceRange(item.current_min, item.current_max)}</td>`;
                if (hasPrevious) rowHtml += `<td>${formatPriceRange(item.previous_min, item.previous_max)}</td>`;
                rowHtml += '</tr>';
                tbody.innerHTML += rowHtml;
            });
        };
        
        // Renderer for Commentary Grid (Kolkata/Contemporary style)
        const renderCommentaryGrid = (commentary) => {
            if (!commentary || Object.keys(commentary).length === 0) return;

            document.getElementById('commentary-grid-section').style.display = 'block';
            const container = document.getElementById('commentary-container');
            container.innerHTML = '';

            for (const category in commentary) {
                const item = commentary[category];
                // Handle both detailed (market/buying) and simple (just text string) structures
                
                let marketText = null;
                let buyingText = null;

                if (typeof item === 'string') {
                    // Simple structure (e.g., Contemporary Buying Commentary)
                    marketText = item;
                } else if (typeof item === 'object' && item !== null) {
                     // Detailed structure (e.g., J Thomas Commentary)
                    marketText = item.market;
                    buyingText = item.buying;
                }

                if (marketText || buyingText) {
                    const card = document.createElement('div');
                    card.className = 'commentary-card';
                    let contentHtml = `<h4>${category}</h4>`;
                    // If it's the detailed structure, label the sections
                    if (buyingText) {
                        if (marketText) contentHtml += `<p><strong>Market:</strong> ${marketText}</p>`;
                        contentHtml += `<p><strong>Buying:</strong> ${buyingText}</p>`;
                    } else {
                        // Otherwise just display the text
                         contentHtml += `<p>${marketText}</p>`;
                    }
                    
                    card.innerHTML = contentHtml;
                    container.appendChild(card);
                }
            }
        };

        // Renderer for Auction Averages Comparison (Kolkata/Contemporary Brokers style)
        const renderAveragesComparison = (comparison, meta) => {
            if (!comparison || comparison.length === 0) return;
            
            document.getElementById('averages-comparison-section').style.display = 'block';
            document.getElementById('averages-title').textContent = `Auction Averages Comparison (${meta.currency}/kg)`;

            const table = document.getElementById('averages-table');
            const thead = table.querySelector('thead');
            const tbody = table.querySelector('tbody');
            tbody.innerHTML = '';

            // Detect format: Kolkata (J Thomas) vs Contemporary Brokers
            // Assuming 'current_sale_avg_25_26' is specific to the J Thomas format based on previous context
            const isJThomasFormat = comparison.some(item => item.hasOwnProperty('current_sale_avg_25_26'));
            
            if (isJThomasFormat) {
                // J Thomas Format (Multi-level Header)
                // Assuming 2025/26 structure based on previous context
                if (!meta.sale_number) return; // This format requires a sale number

                thead.innerHTML = `
                    <thead>
                        <tr>
                            <th rowspan="2" class="header-main">Category</th>
                            <th colspan="3" class="header-main">Current Sale (2025/26)</th>
                            <th colspan="3" class="header-main">To Date Averages</th>
                        </tr>
                        <tr>
                            <th class="header-sub">Avg (S${meta.sale_number})</th>
                            <th class="header-sub">Avg (S${meta.sale_number - 1})</th>
                            <th class="header-sub">+/-</th>
                            <th class="header-sub">2025/26</th>
                            <th class="header-sub">2024/25</th>
                            <th class="header-sub">2023/24</th>
                        </tr>
                    </thead>
                `;

                comparison.forEach(item => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${item.category}</td>
                        <td>${formatCurrency(item.current_sale_avg_25_26)}</td>
                        <td>${formatCurrency(item.previous_sale_avg_25_26)}</td>
                        <td>${formatDiff(item.diff_25_26)}</td>
                        <td>${formatCurrency(item.ytd_avg_25_26)}</td>
                        <td>${formatCurrency(item.ytd_avg_24_25)}</td>
                        <td>${formatCurrency(item.ytd_avg_23_24)}</td>
                    `;
                    tbody.appendChild(row);
                });
            } else {
                // Contemporary Brokers Format (Simple comparison across centers)
                 thead.innerHTML = `
                    <thead>
                        <tr>
                            <th class="header-main">Centre</th>
                            <th class="header-main">Type</th>
                            <th class="header-main">Current Avg (${meta.year})</th>
                            <th class="header-main">Previous Avg (${meta.year-1})</th>
                            <th class="header-main">Difference</th>
                        </tr>
                    </thead>
                `;

                comparison.forEach(item => {
                    const row = document.createElement('tr');
                     if (item.type === "ALL") {
                        row.style.fontWeight = 'bold';
                        row.style.backgroundColor = '#f8f9fa';
                    }
                    row.innerHTML = `
                        <td>${item.centre}</td>
                        <td>${item.type}</td>
                        <td>${formatCurrency(item.current_avg)}</td>
                        <td>${formatCurrency(item.previous_avg)}</td>
                        <td>${formatDiff(item.difference)}</td>
                    `;
                    tbody.appendChild(row);
                });
            }
        };

         // Renderer for Price Distribution (Kolkata/Contemporary style)
        const renderPriceDistribution = (distribution, meta) => {
            if (!distribution || Object.keys(distribution).length === 0) return;

            document.getElementById('price-distribution-section').style.display = 'block';
            const container = document.getElementById('distribution-container');
            container.innerHTML = '';

            // Determine if this is J Thomas (single sale comparison) or Contemporary (multi-period comparison)
            // We check the keys within the first data point of the first category.
            const firstCategory = Object.values(distribution)[0];
            const firstDataPoint = firstCategory ? Object.values(firstCategory)[0] : {};

            // J Thomas format uses Sale_X, Contemporary uses Sale_X (for week) AND YTD_YY_YY
            // Assuming 'YTD_25_26' is the key for the current YTD based on context.
            const isJThomasFormat = meta.sale_number && firstDataPoint.hasOwnProperty(`Sale_${meta.sale_number}`) && !firstDataPoint.hasOwnProperty('YTD_25_26');
            const isContemporaryFormat = firstDataPoint.hasOwnProperty('YTD_25_26'); 


            if (isJThomasFormat) {
                 // J Thomas Format
                document.getElementById('price-distribution-title').textContent = `Price Distribution Analysis (% Sold) - Sale ${meta.sale_number}`;
            } else if (isContemporaryFormat) {
                // Contemporary Format
                 document.getElementById('price-distribution-title').textContent = `Price Distribution Analysis (% Sold) - Week ${meta.week_number} vs YTD`;
            }
           

            for (const [category, ranges] of Object.entries(distribution)) {
                 if (!ranges || Object.keys(ranges).length === 0) continue;

                const chartWrapper = document.createElement('div');
                chartWrapper.className = 'distribution-block';

                const canvasId = `chart-${category.replace(/[^a-zA-Z0-9]/g, '-')}`;
                // Adjust height slightly if it's a multi-bar chart for better readability
                const chartHeight = (isContemporaryFormat) ? 280 : 250;
                chartWrapper.innerHTML = `<h4>${category.replace(/_/g, ' ')}</h4><div style="position: relative; height: ${chartHeight}px;"><canvas id="${canvasId}"></canvas></div>`;
                container.appendChild(chartWrapper);

                const ctx = document.getElementById(canvasId).getContext('2d');
                const labels = Object.keys(ranges);
                
                const datasets = [];

                if (isJThomasFormat) {
                    // J Thomas (Single Bar)
                    const currentSaleKey = `Sale_${meta.sale_number}`;
                    const values = Object.values(ranges).map(r => r[currentSaleKey]);
                    datasets.push({
                        label: `Sale ${meta.sale_number}`,
                        data: values,
                        backgroundColor: CHART_COLORS.primary,
                    });
                } else if (isContemporaryFormat) {
                    // Contemporary (Grouped Bar)
                    const currentWeekKey = `Sale_${meta.week_number}`;
                    const currentYTDKey = 'YTD_25_26';
                    const previousYTDKey = 'YTD_24_25';

                    const currentWeekValues = Object.values(ranges).map(r => r[currentWeekKey]);
                    const currentYTDValues = Object.values(ranges).map(r => r[currentYTDKey]);
                    const previousYTDValues = Object.values(ranges).map(r => r[previousYTDKey]);


                    datasets.push({
                        label: `YTD ${meta.year-1}`,
                        data: previousYTDValues,
                        backgroundColor: CHART_COLORS.neutral,
                    });
                     datasets.push({
                        label: `YTD ${meta.year}`,
                        data: currentYTDValues,
                        backgroundColor: CHART_COLORS.secondary,
                    });
                    datasets.push({
                        label: `Week ${meta.week_number}`,
                        data: currentWeekValues,
                        backgroundColor: CHART_COLORS.primary,
                    });
                   
                }

                // Use the reusable options and customize
                const options = JSON.parse(JSON.stringify(CHART_OPTIONS_BAR));
                options.scales.y.title.text = 'Percentage (%)';
                // Show legend if there are multiple datasets (grouped bar)
                if (datasets.length > 1) {
                    options.plugins.legend.display = true;
                }

                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: datasets
                    },
                    options: options
                });
            }
        };

        // Renderer for Detailed Offer/Sold Statistics (Kolkata style)
        const renderDetailedStatistics = (statistics, meta) => {
            if (!statistics || Object.keys(statistics).length === 0) return;
            if (!meta.sale_number) return; // Requires sale number for headers

            const section = document.getElementById('detailed-stats-section');
            section.style.display = 'block';

             const renderDetailTable = (details, title) => {
                if (!details || details.length === 0) return;

                const wrapper = document.createElement('div');
                wrapper.style.marginBottom = '24px';
                wrapper.innerHTML = `<h4>${title} Details</h4>`;
                
                const tableContainer = document.createElement('div');
                tableContainer.className = 'data-table-container';
                
                const table = document.createElement('table');
                table.className = 'data-table stats-table';
                
                // Complex Multi-level Header
                table.innerHTML = `
                    <thead>
                        <tr>
                            <th rowspan="2" class="header-main">Grade</th>
                            <th colspan="4" class="header-main" style="text-align: center; border-left: 2px solid #dadce0;">This Sale (S${meta.sale_number})</th>
                            <th colspan="4" class="header-main" style="text-align: center; border-left: 2px solid #dadce0;">Last Sale (S${meta.sale_number-1})</th>
                            <th colspan="4" class="header-main" style="text-align: center; border-left: 2px solid #dadce0;">To Date</th>
                        </tr>
                        <tr>
                            <th class="header-sub" style="border-left: 2px solid #dadce0;">Offered (kg)</th><th class="header-sub">Sold (kg)</th><th class="header-sub">Avg (${meta.currency})</th><th class="header-sub">Out %</th>
                            <th class="header-sub" style="border-left: 2px solid #dadce0;">Offered (kg)</th><th class="header-sub">Sold (kg)</th><th class="header-sub">Avg (${meta.currency})</th><th class="header-sub">Out %</th>
                            <th class="header-sub" style="border-left: 2px solid #dadce0;">Offered (kg)</th><th class="header-sub">Sold (kg)</th><th class="header-sub">Avg (${meta.currency})</th><th class="header-sub">Out %</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                `;
                
                const tbody = table.querySelector('tbody');
                details.forEach(item => {
                    const row = document.createElement('tr');
                    if (item.Grade.includes("TOTAL")) {
                        row.style.fontWeight = 'bold';
                        row.style.backgroundColor = '#f1f3f4';
                    }
                    row.innerHTML = `
                        <td>${item.Grade}</td>
                        <td style="border-left: 2px solid #dadce0;">${formatNumber(item.This_Sale.Offered)}</td>
                        <td>${formatNumber(item.This_Sale.Sold)}</td>
                        <td>${formatCurrency(item.This_Sale.Average)}</td>
                        <td>${formatNumber(item.This_Sale.Out_Percent)}%</td>
                        <td style="border-left: 2px solid #dadce0;">${formatNumber(item.Last_Sale.Offered)}</td>
                        <td>${formatNumber(item.Last_Sale.Sold)}</td>
                        <td>${formatCurrency(item.Last_Sale.Average)}</td>
                        <td>${formatNumber(item.Last_Sale.Out_Percent)}%</td>
                        <td style="border-left: 2px solid #dadce0;">${formatNumber(item.To_Date.Offered)}</td>
                        <td>${formatNumber(item.To_Date.Sold)}</td>
                        <td>${formatCurrency(item.To_Date.Average)}</td>
                        <td>${formatNumber(item.To_Date.Out_Percent)}%</td>
                    `;
                    tbody.appendChild(row);
                });
                
                tableContainer.appendChild(table);
                wrapper.appendChild(tableContainer);
                section.appendChild(wrapper);
            };

            if (statistics.CTC_Dust) renderDetailTable(statistics.CTC_Dust, "CTC & Dust");
            if (statistics.Orthodox) renderDetailTable(statistics.Orthodox, "Orthodox");
            if (statistics.Darjeeling) renderDetailTable(statistics.Darjeeling, "Darjeeling");
        };
        
        // Renderer for Quantity Sold Comparison (Asia Siyaka style)
        const renderQuantityComparison = (comparison, meta) => {
             if (!comparison || comparison.length === 0) return;

            document.getElementById('quantity-comparison-section').style.display = 'block';
            const table = document.getElementById('quantity-comparison-table');
            const thead = table.querySelector('thead');
            const tbody = table.querySelector('tbody');
            tbody.innerHTML = '';

            // Header (Assumes Current Year vs Previous Year)
            const currentYear = meta.year;
            const previousYear = currentYear - 1;

            thead.innerHTML = `
                <thead>
                    <tr>
                        <th rowspan="2" class="header-main">Category</th>
                        <th colspan="2" class="header-main">${currentYear}</th>
                        <th colspan="2" class="header-main">${previousYear}</th>
                    </tr>
                    <tr>
                        <th class="header-sub">Weekly</th>
                        <th class="header-sub">To Date</th>
                        <th class="header-sub">Weekly</th>
                        <th class="header-sub">To Date</th>
                    </tr>
                </thead>
            `;

            comparison.forEach(item => {
                const row = document.createElement('tr');
                 if (item.category.includes("Total")) {
                        row.style.fontWeight = 'bold';
                        row.style.backgroundColor = '#f1f3f4';
                    }
                row.innerHTML = `
                    <td>${item.category}</td>
                    <td>${formatNumber(item.weekly_current_year)}</td>
                    <td>${formatNumber(item.todate_current_year)}</td>
                    <td>${formatNumber(item.weekly_previous_year)}</td>
                    <td>${formatNumber(item.todate_previous_year)}</td>
                `;
                tbody.appendChild(row);
            });
        };

         // Renderer for International Summaries (Specific to Colombo)
        const renderInternationalSummaries = (summaries) => {
             const section = document.getElementById('international-section');
             const container = document.getElementById('international-container');

            if (!summaries || summaries.length === 0) return;
            
            section.style.display = 'block';
            container.innerHTML = '';

             summaries.forEach(summary => {
                    const summaryDiv = document.createElement('div');
                    summaryDiv.className = 'international-summary-item';

                    let contentHtml = `<h4>${summary.centre} (Sale ${summary.sale_no || 'N/A'})</h4>
                                       <p style="font-size: 13px; color: #5f6368;">${summary.date || ''}</p>
                                       <p>${summary.summary || 'Summary not available.'}</p>`;
                    
                    if (summary.structured_data && summary.structured_data.currency) {
                        contentHtml += `<p><strong>Quotations (${summary.structured_data.currency}):</strong></p>`;
                        
                        const renderTable = (grades, title) => {
                            if (!grades || grades.length === 0) return '';
                            let tableHtml = `<div class="data-table-container" style="margin-bottom: 16px; max-width: 500px;">
                                             <p style="font-weight: 500; margin-bottom: 8px;">${title}</p>
                                             <table class="data-table">
                                             <thead><tr><th>Category</th><th>Grade</th><th>Low</th><th>High</th></tr></thead><tbody>`;
                            grades.forEach(grade => {
                                tableHtml += `<tr>
                                                <td>${grade.category}</td>
                                                <td>${grade.grade}</td>
                                                <td>${formatNumber(grade.low, 2)}</td>
                                                <td>${formatNumber(grade.high, 2)}</td>
                                              </tr>`;
                            });
                            tableHtml += `</tbody></table></div>`;
                            return tableHtml;
                        };

                        contentHtml += renderTable(summary.structured_data.ctc_leaf_grades, "CTC Leaf");
                        contentHtml += renderTable(summary.structured_data.ctc_dust_grades, "CTC Dust");
                    }

                    summaryDiv.innerHTML = contentHtml;
                    container.appendChild(summaryDiv);
                });
        };

        // Renderer for Buyer Activity (Mombasa/Limbe style)
        const renderBuyerActivity = (activityData) => {
            if (!activityData || activityData.length === 0) return;

            // Check if detailed data (Volume, Packages or Market Share) exists
            const hasVolume = activityData.some(item => item.volume_kg);
            const hasPackages = activityData.some(item => item.packages);
            const hasShare = activityData.some(item => item.market_share_percent);

            // If only buyer names are present without stats (as in the initial W34 data), we check if any data exists.
            // If no quantitative data exists, we skip rendering the section entirely.
             if (!hasVolume && !hasPackages && !hasShare) {
                // Note: We used to render a list of names here, but it provides little value without stats.
                // We now skip rendering the section entirely if no quantitative data is present.
                return;
            }

            document.getElementById('buyer-activity-section').style.display = 'block';
            
            // 1. Render Table (Sorted by volume)
            const sortedData = [...activityData].sort((a, b) => (b.volume_kg || 0) - (a.volume_kg || 0));
            const table = document.getElementById('buyer-activity-table');
            const thead = table.querySelector('thead');
            const tbody = table.querySelector('tbody');
            tbody.innerHTML = '';

            // Adjust Headers based on data availability
            let headerHtml = '<tr><th>Buyer</th>';
            if (hasPackages) headerHtml += '<th>Packages</th>';
            if (hasVolume) headerHtml += '<th>Quantity (kg)</th>';
            if (hasShare) headerHtml += '<th>Market Share (%)</th>';
            headerHtml += '</tr>';
            thead.innerHTML = headerHtml;

            sortedData.forEach(item => {
                let rowHtml = `<tr><td>${item.buyer}</td>`;
                if (hasPackages) rowHtml += `<td>${formatNumber(item.packages)}</td>`;
                if (hasVolume) rowHtml += `<td>${formatNumber(item.volume_kg)}</td>`;
                if (hasShare) rowHtml += `<td>${formatNumber(item.market_share_percent, 2)}%</td>`;
                rowHtml += '</tr>';
                tbody.innerHTML += rowHtml;
            });

            // 2. Render Pie Chart (If share data is available)
            if (hasShare) {
                document.getElementById('volume-visualization-section').style.display = 'block';
                document.getElementById('buyer-chart-block').style.display = 'block';
                const ctx = document.getElementById('buyerChart').getContext('2d');
                
                // Prepare data for the chart: Focus on top N and group others
                const topN = 10;
                let dataPoints = [];
                let labels = [];

                if (sortedData.length > topN) {
                    const topData = sortedData.slice(0, topN);
                    const othersData = sortedData.slice(topN);
                    const othersTotalShare = othersData.reduce((sum, item) => sum + (item.market_share_percent || 0), 0);

                    labels = topData.map(item => item.buyer);
                    dataPoints = topData.map(item => item.market_share_percent);
                    
                    if (othersTotalShare > 0) {
                        labels.push("Others");
                        dataPoints.push(othersTotalShare);
                    }
                } else {
                    labels = sortedData.map(item => item.buyer);
                    dataPoints = sortedData.map(item => item.market_share_percent);
                }

                new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Market Share (%)',
                            data: dataPoints,
                            backgroundColor: PIE_COLORS,
                        }]
                    },
                    options: CHART_OPTIONS_PIE
                });
            }
        };

        // Renderer for Averages Analysis (Limbe Style)
        const renderAveragesAnalysis = (analysis, currency) => {
            if (!analysis || analysis.length === 0) return;

            document.getElementById('averages-analysis-section').style.display = 'block';
            document.getElementById('averages-analysis-title').textContent = `Auction Averages Analysis (${currency}/kg)`;
            
            const table = document.getElementById('averages-analysis-table');
            const thead = table.querySelector('thead');
            const tbody = table.querySelector('tbody');
            tbody.innerHTML = '';

             thead.innerHTML = `
                <tr>
                    <th>Category</th>
                    <th>Current Sale Avg</th>
                    <th>Previous Sale Avg</th>
                    <th>Difference</th>
                </tr>
            `;

            analysis.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.category}</td>
                    <td>${formatCurrency(item.current_average)}</td>
                    <td>${formatCurrency(item.previous_average)}</td>
                    <td>${formatDiff(item.difference)}</td>
                `;
                tbody.appendChild(row);
            });
        };


        // Main Report Rendering Logic (Orchestration)
        const renderReport = (data) => {
            const meta = data.metadata;

            // 1. Metadata and Title
            // Use specific report title if available (e.g., Contemporary), otherwise generate standard title
            const titlePrefix = meta.report_title || `${meta.auction_centre || meta.region} Auction Report`;
            document.getElementById('report-title').textContent = `${titlePrefix} - Week ${meta.week_number} (${meta.year})`;
            
            let metaText = `Broker: ${meta.broker || 'Consolidated'}`;
            if (meta.sale_number) metaText += ` | Sale No: ${meta.sale_number}`;
            
            // Determine the best date representation
            const startDate = meta.sale_date_start;
            const endDate = meta.sale_date_end || meta.date_end;

            if (startDate && endDate && startDate !== endDate) {
                metaText += ` | Dates: ${startDate} to ${endDate}`;
            } else if (endDate) {
                 metaText += ` | Date: ${endDate}`;
            }

            if (meta.currency) {
                metaText += ` | Currency: ${meta.currency}`;
            }
            document.getElementById('report-meta').textContent = metaText;

            // 2. Overview (Stat Cards, Summary, Highest Prices)
            // This combines the previous renderGeneralSummary into a more comprehensive overview renderer
            renderOverview(data.summary, data.highest_achieved_prices, meta.currency);

            // 3. NEW: Price Analysis by Mark (Mombasa Specific)
            renderPriceAnalysisByMark(data.price_analysis_by_mark, meta.currency);

            // 4. Global Statistics (e.g., Contemporary World Crop)
            renderGlobalStatistics(data.global_statistics, meta);

            // 5. Commentary Grid (If applicable, e.g. Kolkata)
            if (data.commentary) {
                renderCommentaryGrid(data.commentary);
            } 

            // 6. Offerings and Volume Analysis (Tables and Charts)
            renderOfferingsByGrade(data);
            renderOfferingsByCountry(data.offerings_by_country, meta);
           
            // 7. Buyer Activity
            renderBuyerActivity(data.buyer_activity);

            // 8. Prices and Statistics
            renderPriceQuotations(data.price_quotations, meta.currency);
            renderAveragesAnalysis(data.averages_analysis, meta.currency);
            
            // Handle statistical summaries (Kolkata/Asia Siyaka/Contemporary style)
            if (data.statistical_summaries) {
                const stats = data.statistical_summaries;
                renderAveragesComparison(stats.auction_averages_comparison, meta);
                renderPriceDistribution(stats.price_distribution_analysis, meta);
                renderDetailedStatistics(stats.offer_sold_statistics, meta);
                renderQuantityComparison(stats.quantity_sold_comparison, meta);
                renderAuctionOfferingsMultiCenter(stats.auction_offerings_packages, meta);
            }
            
            // 9. International Summaries
            renderInternationalSummaries(data.international_summaries);
        };

        // --- Data Loading ---
        document.addEventListener('DOMContentLoaded', async () => {
            // Initialize mobile menu toggle (ensure script.js is loaded and defines this function)
             if (typeof initializeMobileMenu === 'function') {
                initializeMobileMenu();
            }
            
            const params = new URLSearchParams(window.location.search);
            const datasetFile = params.get('dataset');
            
            if (!datasetFile) {
                document.getElementById('report-title').textContent = 'Error: No report selected.';
                document.getElementById('loading-indicator').style.display = 'none';
                return;
            }

            try {
                // CRITICAL UPDATE: Fetch data from the Data/Consolidated/ directory
                const response = await fetch(`Data/Consolidated/${datasetFile}.json`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const reportData = await response.json();
                
                // Orchestrate the rendering
                renderReport(reportData);
                
                document.getElementById('loading-indicator').style.display = 'none';
                document.getElementById('report-content').style.display = 'block';

            } catch (error) {
                console.error('Error fetching report data:', error);
                document.getElementById('report-title').textContent = 'Error loading report.';
                // Updated error message to reflect the new directory structure
                document.getElementById('loading-indicator').textContent = `Could not load the dataset: ${datasetFile}.json. Ensure the file exists in Data/Consolidated/. Error: ${error.message}`;
            }
        });
    </script>
</body>
</html>