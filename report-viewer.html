<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market Report Viewer - TeaTrade</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="market-reports-page">
    <header class="site-header">
        <div class="header-top-bar">
            <a href="corporate.html" class="header-logo"><h1>Tea<span>Trade</span></h1></a>
            <div class="header-search-wrapper"><input type="text" class="header-search-bar" placeholder="Global site search..."></div>
            <div class="user-actions">
                <a href="#" title="Create Account"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><line x1="20" y1="8" x2="20" y2="14"></line><line x1="17" y1="11" x2="23" y2="11"></line></svg></a>
                <a href="#" title="Sign In"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path><polyline points="10 17 15 12 10 7"></polyline><line x1="15" y1="12" x2="3" y2="12"></line></svg></a>
            </div>
            <button class="mobile-menu-toggle" aria-label="Toggle navigation" aria-expanded="false">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
            </button>
        </div>
        <nav class="secondary-nav">
            <ul>
                <li><a href="data.html">Data</a></li>
                <li><a href="market-reports.html" class="active">Market Reports</a></li>
                <li><a href="#">Auctions</a></li>
                <li><a href="visuals.html">Visuals</a></li>
            </ul>
        </nav>
    </header>

    <main class="page-container">
        <div class="dashboard-header">
            <h2 class="page-title" id="report-title">Loading Report...</h2>
        </div>
        <p id="report-meta" style="margin-bottom: 24px; color: #5f6368;"></p>

        <div id="report-content" style="display: none;">
            
            <div class="stat-cards-container" id="summary-stats"></div>

            <section class="report-section" id="global-stats-section" style="display: none;">
                <h3>Global Statistics</h3>
                </section>

            <section class="report-section" id="volume-visualization-section" style="display: none;">
                <h3>Volume Analysis</h3>
                <div class="distribution-container" id="volume-visualization-container">
                    <div class="distribution-block" id="offerings-chart-block" style="display: none;">
                        <h4>Offerings Breakdown (kg)</h4>
                        <div style="position: relative; height: 300px;"><canvas id="offeringsChart"></canvas></div>
                    </div>
                    <div class="distribution-block" id="country-chart-block" style="display: none;">
                         <h4>Offered vs Sold by Country (kg)</h4>
                        <div style="position: relative; height: 300px;"><canvas id="countryChart"></canvas></div>
                    </div>
                </div>
            </section>

            <section class="report-section" id="summary-section" style="display: none;">
                <h3>Market Commentary</h3>
                <p id="market-comment"></p>
                <p id="quality-wrapper" style="display: none;"><strong>Quality:</strong> <span id="quality-comment"></span></p>
            </section>

            <section class="report-section" id="commentary-grid-section" style="display: none;">
                 <h3>Market Synopsis & Buying Analysis</h3>
                <div class="commentary-grid" id="commentary-container"></div>
            </section>

            <section class="report-section" id="quantity-comparison-section" style="display: none;">
                <h3>Quantity Sold Comparison (kg)</h3>
                 <div class="data-table-container">
                    <table class="data-table stats-table" id="quantity-comparison-table">
                        <thead></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </section>

            <section class="report-section" id="auction-offerings-multi-section" style="display: none;">
                 <h3>Auction Offerings Comparison</h3>
                 <div class="comparison-grid" id="auction-offerings-multi-container"></div>
            </section>

            <section class="report-section" id="offerings-grade-section" style="display: none;">
                <h3 id="offerings-grade-title">Auction Offerings</h3>
                <div class="data-table-container">
                    <table class="data-table" id="offerings-grade-table">
                        <thead></thead>
                        <tbody></tbody>
                        <tfoot></tfoot>
                    </table>
                </div>
            </section>

            <section class="report-section" id="country-breakdown-section" style="display: none;">
                <h3>Offerings vs. Sold (by Country)</h3>
                <div class="comparison-grid" id="country-breakdown-tables">
                    </div>
            </section>

            <section class="report-section" id="prices-section" style="display: none;">
                <h3 id="price-quotations-title">Price Quotations</h3>
                <div class="data-table-container">
                    <table class="data-table" id="prices-table">
                        <thead></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </section>

            <section class="report-section" id="averages-comparison-section" style="display: none;">
                <h3 id="averages-title">Auction Averages Comparison</h3>
                 <div class="data-table-container">
                    <table class="data-table stats-table" id="averages-table">
                        <thead></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </section>

            <section class="report-section" id="price-distribution-section" style="display: none;">
                 <h3 id="price-distribution-title">Price Distribution Analysis (% of Teas Sold)</h3>
                 <div class="distribution-container" id="distribution-container"></div>
            </section>

            <section class="report-section" id="detailed-stats-section" style="display: none;">
                <h3>Detailed Offer/Sold Statistics</h3>
                </section>

            <section class="report-section" id="international-section" style="display: none;">
                <h3>International Summaries</h3>
                <div id="international-container"></div>
            </section>

        </div>
        <div id="loading-indicator">Loading data...</div>
    </main>
    <script src="script.js"></script>
    <script>
        // --- Configuration ---
        const CHART_COLORS = {
            primary: 'rgba(26, 115, 232, 0.8)', // Blue
            secondary: 'rgba(128, 178, 247, 0.8)', // Lighter Blue
            accent1: 'rgba(251, 188, 4, 0.8)', 
            accent2: 'rgba(52, 168, 83, 0.8)', 
            neutral: 'rgba(160, 160, 160, 0.8)'
        };

        const CHART_OPTIONS_BAR = {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: { display: true, text: 'Value' }
                },
                x: {
                    ticks: { autoSkip: false, maxRotation: 45, minRotation: 45 }
                }
            },
            plugins: { legend: { display: false } }
        };

        // --- Utility Functions ---
        const formatNumber = (num, decimals = 0) => {
            if (num === null || num === undefined || isNaN(num)) return 'N/A';
            return num.toLocaleString(undefined, { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
        };

        const formatCurrency = (num) => formatNumber(num, 2);

        const formatPriceRange = (min, max) => {
             if ((min === null || min === undefined) && (max === null || max === undefined)) return 'N/A';
             return `${formatNumber(min, 2)} - ${formatNumber(max, 2)}`;
        }

        const formatDiff = (num, decimals = 2) => {
            if (num === null || num === undefined) return 'N/A';
            const formatted = formatNumber(num, decimals);
            const className = num > 0 ? 'diff-positive' : (num < 0 ? 'diff-negative' : '');
             // Add +/- sign explicitly for non-zero values
            const sign = num > 0 ? '+' : ''; 
            return `<span class="${className}">${sign}${formatted}</span>`;
        }

        // --- Rendering Functions (Modularized by Data Type) ---

         // Renderer for Price Distribution (Kolkata/Contemporary Brokers style) - VERIFIED LOGIC
        const renderPriceDistribution = (distribution, meta) => {
            if (!distribution || Object.keys(distribution).length === 0) return;

            document.getElementById('price-distribution-section').style.display = 'block';
            const container = document.getElementById('distribution-container');
            container.innerHTML = '';

            // --- Key Detection Logic ---
            const firstCategory = Object.values(distribution)[0];
            // Handle case where category might be empty
            if (!firstCategory) return; 

            const firstRange = Object.values(firstCategory)[0];
             // Handle case where range might be empty
            if (!firstRange) return;
            
            // Determine the primary identifier (Sale Number or Week Number)
            const saleIdentifier = meta.sale_number || meta.week_number;

            // 1. Identify specific keys based on metadata (for precise week-over-week comparison)
            let currentSaleKey = saleIdentifier ? `Sale_${saleIdentifier}` : null;
            let previousSaleKey = (saleIdentifier && saleIdentifier > 1) ? `Sale_${saleIdentifier - 1}` : null;

            // Check if these specific keys actually exist in the data
            if (currentSaleKey && !firstRange.hasOwnProperty(currentSaleKey)) currentSaleKey = null;
            // We only care if the previous key exists if the current one also does (for this specific comparison type)
            if (previousSaleKey && (!currentSaleKey || !firstRange.hasOwnProperty(previousSaleKey))) previousSaleKey = null;

            
            // 2. Identify generic keys (for fallback or reports without specific numbering)
            // Use the specific key if found, otherwise look for any 'Sale_' key.
            const genericSaleKey = currentSaleKey ? currentSaleKey : Object.keys(firstRange).find(k => k.startsWith('Sale_'));
            
            // 3. Identify YTD Keys (Handles variations like 2025_26 or YTD_25_26)
            // Ensure meta.year is available before attempting to generate keys
            let ytdCurrentKey = null;
            let ytdPreviousKey = null;

            if (meta.year) {
                ytdCurrentKey = Object.keys(firstRange).find(k => k.includes(`${meta.year%100}_${(meta.year+1)%100}`) || k.includes(`${meta.year}_${meta.year+1}`));
                ytdPreviousKey = Object.keys(firstRange).find(k => k.includes(`${(meta.year-1)%100}_${meta.year%100}`) || k.includes(`${meta.year-1}_${meta.year}`));
            }


            // --- Prioritization Logic ---
            let prioritizedKeys = [];
            
            // Priority 1: Specific Weekly Comparison (e.g., J Thomas: Sale 32 vs Sale 31)
            // Requires both current and previous specific keys to be present.
            if (currentSaleKey && previousSaleKey) {
                prioritizedKeys.push({ key: previousSaleKey, label: previousSaleKey.replace('_', ' '), color: CHART_COLORS.secondary });
                prioritizedKeys.push({ key: currentSaleKey, label: currentSaleKey.replace('_', ' '), color: CHART_COLORS.primary });
            } 
            // Priority 2: Multi-period comparison (e.g., Contemporary: Sale 34 vs YTDs)
            else if (genericSaleKey && (ytdCurrentKey || ytdPreviousKey)) {
                 if (ytdPreviousKey) {
                     prioritizedKeys.push({ key: ytdPreviousKey, label: ytdPreviousKey.replace(/_/g, '/').replace('YTD/', ''), color: CHART_COLORS.neutral });
                 }
                 if (ytdCurrentKey) {
                      prioritizedKeys.push({ key: ytdCurrentKey, label: ytdCurrentKey.replace(/_/g, '/').replace('YTD/', ''), color: CHART_COLORS.secondary });
                 }
                 // The current sale/week is the primary focus
                 prioritizedKeys.push({ key: genericSaleKey, label: genericSaleKey.replace('_', ' '), color: CHART_COLORS.primary });
            }
            // Priority 3: Single period display
            else {
                const keyToUse = genericSaleKey || ytdCurrentKey || ytdPreviousKey;
                if (keyToUse) {
                     prioritizedKeys.push({ key: keyToUse, label: keyToUse.replace(/_/g, ' ').replace('YTD/', ''), color: CHART_COLORS.primary });
                }
            }

            if (prioritizedKeys.length === 0) {
                console.warn("No recognized keys found for Price Distribution data.");
                return;
            }

            const visualizationType = prioritizedKeys.length > 1 ? 'comparison' : 'single';

            // Update Title
            let titleText = "Price Distribution Analysis (% of Teas Sold)";
            if (visualizationType === 'single' && prioritizedKeys[0].key.startsWith('Sale_')) {
                 titleText += ` - ${prioritizedKeys[0].label}`;
            }
            document.getElementById('price-distribution-title').textContent = titleText;


            // --- Rendering Loop ---
            for (const [category, ranges] of Object.entries(distribution)) {
                 if (!ranges || Object.keys(ranges).length === 0) continue;

                const chartWrapper = document.createElement('div');
                chartWrapper.className = 'distribution-block';

                const canvasId = `chart-${category.replace(/[^a-zA-Z0-9]/g, '-')}`;
                chartWrapper.innerHTML = `<h4>${category.replace(/_/g, ' ')}</h4><div style="position: relative; height: 250px;"><canvas id="${canvasId}"></canvas></div>`;
                container.appendChild(chartWrapper);

                const ctx = document.getElementById(canvasId).getContext('2d');
                const labels = Object.keys(ranges);
                
                let datasets = [];

                // Build datasets using prioritized keys
                prioritizedKeys.forEach(pKey => {
                    // Safety check: Ensure the key exists in the specific range data before mapping
                    const dataPoints = labels.map(label => {
                        const rangeData = ranges[label];
                        return (rangeData && rangeData[pKey.key] !== undefined) ? rangeData[pKey.key] : null;
                    });

                    // Only add the dataset if it contains non-null data
                    if (dataPoints.some(dp => dp !== null)) {
                        datasets.push({
                            label: pKey.label,
                            data: dataPoints,
                            backgroundColor: pKey.color,
                        });
                    }
                });

                if (datasets.length === 0) continue;

                new Chart(ctx, {
                    type: 'bar',
                    data: { labels: labels, datasets: datasets },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: { display: true, text: 'Percentage (%)' },
                                max: 100 // Percentage scale
                            },
                            x: {
                                title: { display: true, text: 'Price Range (INR)' }
                            }
                        },
                        plugins: { 
                            legend: { 
                                display: visualizationType === 'comparison', // Show legend only for comparisons
                                position: 'top'
                            } 
                        }
                    }
                });
            }
        };


        // Renderer for Global Statistics (e.g., World Crop Comparison) - VERIFIED LOGIC
        const renderGlobalStatistics = (globalStats) => {
            if (!globalStats || !globalStats.world_crop_comparison || globalStats.world_crop_comparison.length === 0) return;

            const section = document.getElementById('global-stats-section');
            section.style.display = 'block';
            
            const title = document.createElement('h4');
            title.textContent = 'World Crop Comparison (M.Kg)';
            section.appendChild(title);

            const tableContainer = document.createElement('div');
            tableContainer.className = 'data-table-container';
            
            const table = document.createElement('table');
            table.className = 'data-table stats-table'; // Apply stats-table for right alignment

            // Header (Dynamic Year detection)
            const currentYear = new Date().getFullYear(); // Fallback year
            // Assuming the first entry has valid data for comparison structure if available
            const comparisonData = globalStats.world_crop_comparison[0];

            // Determine column headers based on available data keys
            let headers = ['Region', 'Month'];
            if (comparisonData.hasOwnProperty('current_year_todate')) headers.push(`${currentYear} (YTD)`);
            if (comparisonData.hasOwnProperty('previous_year_todate')) headers.push(`${currentYear-1} (YTD)`);
            if (comparisonData.hasOwnProperty('difference_todate')) headers.push('Difference');

            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            headers.forEach((headerText, index) => {
                const th = document.createElement('th');
                th.className = 'header-main';
                // Left align Region and Month
                if (index < 2) th.style.textAlign = 'left'; 
                th.textContent = headerText;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);

            const tbody = document.createElement('tbody');

            globalStats.world_crop_comparison.forEach(item => {
                const row = document.createElement('tr');
                
                // Region (Left aligned)
                const tdRegion = document.createElement('td');
                tdRegion.textContent = item.region;
                row.appendChild(tdRegion);

                // Month (Left aligned)
                const tdMonth = document.createElement('td');
                tdMonth.textContent = item.month || 'N/A';
                row.appendChild(tdMonth);

                // Data columns (Right aligned by CSS class 'stats-table')
                if (item.hasOwnProperty('current_year_todate')) {
                    const tdCY = document.createElement('td');
                    tdCY.textContent = formatNumber(item.current_year_todate, 1);
                    row.appendChild(tdCY);
                }
                
                if (item.hasOwnProperty('previous_year_todate')) {
                    const tdPY = document.createElement('td');
                    tdPY.textContent = formatNumber(item.previous_year_todate, 1);
                    row.appendChild(tdPY);
                }

                if (item.hasOwnProperty('difference_todate')) {
                     const tdDiff = document.createElement('td');
                    tdDiff.innerHTML = formatDiff(item.difference_todate, 1);
                    row.appendChild(tdDiff);
                }

                // Style the TOTAL row
                if (item.region.toUpperCase() === 'TOTAL') {
                    row.style.fontWeight = 'bold';
                    row.style.backgroundColor = '#f1f3f4';
                }

                tbody.appendChild(row);
            });

            table.appendChild(tbody);
            tableContainer.appendChild(table);
            section.appendChild(tableContainer);
        };


        // Renderer for Auction Averages Comparison (Kolkata Style) - VERIFIED LOGIC
        const renderAveragesComparison = (averages, metadata) => {
            if (!averages || averages.length === 0) return;

            document.getElementById('averages-comparison-section').style.display = 'block';
            const table = document.getElementById('averages-table');
            const tbody = table.querySelector('tbody');
            tbody.innerHTML = '';

            const sale_num = metadata.sale_number;
            const current_year = metadata.year;
            
            // Determine if we have enough data for detailed comparison vs simple YTD
            const hasDetailedWeekly = averages[0].hasOwnProperty('current_week_avg') && averages[0].hasOwnProperty('previous_week_avg');

            // Header
            let headerHTML = `<tr><th class="header-main" style="text-align: left;">Category</th>`;

            if (hasDetailedWeekly && sale_num) {
                 headerHTML += `<th class="header-main" colspan="3">${current_year} Weekly Comparison</th>`;
                 headerHTML += `<th class="header-main" colspan="3">${current_year-1} Weekly Comparison</th>`;
            }
            
            headerHTML += `<th class="header-main" colspan="3">Year-to-Date Averages</th></tr>`;
            
            // Sub-Header
            headerHTML += `<tr><th class="header-sub"></th>`;

            if (hasDetailedWeekly && sale_num) {
                // Current Year Weekly
                headerHTML += `<th class="header-sub">Sale ${sale_num}</th><th class="header-sub">Sale ${sale_num-1}</th><th class="header-sub">+/-</th>`;
                // Previous Year Weekly
                headerHTML += `<th class="header-sub">Sale ${sale_num}</th><th class="header-sub">Sale ${sale_num-1}</th><th class="header-sub">+/-</th>`;
            }

            // YTD
            // Use the years provided in the data if available, otherwise calculate
            const ytd_years = averages[0].ytd_years || [current_year, current_year-1, current_year-2];
            headerHTML += `<th class="header-sub">${ytd_years[0]}</th><th class="header-sub">${ytd_years[1]}</th><th class="header-sub">${ytd_years[2]}</th></tr>`;

            table.querySelector('thead').innerHTML = headerHTML;

            // Body
            averages.forEach(item => {
                let rowHTML = `<tr><td>${item.category}</td>`;

                if (hasDetailedWeekly && sale_num) {
                    // Current Year Weekly
                    rowHTML += `<td>${formatCurrency(item.current_week_avg)}</td>`;
                    rowHTML += `<td>${formatCurrency(item.previous_week_avg)}</td>`;
                    rowHTML += `<td>${formatDiff(item.weekly_difference)}</td>`;
                    // Previous Year Weekly
                    rowHTML += `<td>${formatCurrency(item.prev_year_current_week_avg)}</td>`;
                    rowHTML += `<td>${formatCurrency(item.prev_year_previous_week_avg)}</td>`;
                    rowHTML += `<td>${formatDiff(item.prev_year_weekly_difference)}</td>`;
                }

                // YTD
                rowHTML += `<td>${formatCurrency(item.ytd_avg_current)}</td>`;
                rowHTML += `<td>${formatCurrency(item.ytd_avg_prev1)}</td>`;
                rowHTML += `<td>${formatCurrency(item.ytd_avg_prev2)}</td></tr>`;
                
                tbody.innerHTML += rowHTML;
            });
        };

        
        // Renderer for Market Synopsis/Buying Analysis Grid (Kolkata Style) - VERIFIED LOGIC
        const renderCommentaryGrid = (synopsis) => {
            if (!synopsis || Object.keys(synopsis).length === 0) return;

            const container = document.getElementById('commentary-container');
            container.innerHTML = '';
            let isEmpty = true;

            for (const [category, content] of Object.entries(synopsis)) {
                // Check if there is meaningful content before rendering the block
                if ((content.market_report && content.market_report.trim() !== '') || 
                    (content.buying_analysis && content.buying_analysis.trim() !== '')) {
                    
                    isEmpty = false;
                    const block = document.createElement('div');
                    block.className = 'commentary-block';

                    let blockHTML = `<h4>${category}</h4>`;
                    
                    if (content.market_report && content.market_report.trim() !== '') {
                        blockHTML += `<p><strong>Market Report:</strong> ${content.market_report}</p>`;
                    }
                    if (content.buying_analysis && content.buying_analysis.trim() !== '') {
                         blockHTML += `<p><strong>Buying Analysis:</strong> ${content.buying_analysis}</p>`;
                    }

                    block.innerHTML = blockHTML;
                    container.appendChild(block);
                }
            }

            if (!isEmpty) {
                document.getElementById('commentary-grid-section').style.display = 'block';
            }
        };


        // Renderer for Quantity Sold Comparison (Colombo Style) - VERIFIED LOGIC
        const renderQuantityComparison = (comparison, metadata) => {
            if (!comparison || comparison.length === 0) return;

            document.getElementById('quantity-comparison-section').style.display = 'block';
            const table = document.getElementById('quantity-comparison-table');
            const tbody = table.querySelector('tbody');
            tbody.innerHTML = '';

            const current_year = metadata.year;

            // Header
            table.querySelector('thead').innerHTML = `
                <tr>
                    <th class="header-main" rowspan="2" style="text-align: left;">Channel</th>
                    <th class="header-main" colspan="2">${current_year}</th>
                    <th class="header-main" colspan="2">${current_year-1}</th>
                </tr>
                <tr>
                    <th class="header-sub">Weekly</th>
                    <th class="header-sub">To Date</th>
                    <th class="header-sub">Weekly</th>
                    <th class="header-sub">To Date</th>
                </tr>
            `;

            // Body
            comparison.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.channel}</td>
                    <td>${formatNumber(item.current_year_weekly)}</td>
                    <td>${formatNumber(item.current_year_todate)}</td>
                    <td>${formatNumber(item.previous_year_weekly)}</td>
                    <td>${formatNumber(item.previous_year_todate)}</td>
                `;

                // Style the Total row
                if (item.channel.toLowerCase() === 'total') {
                    row.style.fontWeight = 'bold';
                    row.style.backgroundColor = '#f1f3f4';
                }

                tbody.appendChild(row);
            });
        };

        
        // Renderer for Offerings by Grade (Mombasa/Colombo Style) - VERIFIED LOGIC
        const renderOfferingsByGrade = (offerings, metadata) => {
            if (!offerings || offerings.length === 0) return;

            document.getElementById('offerings-grade-section').style.display = 'block';
            const table = document.getElementById('offerings-grade-table');
            const tbody = table.querySelector('tbody');
            const tfoot = table.querySelector('tfoot');
            tbody.innerHTML = '';
            tfoot.innerHTML = '';

            // Determine Headers based on available data keys (Lots/Pkgs and Quantity)
            let headers = ['Category'];
            const firstItem = offerings[0];
            
            if (firstItem.hasOwnProperty('lots')) headers.push('Lots');
            if (firstItem.hasOwnProperty('packages')) headers.push('Packages');
            if (firstItem.hasOwnProperty('quantity_kg')) headers.push('Quantity (kg)');
            if (firstItem.hasOwnProperty('percent_unsold')) headers.push('% Unsold');

            // Render Header
            const thead = table.querySelector('thead');
            let headerRowHTML = '<tr>';
            headers.forEach((header, index) => {
                // Left align category, right align others
                const align = index === 0 ? 'left' : 'right';
                headerRowHTML += `<th class="header-main" style="text-align: ${align};">${header}</th>`;
            });
            headerRowHTML += '</tr>';
            thead.innerHTML = headerRowHTML;

            let totalLots = 0;
            let totalPackages = 0;
            let totalQuantity = 0;
            let totalUnsoldWeighted = 0; // For calculating average unsold %

            // Render Body
            offerings.forEach(item => {
                let rowHTML = `<tr><td style="text-align: left;">${item.category}</td>`;

                if (item.hasOwnProperty('lots')) {
                    const lots = item.lots || 0;
                    totalLots += lots;
                    rowHTML += `<td style="text-align: right;">${formatNumber(lots)}</td>`;
                }
                if (item.hasOwnProperty('packages')) {
                    const packages = item.packages || 0;
                    totalPackages += packages;
                    rowHTML += `<td style="text-align: right;">${formatNumber(packages)}</td>`;
                }
                if (item.hasOwnProperty('quantity_kg')) {
                    const quantity = item.quantity_kg || 0;
                    totalQuantity += quantity;
                    rowHTML += `<td style="text-align: right;">${formatNumber(quantity)}</td>`;
                }
                if (item.hasOwnProperty('percent_unsold')) {
                    const unsold = item.percent_unsold;
                    // Calculate weighted contribution for average unsold percentage
                    if (unsold !== null && item.quantity_kg) {
                        totalUnsoldWeighted += (unsold * item.quantity_kg);
                    }
                    rowHTML += `<td style="text-align: right;">${formatNumber(unsold, 2)}%</td>`;
                }
                
                rowHTML += '</tr>';
                tbody.innerHTML += rowHTML;
            });

            // Render Footer (Totals)
            let footerHTML = `<tr style="font-weight: bold; background-color: #f1f3f4;"><td style="text-align: left;">TOTAL</td>`;
             if (headers.includes('Lots')) {
                footerHTML += `<td style="text-align: right;">${formatNumber(totalLots)}</td>`;
            }
            if (headers.includes('Packages')) {
                footerHTML += `<td style="text-align: right;">${formatNumber(totalPackages)}</td>`;
            }
            if (headers.includes('Quantity (kg)')) {
                footerHTML += `<td style="text-align: right;">${formatNumber(totalQuantity)}</td>`;
            }
            if (headers.includes('% Unsold')) {
                // Calculate the weighted average unsold percentage
                const avgUnsold = totalQuantity > 0 ? (totalUnsoldWeighted / totalQuantity) : 0;
                footerHTML += `<td style="text-align: right;">${formatNumber(avgUnsold, 2)}%</td>`;
            }

            footerHTML += '</tr>';
            tfoot.innerHTML = footerHTML;
        };

        
        // Renderer for Multi-Center Offerings (Contemporary Brokers Style) - VERIFIED LOGIC
        const renderMultiCenterOfferings = (multiCenterData, metricLabel) => {
             if (!multiCenterData || Object.keys(multiCenterData).length === 0) return;

            const section = document.getElementById('auction-offerings-multi-section');
            section.style.display = 'block';

            const container = document.getElementById('auction-offerings-multi-container');
            // Avoid appending duplicate tables if rendering updates
            if (!document.getElementById(`multi-center-title-${metricLabel}`)) {
                const title = document.createElement('h4');
                title.id = `multi-center-title-${metricLabel}`;
                title.textContent = `Offerings Comparison (${metricLabel})`;
                // Insert the title before the grid container if it's the first metric
                if (container.children.length === 0) {
                    section.insertBefore(title, container);
                } else {
                    // Otherwise append if we are adding the second metric (e.g., M.Kg after Pkgs)
                    section.appendChild(title);
                }
            }
            

            for (const [center, data] of Object.entries(multiCenterData)) {
                const wrapper = document.createElement('div');
                wrapper.className = 'comparison-block';

                const table = document.createElement('table');
                table.className = 'data-table stats-table'; // Use stats-table for alignment

                // Header
                table.innerHTML = `
                    <thead>
                        <tr>
                            <th class="header-main" colspan="4" style="text-align: center; background-color: #e8f0fe;">${center}</th>
                        </tr>
                        <tr>
                            <th class="header-sub" style="text-align: left;">Type</th>
                            <th class="header-sub">Weekly</th>
                            <th class="header-sub">To Date</th>
                            <th class="header-sub">+/- (TD)</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                `;

                const tbody = table.querySelector('tbody');

                data.forEach(item => {
                    const row = document.createElement('tr');
                    // Apply specific formatting based on metric type (1 decimal for M.Kg, 0 for Pkgs)
                    const decimals = metricLabel === 'M.Kg' ? 1 : 0;

                    row.innerHTML = `
                        <td>${item.type}</td>
                        <td>${formatNumber(item.current_weekly, decimals)}</td>
                        <td>${formatNumber(item.current_todate, decimals)}</td>
                        <td>${formatDiff(item.difference_todate, decimals)}</td>
                    `;

                    // Style the Total row
                    if (item.type.toLowerCase() === 'total') {
                        row.style.fontWeight = 'bold';
                        row.style.backgroundColor = '#f1f3f4';
                    }

                    tbody.appendChild(row);
                });

                wrapper.appendChild(table);
                container.appendChild(wrapper);
            }
        };


        // --- Visualization Functions (Charts) ---

        // Visualization for Offerings by Grade (Doughnut Chart) - VERIFIED LOGIC
        const renderOfferingsChart = (offerings) => {
            if (!offerings || offerings.length === 0) return;

            // Filter out categories with zero quantity and the 'TOTAL' row if present
            const filteredData = offerings.filter(item => item.quantity_kg > 0 && item.category.toLowerCase() !== 'total');
            
            if (filteredData.length === 0) return;

            document.getElementById('volume-visualization-section').style.display = 'block';
            document.getElementById('offerings-chart-block').style.display = 'block';

            const ctx = document.getElementById('offeringsChart').getContext('2d');
            const labels = filteredData.map(item => item.category);
            const data = filteredData.map(item => item.quantity_kg);

            // Generate dynamic colors (example using a predefined palette subset)
            const colors = [
                CHART_COLORS.primary, CHART_COLORS.secondary, CHART_COLORS.accent1, 
                CHART_COLORS.accent2, CHART_COLORS.neutral,
                'rgba(234, 67, 53, 0.8)', 'rgba(150, 138, 234, 0.8)'
            ];

            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Quantity (kg)',
                        data: data,
                        backgroundColor: colors.slice(0, labels.length),
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed !== null) {
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((context.parsed / total) * 100).toFixed(1);
                                        label += `${formatNumber(context.parsed)} kg (${percentage}%)`;
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        };

        // --- Main Orchestration Function ---
        const renderReport = (data) => {
            const meta = data.metadata;
            const summary = data.summary;

            // 1. Set Title and Metadata
            const identifier = meta.sale_number ? `Sale ${meta.sale_number}` : (meta.auction_number ? `Auction ${meta.auction_number}` : (meta.week_number ? `Week ${meta.week_number}` : ''));
            const title = `${meta.auction_centre} Market Report - ${identifier}, ${meta.year}`;
            document.getElementById('report-title').textContent = title;
            document.title = title + ' - TeaTrade';

            let metaText = `Source: ${meta.source} | Country: ${meta.country}`;
            if (meta.date) {
                metaText += ` | Date: ${meta.date}`;
            }
            if (meta.currency) {
                 metaText += ` | Currency: ${meta.currency}`;
            }
            document.getElementById('report-meta').textContent = metaText;

            // 2. Render Summary Statistics (Stat Cards)
            const statsContainer = document.getElementById('summary-stats');
            statsContainer.innerHTML = ''; // Clear previous stats

            if (summary.total_quantity_kg) {
                statsContainer.innerHTML += `<div class="stat-card"><h4>Total Quantity (kg)</h4><p>${formatNumber(summary.total_quantity_kg)}</p></div>`;
            }
            if (summary.total_lots) {
                 statsContainer.innerHTML += `<div class="stat-card"><h4>Total Lots</h4><p>${formatNumber(summary.total_lots)}</p></div>`;
            }
            if (summary.total_packages) {
                 statsContainer.innerHTML += `<div class="stat-card"><h4>Total Packages</h4><p>${formatNumber(summary.total_packages)}</p></div>`;
            }
            if (summary.percent_unsold !== undefined && summary.percent_unsold !== null) {
                 statsContainer.innerHTML += `<div class="stat-card"><h4>% Unsold</h4><p>${formatNumber(summary.percent_unsold, 1)}%</p></div>`;
            }
             if (summary.average_price) {
                 statsContainer.innerHTML += `<div class="stat-card"><h4>Average Price (${meta.currency})</h4><p>${formatCurrency(summary.average_price)}</p></div>`;
            }

            // 3. Render Commentary
            if (data.market_commentary) {
                document.getElementById('summary-section').style.display = 'block';
                document.getElementById('market-comment').textContent = data.market_commentary;
            }
            if (summary.quality_comment) {
                document.getElementById('quality-wrapper').style.display = 'block';
                document.getElementById('quality-comment').textContent = summary.quality_comment;
            }

            // 4. Render Data Tables (Modularized)
            renderGlobalStatistics(data.global_statistics);
            renderQuantityComparison(data.quantity_sold_comparison, meta);
            renderOfferingsByGrade(data.offerings_by_grade, meta);
            renderCommentaryGrid(data.market_synopsis);
            renderAveragesComparison(data.auction_averages_comparison, meta);
            renderPriceDistribution(data.price_distribution, meta);

            // 5. Render Multi-Center Tables (Specific handling for multiple metrics)
            renderMultiCenterOfferings(data.auction_offerings_multi_center_pkgs, 'Pkgs');
            renderMultiCenterOfferings(data.auction_offerings_multi_center_mkg, 'M.Kg');


            // 6. Render Visualizations
            renderOfferingsChart(data.offerings_by_grade);
        };

        
        // =================================================================
        // === UPDATED: Data Loading and Orchestration (Handles new paths) ===
        // =================================================================

        // Function to fetch data (Handles file path variations for Market Reports)
        async function fetchData(name) {
            // Priority 1: The organized path (Data/Market_Reports/)
            const structuredPath = `Data/Market_Reports/${name}.json`;
            // Priority 2: Fallback to the root directory (for older files or different data types)
            const rootPath = `${name}.json`;

            try {
                // Try the structured path first
                let response = await fetch(structuredPath);

                // If structured path fails (e.g., 404 Not Found), try the root directory
                if (!response.ok) {
                    console.warn(`File not found in structured path: ${structuredPath}. Trying root path.`);
                    response = await fetch(rootPath);
                }

                if (!response.ok) {
                    // If both failed, throw an error
                    throw new Error(`HTTP error! status: ${response.status}. File not found in Data/Market_Reports/ or root.`);
                }
                return await response.json();
            } catch (error) {
                throw new Error(`Could not locate data file for ${name}. Error: ${error.message}`);
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const params = new URLSearchParams(window.location.search);
            const datasetName = params.get('dataset');

            if (!datasetName) {
                document.getElementById('report-title').textContent = 'Error: No report selected.';
                document.getElementById('loading-indicator').textContent = 'Please select a report from the Market Reports Library.';
                return;
            }

            try {
                // Use the new fetchData function
                const reportData = await fetchData(datasetName);
                
                renderReport(reportData);

                document.getElementById('loading-indicator').style.display = 'none';
                document.getElementById('report-content').style.display = 'block';

            } catch (error) {
                console.error('Error loading report:', error);
                document.getElementById('report-title').textContent = 'Error loading report.';
                // Display a user-friendly error message
                document.getElementById('loading-indicator').textContent = `An error occurred while loading the data. Details: ${error.message}`;
            }
        });
    </script>
</body>
</html>