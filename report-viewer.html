<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market Report Viewer - TeaTrade</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="market-reports-page">
    <header class="site-header">
        <div class="header-top-bar">
            <a href="corporate.html" class="header-logo"><h1>Tea<span>Trade</span></h1></a>
            <div class="header-search-wrapper"><input type="text" class="header-search-bar" placeholder="Global site search..."></div>
            <div class="user-actions">
                <a href="#" title="Create Account"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><line x1="20" y1="8" x2="20" y2="14"></line><line x1="17" y1="11" x2="23" y2="11"></line></svg></a>
                <a href="#" title="Sign In"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path><polyline points="10 17 15 12 10 7"></polyline><line x1="15" y1="12" x2="3" y2="12"></line></svg></a>
            </div>
            <button class="mobile-menu-toggle" aria-label="Toggle navigation" aria-expanded="false">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
            </button>
        </div>
        <nav class="secondary-nav">
            <ul>
                <li><a href="data.html">Data</a></li>
                <li><a href="market-reports.html" class="active">Market Reports</a></li>
                <li><a href="#">Auctions</a></li>
                <li><a href="visuals.html">Visuals</a></li>
            </ul>
        </nav>
    </header>

    <main class="page-container">
        <div class="dashboard-header">
            <h2 class="page-title" id="report-title">Loading Report...</h2>
        </div>
        <p id="report-meta" style="margin-bottom: 24px; color: #5f6368;"></p>

        <div id="report-content" style="display: none;">
            
            <div id="consolidated-view" style="display: none;">
                <section class="report-section" id="overview-section" style="display: none;">
                    <h3>Auction Overview</h3>
                    <div class="stat-cards-container" id="summary-stats"></div>
                    <div class="overview-grid">
                        <div class="commentary-block">
                            <h4>Market Synopsis</h4>
                            <p id="market-comment"></p>
                        </div>
                        <div class="highest-prices-block" id="highest-prices-wrapper" style="display: none;">
                            <h4>Highest Achieved Prices</h4>
                            <table class="data-table compact-table" id="highest-prices-table">
                                <thead><tr><th>Price</th><th>Grade</th><th>Mark (Factory)</th><th>Country</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <section class="report-section" id="volume-analysis-section" style="display: none;">
                    <h3>Volume Analysis</h3>
                    <div class="analysis-grid">
                        <div class="analysis-block" id="country-volume-chart-wrapper" style="display: none;">
                            <h4>Offerings vs Sold by Country (kg)</h4>
                            <div style="position: relative; height: 350px;"><canvas id="countryVolumeChart"></canvas></div>
                        </div>
                        <div class="analysis-block" id="grade-stats-table-wrapper" style="display: none;">
                             <h4>Detailed Grade/Category Statistics</h4>
                            <div class="data-table-container">
                                <table class="data-table stats-table" id="grade-stats-table">
                                    <thead></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </section>

                <section class="report-section" id="buyer-activity-section" style="display: none;">
                    <h3>Buyer Activity & Market Share</h3>
                     <div class="analysis-grid">
                        <div class="analysis-block" id="buyer-chart-wrapper" style="display: none;">
                             <h4>Buyer Market Share (%)</h4>
                            <div style="position: relative; height: 400px;"><canvas id="buyerChart"></canvas></div>
                        </div>
                        <div class="analysis-block" id="buyer-activity-table-wrapper" style="display: none;">
                            <h4>Top Buyers & Regional Activity</h4>
                             <div class="data-table-container">
                                <table class="data-table stats-table" id="buyer-activity-table">
                                    <thead><tr><th>Buyer/Region</th><th>Activity/Purchases</th></tr></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </section>
            </div>

            <div id="legacy-view" style="display: none;">
                 <section class="report-section" id="legacy-summary-section">
                    <h3>Market Summary</h3>
                    <p id="legacy-market-comment"></p>
                    <p><strong>Quality:</strong> <span id="legacy-quality-comment"></span></p>
                </section>

                <section class="report-section" id="legacy-volume-analysis-section" style="display: none;">
                    <h3>Volume Analysis</h3>
                    <div class="analysis-grid" id="legacy-volume-analysis-container">
                        </div>
                </section>

                <section class="report-section" id="legacy-offerings-section">
                    <h3>Auction Offerings</h3>
                    <div class="data-table-container">
                        <table class="data-table" id="legacy-offerings-table">
                            <thead>
                                </thead>
                            <tbody></tbody>
                            <tfoot></tfoot>
                        </table>
                    </div>
                </section>

                <section class="report-section" id="legacy-prices-section">
                    <h3 id="legacy-price-quotations-title">Price Quotations</h3>
                    <div class="data-table-container">
                        <table class="data-table" id="legacy-prices-table">
                            <thead>
                                </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </section>
                
                 <section class="report-section" id="legacy-international-section" style="display: none;">
                    <h3>International Summaries</h3>
                    <div id="legacy-international-container"></div>
                </section>
            </div>

        </div>
        <div id="loading-indicator">Loading report data...</div>
        <div id="error-message" style="color: red; display: none;"></div>
    </main>

    <script src="script.js"></script>
    
    <script>
        //=================================================================
        // CONFIGURATION AND UTILITIES
        //=================================================================

        const CHART_COLORS = {
            primary: 'rgba(26, 115, 232, 0.8)', secondary: 'rgba(128, 178, 247, 0.8)',
            accent2: 'rgba(52, 168, 83, 0.8)'
        };

        const formatNumber = (num, decimals = 0) => {
            if (num === null || num === undefined || isNaN(parseFloat(num))) return 'N/A';
            return parseFloat(num).toLocaleString(undefined, { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
        };

        const formatCurrency = (num, currency = 'USD') => {
             if (num === null || num === undefined || isNaN(parseFloat(num))) return 'N/A';
             return `${currency} ${formatNumber(num, 2)}`;
        };

        // Specific format for Legacy price tables
        const formatPriceRangeLegacy = (min, max) => {
             if (min === null && max === null) return 'N/A';
             // Ensure 2 decimal places for legacy price tables
             return `${formatNumber(min, 2)} - ${formatNumber(max, 2)}`;
        }

        //=================================================================
        // INITIALIZATION AND DATA LOADING
        //=================================================================

        document.addEventListener('DOMContentLoaded', () => {
            if (typeof initializeMobileMenu === 'function') {
                initializeMobileMenu();
            }
            loadReportLibrary();
        });

        async function loadReportLibrary() {
            try {
                const response = await fetch('market-reports-library.json');
                if (!response.ok) throw new Error('Failed to fetch report library.');
                
                const libraryData = await response.json();
                const report = findTargetReport(libraryData);

                if (report) {
                    // Determine format and render accordingly
                    determineFormatAndRender(report);
                    document.getElementById('loading-indicator').style.display = 'none';
                    document.getElementById('report-content').style.display = 'block';
                } else {
                    throw new Error('Report not found in library or invalid URL parameters (requires ?location=X&reportTitle=Y).');
                }

            } catch (error) {
                console.error('Error loading reports:', error);
                showError(error.message);
            }
        }

        function findTargetReport(libraryData) {
            const params = new URLSearchParams(window.location.search);
            const reportTitle = params.get('reportTitle');
            const location = params.get('location');

            if (!reportTitle || !location) return null;

            if (libraryData.hasOwnProperty(location) && libraryData[location].hasOwnProperty(reportTitle)) {
                const reportData = libraryData[location][reportTitle];
                reportData.title = reportTitle;
                reportData.location = location;
                return reportData;
            }
            return null;
        }

        function showError(message) {
            document.getElementById('loading-indicator').style.display = 'none';
            document.getElementById('report-title').textContent = 'Error Loading Report';
            document.getElementById('error-message').textContent = `Error: ${message}`;
            document.getElementById('error-message').style.display = 'block';
        }

        //=================================================================
        // FORMAT DETECTION (THE HYBRID SWITCH)
        //=================================================================

        function determineFormatAndRender(report) {
            // Detection Logic:
            // CONSOLIDATED: Has a 'data' object containing amalgamated raw files.
            // LEGACY: Has keys like 'metadata', 'price_quotations', 'offerings' at the top level.

            // Check for Consolidated format: 'data' exists AND it's not just an empty placeholder.
            if (report.data && typeof report.data === 'object' && Object.keys(report.data).length > 0) {
                console.log("Rendering as CONSOLIDATED format.");
                document.getElementById('consolidated-view').style.display = 'block';
                renderConsolidatedReport(report);
            
            // Check for Legacy format: 'metadata', 'price_quotations', or 'offerings' exist.
            } else if (report.metadata || report.price_quotations || report.offerings) {
                console.log("Rendering as LEGACY format.");
                document.getElementById('legacy-view').style.display = 'block';
                renderLegacyReport(report);
            
            } else {
                // Handle cases where the report exists but has no recognizable data structure
                console.log("Rendering as BASIC format (Title/Description only).");
                document.getElementById('report-title').textContent = report.title || 'Untitled Report';
                document.getElementById('report-meta').textContent = report.description || '';
            }
        }

        //=================================================================
        // RENDERER: CONSOLIDATED FORMAT (The New Strategy)
        //=================================================================
        
        function renderConsolidatedReport(report) {
            document.getElementById('report-title').textContent = report.title;
            document.getElementById('report-meta').textContent = report.description || '';

            const data = report.data || {};
            
            const currencyMatch = report.description.match(/Currency: (\w+)/);
            const primaryCurrency = currencyMatch ? currencyMatch[1] : 'USD';

            renderConsolidatedOverview(data, primaryCurrency);
            renderConsolidatedVolumeAnalysis(data);
            renderConsolidatedBuyerActivity(data);
        }

        // (Consolidated rendering functions remain as established previously)

        function renderConsolidatedOverview(data, currency) {
            const section = document.getElementById('overview-section');
            let contentExists = false;

            // A. Summary Stats
            if (data.summary_statistics && data.summary_statistics.length > 0) {
                contentExists = true;
                const statsContainer = document.getElementById('summary-stats');
                statsContainer.innerHTML = '';
                data.summary_statistics.forEach(stat => {
                    const card = document.createElement('div');
                    card.className = 'stat-card';
                    card.innerHTML = `<span class="stat-value">${stat.value}</span><span class="stat-label">${stat.metric}</span>`;
                    statsContainer.appendChild(card);
                });
            }

            // B. Market Commentary (Handles various potential input file names)
            let commentaryText = null;
            if (data.market_commentary && data.market_commentary.length > 0) {
                commentaryText = data.market_commentary[0].comment;
            } else {
                 // Check for keys matching the pattern 'buyer_summary_SXX' (for the Sale 36 test case)
                 const buyerSummaryKey = Object.keys(data).find(k => k.startsWith('buyer_summary_S'));
                 if (buyerSummaryKey && data[buyerSummaryKey].notes) {
                    commentaryText = data[buyerSummaryKey].notes;
                 }
            }

            if (commentaryText) {
                contentExists = true;
                document.getElementById('market-comment').textContent = commentaryText;
            }

            // C. Highest Prices
            if (data.highest_achieved_prices && data.highest_achieved_prices.length > 0) {
                contentExists = true;
                document.getElementById('highest-prices-wrapper').style.display = 'block';
                const tbody = document.querySelector('#highest-prices-table tbody');
                tbody.innerHTML = '';
                const topPrices = data.highest_achieved_prices.slice(0, 10); 

                topPrices.forEach(item => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${formatCurrency(item.price, currency)}</td>
                        <td>${item.grade}</td>
                        <td>${item.mark}</td>
                        <td>${item.country || 'N/A'}</td>
                    `;
                    tbody.appendChild(row);
                });
            }

            if (contentExists) section.style.display = 'block';
        }

        function renderConsolidatedVolumeAnalysis(data) {
            const section = document.getElementById('volume-analysis-section');
            let contentExists = false;

            // A. Country Volume Chart
            if (data.country_volume_analysis && data.country_volume_analysis.length > 0) {
                contentExists = true;
                document.getElementById('country-volume-chart-wrapper').style.display = 'block';
                renderCountryVolumeChart(data.country_volume_analysis);
            }

             // B. Detailed Grade/Category Statistics Table
            let gradeStatsData = null;
            if (data.grade_category_statistics && data.grade_category_statistics.length > 0) {
                gradeStatsData = data.grade_category_statistics;
            } else {
                // Check for keys matching the pattern 'auction_prices_SXX' (for the Sale 36 test case)
                const auctionPricesKey = Object.keys(data).find(k => k.startsWith('auction_prices_S'));
                if (auctionPricesKey && data[auctionPricesKey].length > 0) {
                    gradeStatsData = data[auctionPricesKey];
                }
            }

            if (gradeStatsData) {
                 contentExists = true;
                document.getElementById('grade-stats-table-wrapper').style.display = 'block';
                renderGradeStatsTable(gradeStatsData);
            }

            if (contentExists) section.style.display = 'block';
        }

        function renderCountryVolumeChart(chartData) {
            const ctx = document.getElementById('countryVolumeChart').getContext('2d');
            const labels = chartData.map(item => item.country);
            const offered = chartData.map(item => parseFloat(item.offered_kg));
            const sold = chartData.map(item => parseFloat(item.sold_kg));

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Offered (kg)',
                            data: offered,
                            backgroundColor: CHART_COLORS.secondary,
                        },
                        {
                            label: 'Sold (kg)',
                            data: sold,
                            backgroundColor: CHART_COLORS.primary,
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, title: { display: true, text: 'Quantity (kg)' } } },
                    plugins: { legend: { display: true } }
                }
            });
        }

        function renderGradeStatsTable(statsData) {
            const table = document.getElementById('grade-stats-table');
            const thead = table.querySelector('thead');
            const tbody = table.querySelector('tbody');
            tbody.innerHTML = '';
            thead.innerHTML = '';

            if (statsData.length === 0) return;

            const headers = Object.keys(statsData[0]);
            let headerHtml = '<tr>';
            headers.forEach(header => {
                const formattedHeader = header.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                headerHtml += `<th>${formattedHeader}</th>`;
            });
            headerHtml += '</tr>';
            thead.innerHTML = headerHtml;

            statsData.forEach(item => {
                let rowHtml = '<tr>';
                headers.forEach(header => {
                    const value = item[header];
                    const isNumeric = !isNaN(parseFloat(value)) && isFinite(value);
                    const isIdentifier = (header === 'category' || header === 'grade');
                    
                    const formattedValue = (isNumeric && !isIdentifier) ? formatNumber(value) : value;
                    rowHtml += `<td>${formattedValue}</td>`;
                });
                rowHtml += '</tr>';
                tbody.innerHTML += rowHtml;
            });
        }

        function renderConsolidatedBuyerActivity(data) {
            const section = document.getElementById('buyer-activity-section');
            let contentExists = false;

            // A. Buyer Market Share Chart
            if (data.buyer_market_share && data.buyer_market_share.length > 0) {
                contentExists = true;
                document.getElementById('buyer-chart-wrapper').style.display = 'block';
                renderBuyerChart(data.buyer_market_share);
            }

            // B. Buyer Activity Table
            let activityData = null;
            if (data.buyer_activity && data.buyer_activity.length > 0) {
                activityData = data.buyer_activity;
            } else {
                // Check for keys matching the pattern 'buyer_summary_SXX' (for the Sale 36 test case)
                const buyerSummaryKey = Object.keys(data).find(k => k.startsWith('buyer_summary_S'));
                if (buyerSummaryKey && data[buyerSummaryKey]) {
                    const summary = data[buyerSummaryKey];
                    activityData = [];
                    if (summary.top_buyer) activityData.push({ buyer_or_region: 'Top Buyer', activity_or_purchases: summary.top_buyer });
                    if (summary.total_lots) activityData.push({ buyer_or_region: 'Total Lots', activity_or_purchases: summary.total_lots });
                    if (summary.lots_sold) activityData.push({ buyer_or_region: 'Lots Sold', activity_or_purchases: summary.lots_sold });
                }
            }

             if (activityData && activityData.length > 0) {
                contentExists = true;
                document.getElementById('buyer-activity-table-wrapper').style.display = 'block';
                const tbody = document.querySelector('#buyer-activity-table tbody');
                tbody.innerHTML = '';

                activityData.forEach(item => {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td>${item.buyer_or_region}</td><td>${item.activity_or_purchases}</td>`;
                    tbody.appendChild(row);
                });
            }

            if (contentExists) section.style.display = 'block';
        }

        function renderBuyerChart(chartData) {
            const ctx = document.getElementById('buyerChart').getContext('2d');
            
            const sortedData = [...chartData].sort((a, b) => parseFloat(b.percentage) - parseFloat(a.percentage));
            
            let processedData = sortedData;
            if (sortedData.length > 10) {
                const top9 = sortedData.slice(0, 9);
                const others = sortedData.slice(9);
                const othersPercentage = others.reduce((sum, item) => sum + parseFloat(item.percentage), 0);
                processedData = [...top9, { buyer: 'Others', percentage: othersPercentage.toFixed(2) }];
            }

            const labels = processedData.map(item => item.buyer);
            const percentages = processedData.map(item => parseFloat(item.percentage));

            const colors = ['#3366cc', '#dc3912', '#ff9900', '#109618', '#990099', '#0099c6', '#dd4477', '#66aa00', '#b82e2e', '#316395'];

            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Market Share (%)',
                        data: percentages,
                        backgroundColor: colors.slice(0, processedData.length),
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: true, position: 'right' } }
                }
            });
        }

        //=================================================================
        // RENDERER: LEGACY FORMAT (Historical Normalized Reports)
        //=================================================================

        // (This section restores the functionality for the historical reports)

        function renderLegacyReport(data) {
            const meta = data.metadata || {};
            const summary = data.summary || {};

            // Metadata and Title (Prioritize metadata if available, otherwise use the library entry info)
            const title = meta.auction_centre ? `${meta.auction_centre} Auction Report - Week ${meta.week_number} (${meta.year})` : data.title;
            const metaText = meta.broker ? `Sale No: ${meta.sale_number} | Dates: ${meta.sale_date_start} to ${meta.sale_date_end} | Broker: ${meta.broker}` : data.description;

            document.getElementById('report-title').textContent = title;
            document.getElementById('report-meta').textContent = metaText;
            
            const currency = meta.currency || 'N/A';

            // Summary Comments
            document.getElementById('legacy-market-comment').textContent = summary.market_comment || 'N/A';
            document.getElementById('legacy-quality-comment').textContent = summary.quality_comment || 'N/A';

            // Render Offerings (Table and Chart)
            renderLegacyOfferings(data.offerings, summary);
            
            // Render Price Quotations
            renderLegacyPrices(data.price_quotations, currency);

            // Render International Summaries
            renderLegacyInternational(data.international_summaries);
        }

        function renderLegacyOfferings(offerings, summary) {
            const tbody = document.querySelector('#legacy-offerings-table tbody');
            const thead = document.querySelector('#legacy-offerings-table thead');
            const tfoot = document.querySelector('#legacy-offerings-table tfoot');
            tbody.innerHTML = '';
            tfoot.innerHTML = '';
            thead.innerHTML = '';

            if (!offerings) return;

            // Determine Headers
            const hasLots = offerings.some(item => item.lots !== undefined);
            const hasPackages = offerings.some(item => item.packages !== undefined);
            
            let headerHtml = '<tr><th>Category</th>';
            if (hasLots) headerHtml += '<th>Lots</th>';
            if (hasPackages) headerHtml += '<th>Packages</th>';
            headerHtml += '<th>Quantity (kg)</th>';
            headerHtml += '</tr>';
            thead.innerHTML = headerHtml;


            offerings.forEach(item => {
                let rowHtml = `<tr><td>${item.category}</td>`;
                if (hasLots) rowHtml += `<td>${formatNumber(item.lots)}</td>`;
                if (hasPackages) rowHtml += `<td>${formatNumber(item.packages)}</td>`;
                rowHtml += `<td>${formatNumber(item.quantity_kg)}</td>`;
                rowHtml += '</tr>';
                tbody.innerHTML += rowHtml;
            });
            
            // Add Totals to Footer
            if (summary && summary.total_quantity_kg) {
                let footCells = [`<td>TOTAL</td>`];
                if (hasLots) footCells.push(`<td>${formatNumber(summary.total_lots)}</td>`);
                if (hasPackages) footCells.push(`<td>${formatNumber(summary.total_packages)}</td>`);
                footCells.push(`<td>${formatNumber(summary.total_quantity_kg)}</td>`);

                tfoot.innerHTML = `<tr style="font-weight: bold; background-color: #f1f3f4;">${footCells.join('')}</tr>`;
            }

            if (summary && summary.reprints_lots) {
                let reprintHtml = `<tr style="font-style: italic; color: #5f6368;"><td>Re-Prints</td>`;
                if (hasLots) reprintHtml += `<td>${formatNumber(summary.reprints_lots)}</td>`;
                if (hasPackages) reprintHtml += `<td>N/A</td>`; // Alignment placeholder
                reprintHtml += `<td>${formatNumber(summary.reprints_quantity_kg)}</td></tr>`;
                tfoot.innerHTML += reprintHtml;
            }

            // Render Chart
            renderLegacyOfferingsChart(offerings);
        }

        function renderLegacyOfferingsChart(offerings) {
            const section = document.getElementById('legacy-volume-analysis-section');
            section.style.display = 'block';
            const container = document.getElementById('legacy-volume-analysis-container');
            container.innerHTML = ''; // Clear previous chart if any

            const chartBlock = document.createElement('div');
            chartBlock.className = 'analysis-block';
            chartBlock.innerHTML = '<h4>Offerings Breakdown (kg)</h4>';
            const canvas = document.createElement('canvas');
            const chartWrapper = document.createElement('div');
            chartWrapper.style.position = 'relative';
            chartWrapper.style.height = '300px';
            chartWrapper.appendChild(canvas);
            chartBlock.appendChild(chartWrapper);
            container.appendChild(chartBlock);

            const ctx = canvas.getContext('2d');
            const labels = offerings.map(item => item.category);
            const values = offerings.map(item => item.quantity_kg);

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Quantity (kg)',
                        data: values,
                        backgroundColor: CHART_COLORS.primary,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, title: { display: true, text: 'Quantity (kg)' } } },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function renderLegacyPrices(quotations, currency) {
            document.getElementById('legacy-price-quotations-title').textContent = `Price Quotations (${currency}/kg)`;
            const thead = document.querySelector('#legacy-prices-table thead');
            const tbody = document.querySelector('#legacy-prices-table tbody');
            tbody.innerHTML = '';
            thead.innerHTML = '';

            if (!quotations || quotations.length === 0) return;

            // Determine Headers dynamically as they varied slightly between brokers
            const hasElevation = quotations.some(item => item.elevation !== undefined);
            const hasCategory = quotations.some(item => item.category !== undefined);
            const hasPrevious = quotations.some(item => item.previous_min !== undefined || item.previous_max !== undefined);
            
            let headerHtml = '<tr>';
            if (hasElevation) headerHtml += '<th>Elevation</th>';
            if (hasCategory) headerHtml += '<th>Category/Region</th>';
            headerHtml += '<th>Grade</th><th>Current (Low-High)</th>';
            if (hasPrevious) headerHtml += '<th>Previous (Low-High)</th>';
            headerHtml += '</tr>';
            thead.innerHTML = headerHtml;


            quotations.forEach(item => {
                let rowHtml = '<tr>';
                if (hasElevation) rowHtml += `<td>${item.elevation || 'N/A'}</td>`;
                if (hasCategory) rowHtml += `<td>${item.category || 'N/A'}</td>`;
                rowHtml += `<td>${item.grade}</td>`;
                rowHtml += `<td>${formatPriceRangeLegacy(item.current_min, item.current_max)}</td>`;
                if (hasPrevious) rowHtml += `<td>${formatPriceRangeLegacy(item.previous_min, item.previous_max)}</td>`;
                rowHtml += '</tr>';
                tbody.innerHTML += rowHtml;
            });
        }

        function renderLegacyInternational(summaries) {
            if (!summaries || summaries.length === 0) return;

            document.getElementById('legacy-international-section').style.display = 'block';
            const container = document.getElementById('legacy-international-container');
            container.innerHTML = '';
            
            summaries.forEach(summary => {
                const div = document.createElement('div');
                div.className = 'international-summary-item';
                div.style.marginBottom = '24px'; div.style.padding = '16px'; div.style.border = '1px solid #dadce0'; div.style.borderRadius = '8px';

                let contentHtml = `<h4>${summary.centre} (Sale ${summary.sale_no || 'N/A'})</h4>
                                   <p style="font-size: 13px; color: #5f6368;">${summary.date || ''}</p>
                                   <p>${summary.summary || 'Summary not available.'}</p>`;
                
                // Handle structured data if it exists (like Mombasa CTC in old reports)
                if (summary.structured_data && summary.structured_data.currency) {
                    contentHtml += `<p><strong>Quotations (${summary.structured_data.currency}):</strong></p>`;
                    
                    const renderTable = (grades, title) => {
                        if (!grades || grades.length === 0) return '';
                        let tableHtml = `<div class="data-table-container" style="margin-bottom: 16px; max-width: 500px;">
                                         <p style="font-weight: 500; margin-bottom: 8px;">${title}</p>
                                         <table class="data-table">
                                         <thead><tr><th>Category</th><th>Grade</th><th>Low</th><th>High</th></tr></thead><tbody>`;
                        grades.forEach(grade => {
                            tableHtml += `<tr><td>${grade.category}</td><td>${grade.grade}</td><td>${formatNumber(grade.low)}</td><td>${formatNumber(grade.high)}</td></tr>`;
                        });
                        tableHtml += `</tbody></table></div>`;
                        return tableHtml;
                    };

                    contentHtml += renderTable(summary.structured_data.ctc_leaf_grades, "CTC Leaf");
                    contentHtml += renderTable(summary.structured_data.ctc_dust_grades, "CTC Dust");
                }

                div.innerHTML = contentHtml;
                container.appendChild(div);
            });
        }

    </script>
</body>
</html>
