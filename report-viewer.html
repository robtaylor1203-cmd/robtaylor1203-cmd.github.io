<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market Report Viewer - TeaTrade</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="market-reports-page">
    <header class="site-header">
        <div class="header-top-bar">
            <a href="corporate.html" class="header-logo"><h1>Tea<span>Trade</span></h1></a>
            <div class="header-search-wrapper"><input type="text" class="header-search-bar" placeholder="Global site search..."></div>
            <div class="user-actions">
                <a href="#" title="Create Account"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><line x1="20" y1="8" x2="20" y2="14"></line><line x1="17" y1="11" x2="23" y2="11"></line></svg></a>
                <a href="#" title="Sign In"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path><polyline points="10 17 15 12 10 7"></polyline><line x1="15" y1="12" x2="3" y2="12"></line></svg></a>
            </div>
            <button class="mobile-menu-toggle" aria-label="Toggle navigation" aria-expanded="false">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
            </button>
        </div>
        <nav class="secondary-nav">
            <ul>
                <li><a href="data.html">Data</a></li>
                <li><a href="market-reports.html" class="active">Market Reports</a></li>
                <li><a href="#">Auctions</a></li>
                <li><a href="visuals.html">Visuals</a></li>
            </ul>
        </nav>
    </header>

    <main class="page-container">
        <div class="dashboard-header">
            <h2 class="page-title" id="report-title">Loading Consolidated Report...</h2>
        </div>
        <p id="report-meta" style="margin-bottom: 24px; color: #5f6368;"></p>

        <div id="report-content" style="display: none;">
            
            <section class="report-section" id="overview-section" style="display: none;">
                <h3>Auction Overview</h3>
                <div class="stat-cards-container" id="summary-stats"></div>
                
                <div class="overview-grid">
                    <div class="commentary-block">
                        <h4>Market Synopsis</h4>
                        <p id="market-comment"></p>
                    </div>
                    <div class="highest-prices-block" id="highest-prices-wrapper" style="display: none;">
                        <h4>Highest Achieved Prices</h4>
                        <table class="data-table compact-table" id="highest-prices-table">
                            <thead>
                                <tr>
                                    <th>Price</th>
                                    <th>Grade</th>
                                    <th>Mark (Factory)</th>
                                    <th>Country</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section class="report-section" id="volume-analysis-section" style="display: none;">
                <h3>Volume Analysis</h3>
                <div class="analysis-grid">
                    <div class="analysis-block" id="country-volume-chart-wrapper" style="display: none;">
                        <h4>Offerings vs Sold by Country (kg)</h4>
                        <div style="position: relative; height: 350px;"><canvas id="countryVolumeChart"></canvas></div>
                    </div>
                    <div class="analysis-block" id="grade-stats-table-wrapper" style="display: none;">
                         <h4>Detailed Grade/Category Statistics</h4>
                        <div class="data-table-container">
                            <table class="data-table stats-table" id="grade-stats-table">
                                <thead>
                                    </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <section class="report-section" id="buyer-activity-section" style="display: none;">
                <h3>Buyer Activity & Market Share</h3>
                 <div class="analysis-grid">
                    <div class="analysis-block" id="buyer-chart-wrapper" style="display: none;">
                         <h4>Buyer Market Share (%)</h4>
                        <div style="position: relative; height: 400px;"><canvas id="buyerChart"></canvas></div>
                    </div>
                    <div class="analysis-block" id="buyer-activity-table-wrapper" style="display: none;">
                        <h4>Top Buyers & Regional Activity</h4>
                         <div class="data-table-container">
                            <table class="data-table stats-table" id="buyer-activity-table">
                                <thead>
                                    <tr>
                                        <th>Buyer/Region</th>
                                        <th>Activity/Purchases</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <section class="report-section" id="raw-data-section" style="display: none;">
                <h3>Raw Data Components (Debug View)</h3>
                <div id="raw-data-container"></div>
            </section>

        </div>
        <div id="loading-indicator">Loading report data...</div>
        <div id="error-message" style="color: red; display: none;"></div>
    </main>

    <script src="script.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize mobile menu (assuming this function exists in script.js)
            if (typeof initializeMobileMenu === 'function') {
                initializeMobileMenu();
            }
            loadReportLibrary();
        });

        async function loadReportLibrary() {
            try {
                const response = await fetch('market-reports-library.json');
                if (!response.ok) throw new Error('Failed to fetch report library.');
                
                // The libraryData is now an Object (dictionary)
                const libraryData = await response.json();
                const report = findTargetReport(libraryData);

                if (report) {
                    renderConsolidatedReport(report);
                    document.getElementById('loading-indicator').style.display = 'none';
                    document.getElementById('report-content').style.display = 'block';
                } else {
                    // If no specific report is found via URL parameters, maybe show a default or an error
                    throw new Error('Report not found in library or invalid URL parameters (requires ?location=X&reportTitle=Y).');
                }

            } catch (error) {
                console.error('Error loading reports:', error);
                document.getElementById('loading-indicator').style.display = 'none';
                document.getElementById('report-title').textContent = 'Error Loading Report';
                document.getElementById('error-message').textContent = `Error: ${error.message}`;
                document.getElementById('error-message').style.display = 'block';
            }
        }

        // *** THE CRITICAL FIX ***
        // This function knows how to navigate the new Object structure using the keys provided in the URL.
        function findTargetReport(libraryData) {
            const params = new URLSearchParams(window.location.search);
            const reportTitle = params.get('reportTitle');
            const location = params.get('location');

            if (!reportTitle || !location) return null;

            // Check if the location exists, and then if the report title exists within that location
            if (libraryData.hasOwnProperty(location) && libraryData[location].hasOwnProperty(reportTitle)) {
                const reportData = libraryData[location][reportTitle];
                // Add the title and location back into the object for easy access during rendering
                reportData.title = reportTitle;
                reportData.location = location;
                return reportData;
            }

            return null;
        }


        // --- Utility Functions ---
        const formatNumber = (num, decimals = 0) => {
            if (num === null || num === undefined || isNaN(parseFloat(num))) return 'N/A';
            return parseFloat(num).toLocaleString(undefined, { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
        };

        const formatCurrency = (num, currency = 'USD') => {
             if (num === null || num === undefined || isNaN(parseFloat(num))) return 'N/A';
             // Simple currency formatting.
             return `${currency} ${formatNumber(num, 2)}`;
        };


        // --- Rendering Logic ---
        // This function orchestrates the display of the consolidated report data.
        function renderConsolidatedReport(report) {
            // 1. Metadata and Title
            document.getElementById('report-title').textContent = report.title;
            document.getElementById('report-meta').textContent = report.description || '';

            // 2. Extract Data Components (The amalgamated data from consolidate_v2.py)
            const data = report.data || {};
            
            // Determine the primary currency from the description if available
            const currencyMatch = report.description.match(/Currency: (\w+)/);
            const primaryCurrency = currencyMatch ? currencyMatch[1] : 'USD';


            // 3. Render Sections based on available data components
            renderOverview(data, primaryCurrency);
            renderVolumeAnalysis(data);
            renderBuyerActivity(data);
            
            // Uncomment the line below if you want to see the raw JSON components for debugging
            // renderRawData(data); 
        }

        // Rendering functions (Overview, Volume, Buyer Activity) remain the same as established previously.
        // They read the specific keys within the 'data' object.
        function renderOverview(data, currency) {
            const section = document.getElementById('overview-section');
            let contentExists = false;

            // A. Summary Stats (e.g., from an 'auction_summary.json' input file)
            if (data.summary_statistics && data.summary_statistics.length > 0) {
                contentExists = true;
                const statsContainer = document.getElementById('summary-stats');
                statsContainer.innerHTML = '';
                data.summary_statistics.forEach(stat => {
                    const card = document.createElement('div');
                    card.className = 'stat-card';
                    card.innerHTML = `
                        <span class="stat-value">${stat.value}</span>
                        <span class="stat-label">${stat.metric}</span>
                    `;
                    statsContainer.appendChild(card);
                });
            }

            // B. Market Commentary (e.g., from a 'market_synopsis.json' input file)
            if (data.market_commentary && data.market_commentary.length > 0) {
                contentExists = true;
                // Assuming the first commentary is the main synopsis
                document.getElementById('market-comment').textContent = data.market_commentary[0].comment;
            } else {
                // Fallback for simple structures like the test 'buyer_summary_S36.json'
                if (data.buyer_summary_S36 && data.buyer_summary_S36.notes) {
                    contentExists = true;
                    document.getElementById('market-comment').textContent = data.buyer_summary_S36.notes;
                }
            }

            // C. Highest Prices (e.g., from a 'top_prices.json' input file)
            if (data.highest_achieved_prices && data.highest_achieved_prices.length > 0) {
                contentExists = true;
                document.getElementById('highest-prices-wrapper').style.display = 'block';
                const tbody = document.querySelector('#highest-prices-table tbody');
                tbody.innerHTML = '';
                // Display top 10
                const topPrices = data.highest_achieved_prices.slice(0, 10); 

                topPrices.forEach(item => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${formatCurrency(item.price, currency)}</td>
                        <td>${item.grade}</td>
                        <td>${item.mark}</td>
                        <td>${item.country || 'N/A'}</td>
                    `;
                    tbody.appendChild(row);
                });
            }

            if (contentExists) section.style.display = 'block';
        }

        function renderVolumeAnalysis(data) {
            const section = document.getElementById('volume-analysis-section');
            let contentExists = false;

            // A. Country Volume Chart (e.g., from 'country_analysis.json')
            if (data.country_volume_analysis && data.country_volume_analysis.length > 0) {
                contentExists = true;
                document.getElementById('country-volume-chart-wrapper').style.display = 'block';
                renderCountryVolumeChart(data.country_volume_analysis);
            }

             // B. Detailed Grade/Category Statistics Table (e.g., from 'grade_stats.json' or 'auction_prices_S36.json')
            let gradeStatsData = null;
            if (data.grade_category_statistics && data.grade_category_statistics.length > 0) {
                gradeStatsData = data.grade_category_statistics;
            } else if (data.auction_prices_S36 && data.auction_prices_S36.length > 0) {
                // Fallback for the test structure in auction_prices_S36.json
                gradeStatsData = data.auction_prices_S36;
            }

            if (gradeStatsData) {
                 contentExists = true;
                document.getElementById('grade-stats-table-wrapper').style.display = 'block';
                renderGradeStatsTable(gradeStatsData);
            }


            if (contentExists) section.style.display = 'block';
        }

        function renderCountryVolumeChart(chartData) {
            const ctx = document.getElementById('countryVolumeChart').getContext('2d');
            const labels = chartData.map(item => item.country);
            const offered = chartData.map(item => parseFloat(item.offered_kg));
            const sold = chartData.map(item => parseFloat(item.sold_kg));

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Offered (kg)',
                            data: offered,
                            backgroundColor: 'rgba(128, 178, 247, 0.8)', // Lighter Blue
                        },
                        {
                            label: 'Sold (kg)',
                            data: sold,
                            backgroundColor: 'rgba(26, 115, 232, 0.8)', // Primary Blue
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Quantity (kg)' }
                        }
                    },
                    plugins: { legend: { display: true } }
                }
            });
        }

        function renderGradeStatsTable(statsData) {
            const table = document.getElementById('grade-stats-table');
            const thead = table.querySelector('thead');
            const tbody = table.querySelector('tbody');
            tbody.innerHTML = '';
            thead.innerHTML = '';

            if (statsData.length === 0) return;

            // Dynamically generate headers based on the keys of the first object
            const headers = Object.keys(statsData[0]);
            let headerHtml = '<tr>';
            headers.forEach(header => {
                // Replace underscores with spaces and capitalize for display
                const formattedHeader = header.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                headerHtml += `<th>${formattedHeader}</th>`;
            });
            headerHtml += '</tr>';
            thead.innerHTML = headerHtml;

            // Populate rows
            statsData.forEach(item => {
                let rowHtml = '<tr>';
                headers.forEach(header => {
                    const value = item[header];
                    // Attempt to format numbers if they look numeric (excluding the identifier columns)
                    const isNumeric = !isNaN(parseFloat(value)) && isFinite(value);
                    const isIdentifier = (header === 'category' || header === 'grade');
                    
                    const formattedValue = (isNumeric && !isIdentifier) ? formatNumber(value) : value;
                    rowHtml += `<td>${formattedValue}</td>`;
                });
                rowHtml += '</tr>';
                tbody.innerHTML += rowHtml;
            });
        }


        function renderBuyerActivity(data) {
            const section = document.getElementById('buyer-activity-section');
            let contentExists = false;

            // A. Buyer Market Share Chart (e.g., from 'market_share.json')
            if (data.buyer_market_share && data.buyer_market_share.length > 0) {
                contentExists = true;
                document.getElementById('buyer-chart-wrapper').style.display = 'block';
                renderBuyerChart(data.buyer_market_share);
            }

            // B. Buyer Activity Table (e.g., from 'buyer_activity.json' or 'buyer_summary_S36.json')
            let activityData = null;
            if (data.buyer_activity && data.buyer_activity.length > 0) {
                activityData = data.buyer_activity;
            } else if (data.buyer_summary_S36) {
                // Fallback for the test structure in buyer_summary_S36.json
                activityData = [
                    { buyer_or_region: 'Top Buyer', activity_or_purchases: data.buyer_summary_S36.top_buyer },
                    { buyer_or_region: 'Total Lots', activity_or_purchases: data.buyer_summary_S36.total_lots },
                    { buyer_or_region: 'Lots Sold', activity_or_purchases: data.buyer_summary_S36.lots_sold }
                ];
            }

             if (activityData) {
                contentExists = true;
                document.getElementById('buyer-activity-table-wrapper').style.display = 'block';
                const tbody = document.querySelector('#buyer-activity-table tbody');
                tbody.innerHTML = '';

                activityData.forEach(item => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${item.buyer_or_region}</td>
                        <td>${item.activity_or_purchases}</td>
                    `;
                    tbody.appendChild(row);
                });
            }

            if (contentExists) section.style.display = 'block';
        }

        function renderBuyerChart(chartData) {
            const ctx = document.getElementById('buyerChart').getContext('2d');
            
            // Sort and prepare data for the Pie chart
            const sortedData = [...chartData].sort((a, b) => parseFloat(b.percentage) - parseFloat(a.percentage));
            
            // Group smaller slices into "Others" if needed (e.g., more than 10 buyers)
            let processedData = sortedData;
            if (sortedData.length > 10) {
                const top9 = sortedData.slice(0, 9);
                const others = sortedData.slice(9);
                const othersPercentage = others.reduce((sum, item) => sum + parseFloat(item.percentage), 0);
                processedData = [...top9, { buyer: 'Others', percentage: othersPercentage.toFixed(2) }];
            }

            const labels = processedData.map(item => item.buyer);
            const percentages = processedData.map(item => parseFloat(item.percentage));

            // A nice color palette
            const colors = [
                '#3366cc', '#dc3912', '#ff9900', '#109618', '#990099', 
                '#0099c6', '#dd4477', '#66aa00', '#b82e2e', '#316395'
            ];

            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Market Share (%)',
                        data: percentages,
                        backgroundColor: colors.slice(0, processedData.length),
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { 
                            display: true,
                            position: 'right'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed !== null) {
                                        label += context.parsed + '%';
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }

         // Render raw data components for debugging or verification
        function renderRawData(data) {
            const section = document.getElementById('raw-data-section');
            section.style.display = 'block';
            const container = document.getElementById('raw-data-container');
            container.innerHTML = '';

            for (const key in data) {
                const wrapper = document.createElement('div');
                wrapper.style.marginBottom = '16px';
                // Display the key name (which is the original filename stem)
                wrapper.innerHTML = `<h4>${key}</h4><pre style="background-color: #f1f3f4; padding: 8px; border-radius: 4px; overflow-x: auto;">${JSON.stringify(data[key], null, 2)}</pre>`;
                container.appendChild(wrapper);
            }
        }

    </script>
</body>
</html>
