<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Library - TeaTrade</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body class="data-library-page">
    <header class="site-header">
        <div class="header-top-bar">
            <a href="corporate.html" class="header-logo"><h1>Tea<span>Trade</span></h1></a>
            <div class="header-search-wrapper"><input type="text" class="header-search-bar" placeholder="Global site search..."></div>
            <div class="user-actions">
                <a href="#" title="Create Account"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><line x1="20" y1="8" x2="20" y2="14"></line><line x1="17" y1="11" x2="23" y2="11"></line></svg></a>
                <a href="#" title="Sign In"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path><polyline points="10 17 15 12 10 7"></polyline><line x1="15" y1="12" x2="3" y2="12"></line></svg></a>
            </div>
             <button class="mobile-menu-toggle" aria-label="Toggle navigation" aria-expanded="false">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
            </button>
        </div>
        <nav class="secondary-nav">
            <ul>
                <li><a href="data.html" class="active">Data</a></li>
                <li><a href="market-reports.html">Market Reports</a></li>
                <li><a href="#">Auctions</a></li>
                <li><a href="visuals.html">Visuals</a></li>
            </ul>
        </nav>
    </header>

    <main class="page-container">
        <div class="dashboard-header">
            <h2 class="page-title" id="data-title">Loading Dataset...</h2>
        </div>
        <p id="data-meta" style="margin-bottom: 24px; color: #5f6368;"></p>

        <div id="data-content" style="display: none;">
            </div>
        <div id="loading-indicator">Loading data...</div>
    </main>
    <script src="script.js"></script>
    <script>
        // --- Utility Functions ---
         const formatNumber = (num, decimals = 0) => {
            if (num === null || num === undefined || isNaN(num)) return 'N/A';
            return num.toLocaleString(undefined, { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
        };

        const formatCurrency = (num) => formatNumber(num, 2);

        const formatDiff = (num, decimals = 2) => {
            if (num === null || num === undefined) return 'N/A';
            const formatted = formatNumber(num, decimals);
            const className = num > 0 ? 'diff-positive' : (num < 0 ? 'diff-negative' : '');
            const sign = num > 0 ? '+' : ''; 
            return `<span class="${className}">${sign}${formatted}</span>`;
        }

        // --- Rendering Functions ---

        // Renderer for Global Statistics (Aggregated)
        const renderGlobalStatistics = (data) => {
            document.getElementById('data-title').textContent = 'Global Production & Sales Statistics (Aggregated)';
            document.getElementById('data-meta').textContent = `Last Updated: ${data.last_updated} | Source: Multiple Brokers (Automated)`;

            const content = document.getElementById('data-content');
            
            // 1. Production Statistics
            if (data.production_statistics_mkg && data.production_statistics_mkg.length > 0) {
                const section = document.createElement('section');
                section.className = 'report-section';
                section.innerHTML = '<h3>Global Production Statistics (M.Kg)</h3>';

                const tableContainer = document.createElement('div');
                tableContainer.className = 'data-table-container';
                
                const table = document.createElement('table');
                table.className = 'data-table stats-table';

                // Header
                table.innerHTML = `
                    <thead>
                        <tr>
                            <th class="header-main">Region</th>
                            <th class="header-main">As Of</th>
                            <th class="header-main">${data.current_year} (YTD)</th>
                            <th class="header-main">${data.previous_year} (YTD)</th>
                            <th class="header-main">Difference</th>
                            <th class="header-main" style="text-align: left;">Source</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                `;

                const tbody = table.querySelector('tbody');
                let totalCurrent = 0;
                let totalPrevious = 0;

                data.production_statistics_mkg.forEach(item => {
                    totalCurrent += item.current_year_todate;
                    totalPrevious += item.previous_year_todate;

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${item.region}</td>
                        <td>${item.as_of_month}</td>
                        <td>${formatNumber(item.current_year_todate, 1)}</td>
                        <td>${formatNumber(item.previous_year_todate, 1)}</td>
                        <td>${formatDiff(item.difference, 1)}</td>
                        <td style="text-align: left; font-size: 12px; color: #5f6368;">${item.source}</td>
                    `;
                    tbody.appendChild(row);
                });
                
                // Footer (Totals)
                const tfoot = document.createElement('tfoot');
                tfoot.innerHTML = `<tr style="font-weight: bold; background-color: #f1f3f4;">
                        <td>TOTAL (Tracked Regions)</td>
                        <td></td>
                        <td>${formatNumber(totalCurrent, 1)}</td>
                        <td>${formatNumber(totalPrevious, 1)}</td>
                        <td>${formatDiff(totalCurrent - totalPrevious, 1)}</td>
                        <td></td>
                    </tr>`;
                table.appendChild(tfoot);

                tableContainer.appendChild(table);
                section.appendChild(tableContainer);
                content.appendChild(section);
            }

            // 2. Sales Channel Statistics
            if (data.sales_channel_statistics_kg && Object.keys(data.sales_channel_statistics_kg).length > 0) {
                 const section = document.createElement('section');
                section.className = 'report-section';
                section.innerHTML = '<h3>Sales Channel Statistics (Kg)</h3>';

                const comparisonGrid = document.createElement('div');
                comparisonGrid.className = 'comparison-grid'; // Use grid for multiple regions if available

                for (const [region, stats] of Object.entries(data.sales_channel_statistics_kg)) {
                    const wrapper = document.createElement('div');
                    wrapper.innerHTML = `<h4>${region} (As of: ${stats.as_of_date})</h4>`;

                    const tableContainer = document.createElement('div');
                    tableContainer.className = 'data-table-container';
                    const table = document.createElement('table');
                    table.className = 'data-table stats-table';

                     // Header
                    table.innerHTML = `
                        <thead>
                            <tr>
                                <th class="header-main">Channel</th>
                                <th class="header-main">${data.current_year} (YTD)</th>
                                <th class="header-main">${data.previous_year} (YTD)</th>
                                <th class="header-main">Difference</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    `;

                    const tbody = table.querySelector('tbody');
                    let totalCurrent = 0;
                    let totalPrevious = 0;

                    stats.channels.forEach(item => {
                        totalCurrent += item.current_year_todate;
                        totalPrevious += item.previous_year_todate;
                        const difference = item.current_year_todate - item.previous_year_todate;

                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${item.channel}</td>
                            <td>${formatNumber(item.current_year_todate)}</td>
                            <td>${formatNumber(item.previous_year_todate)}</td>
                            <td>${formatDiff(difference, 0)}</td>
                        `;
                        tbody.appendChild(row);
                    });
                    
                    // Footer (Totals)
                    const tfoot = document.createElement('tfoot');
                    tfoot.innerHTML = `<tr style="font-weight: bold; background-color: #f1f3f4;">
                            <td>TOTAL</td>
                            <td>${formatNumber(totalCurrent)}</td>
                            <td>${formatNumber(totalPrevious)}</td>
                            <td>${formatDiff(totalCurrent - totalPrevious, 0)}</td>
                        </tr>`;
                    table.appendChild(tfoot);

                    tableContainer.appendChild(table);
                    wrapper.appendChild(tableContainer);
                    comparisonGrid.appendChild(wrapper);
                }
                section.appendChild(comparisonGrid);
                content.appendChild(section);
            }
        };

        // Renderer for HMRC Data (Existing functionality preserved)
        const renderHMRCData = (data) => {
            document.getElementById('data-title').textContent = `UK Tea Imports - ${data.metadata.month} ${data.metadata.year}`;
            document.getElementById('data-meta').textContent = `Source: ${data.metadata.source} | Commodity Code: ${data.metadata.commodity_code}`;
            
            const content = document.getElementById('data-content');
            
            // Add Table
            const tableContainer = document.createElement('div');
            tableContainer.className = 'data-table-container';
            const table = document.createElement('table');
            table.className = 'data-table';
             table.innerHTML = `
                <thead>
                    <tr>
                        <th>Country</th>
                        <th>Volume (kg)</th>
                        <th>Value (£)</th>
                    </tr>
                </thead>
                <tbody></tbody>
            `;
            
            const tbody = table.querySelector('tbody');
            data.imports.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.country}</td>
                    <td>${formatNumber(item.volume_kg)}</td>
                    <td>${formatCurrency(item.value_gbp)}</td>
                `;
                tbody.appendChild(row);
            });
            
            tableContainer.appendChild(table);
            content.appendChild(tableContainer);
        };


        // --- Data Loading and Orchestration ---
        document.addEventListener('DOMContentLoaded', async () => {
            const params = new URLSearchParams(window.location.search);
            const datasetName = params.get('dataset');
            
            if (!datasetName) {
                // If no dataset is selected, redirect to the data library listing (or show an error)
                document.getElementById('data-title').textContent = 'Please select a dataset.';
                document.getElementById('loading-indicator').style.display = 'none';
                // Optional: Redirect back if this page is only meant for viewing data
                // window.location.href = 'data-library-listing.html'; 
                return;
            }

            try {
                const data = await loadData(datasetName);
                renderData(datasetName, data);
                
                document.getElementById('loading-indicator').style.display = 'none';
                document.getElementById('data-content').style.display = 'block';

            } catch (error) {
                console.error('Error fetching dataset:', error);
                document.getElementById('data-title').textContent = 'Error loading dataset.';
                document.getElementById('loading-indicator').textContent = `Could not load the dataset: ${datasetName}.json. Error: ${error.message}`;
            }
        });

        async function loadData(datasetName) {
            let filePath;
            // Determine the file path based on the dataset name conventions
            if (datasetName.startsWith('uk-imports')) {
                filePath = `Data/Imports/${datasetName}.json`;
            } else if (datasetName === 'global_statistics') {
                filePath = `Data/${datasetName}.json`;
            } else {
                // Fallback for other potential datasets
                 filePath = `Data/${datasetName}.json`;
            }

            const response = await fetch(filePath);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            return await response.json();
        }

        function renderData(datasetName, data) {
            // Call the appropriate renderer based on the dataset name
            if (datasetName.startsWith('uk-imports')) {
                renderHMRCData(data);
            } else if (datasetName === 'global_statistics') {
                renderGlobalStatistics(data);
            } else {
                document.getElementById('data-title').textContent = 'Viewer not configured for this dataset.';
            }
        }

    </script>
</body>
</html>