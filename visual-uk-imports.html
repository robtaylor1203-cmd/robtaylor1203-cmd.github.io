<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UK Tea Import Analysis - TeaTrade Visuals</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="visuals-page">
    <header class="site-header">
        <div class="header-top-bar">
            <a href="corporate.html" class="header-logo"><h1>Tea<span>Trade</span></h1></a>
            <div class="header-search-wrapper"><input type="text" class="header-search-bar" placeholder="Global site search..."></div>
            <div class="user-actions">
                <a href="#" title="Create Account"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><line x1="20" y1="8" x2="20" y2="14"></line><line x1="17" y1="11" x2="23" y2="11"></line></svg></a>
                <a href="#" title="Sign In"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path><polyline points="10 17 15 12 10 7"></polyline><line x1="15" y1="12" x2="3" y2="12"></line></svg></a>
            </div>
             <button class="mobile-menu-toggle" aria-label="Toggle navigation" aria-expanded="false">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
            </button>
        </div>
        <nav class="secondary-nav">
            <ul>
                <li><a href="data.html">Data</a></li>
                <li><a href="market-reports.html">Market Reports</a></li>
                <li><a href="#">Auctions</a></li>
                <li><a href="visuals.html" class="active">Visuals</a></li>
            </ul>
        </nav>
    </header>

    <main class="page-container">
        <div class="dashboard-header">
            <h2 class="page-title">UK Tea Import Analysis: Volume vs Avg. Price</h2>
        </div>
        <p style="margin-bottom: 24px; color: #5f6368;">Source: HMRC Overseas Trade Statistics. Analysis shows Top 10 suppliers by Volume.</p>

        <div class="filter-controls-wrapper">
            <div class="filter-group">
                <label for="filter-year" class="filter-label">Year</label>
                <select id="filter-year" class="filter-dropdown"></select>
            </div>
            <div class="filter-group">
                <label for="filter-month" class="filter-label">Period</label>
                <select id="filter-month" class="filter-dropdown">
                    <option value="YTD">Year-to-Date (YTD)</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="filter-type" class="filter-label">Tea Type</label>
                <select id="filter-type" class="filter-dropdown">
                    <option value="ALL">All Tea Types</option>
                </select>
            </div>
        </div>

        <div id="visualization-content" style="display: none;">
            <div class="chart-container" style="height: 500px; padding: 24px;">
                <canvas id="combinedChart"></canvas>
            </div>
        </div>
        <div id="loading-indicator">Loading visualization data...</div>
    </main>

    <script src="script.js"></script>

    <details>
    <summary style="cursor: pointer; color: #1a73e8; margin-top: 16px; margin-bottom: 16px;">Click to view/copy the JavaScript for visual-uk-imports.html</summary>
    <script>
        // --- Configuration ---
        const CHART_COLORS = {
            volume: 'rgba(52, 168, 83, 0.8)', // Green for Volume (Bars)
            price: 'rgba(26, 115, 232, 1)', // Blue for Price (Line)
        };

        // Options for the combined (dual-axis) chart
        const CHART_OPTIONS_DUAL_AXIS = {
            indexAxis: 'y', // Horizontal bars
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            plugins: { 
                legend: { 
                    display: true,
                    position: 'top',
                },
                tooltip: {
                    callbacks: {
                        // Customize tooltip display for better readability
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            if (context.parsed.x !== null) {
                                // Check which dataset type it is to format correctly
                                if (context.dataset.type === 'line') {
                                    // Format price as currency
                                    label += new Intl.NumberFormat('en-GB', { style: 'currency', currency: 'GBP' }).format(context.parsed.x);
                                } else {
                                    // Format volume as integer
                                    label += context.parsed.x.toLocaleString() + ' Kg';
                                }
                            }
                            return label;
                        }
                    }
                }
            },
            scales: {
                // X-axis for Volume (Primary)
                xVolume: {
                    type: 'linear',
                    display: true,
                    position: 'bottom',
                    title: { display: true, text: 'Volume (Kg)' },
                    beginAtZero: true,
                },
                // X-axis for Price (Secondary)
                xPrice: {
                    type: 'linear',
                    display: true,
                    position: 'top',
                    title: { display: true, text: 'Average Price (£/Kg)' },
                    beginAtZero: true,
                    // Ensures that the grid lines do not overlap
                    grid: {
                        drawOnChartArea: false, 
                    },
                },
                // Y-axis (Countries)
                y: {
                    title: { display: true, text: 'Country of Origin' },
                }
            }
        };

        // List of known data files
        const DATA_FILES = [
            'Data/Imports/uk-imports-june-2025.json',
            'Data/Imports/uk-imports-july-2025.json'
        ];

        let GLOBAL_DATA = [];
        let combinedChartInstance = null;

        // --- Data Loading and Processing ---
        async function loadAndProcessData() {
            try {
                const fetchPromises = DATA_FILES.map(file => fetch(file).then(response => {
                    if (!response.ok) throw new Error(`Failed to load ${file}`);
                    return response.json();
                }));

                const datasets = await Promise.all(fetchPromises);
                
                // Combine all loaded datasets, looking inside the 'imports' key.
                GLOBAL_DATA = datasets.flatMap(data => data.imports || []);
                
                if (GLOBAL_DATA.length === 0) {
                    throw new Error("No data available.");
                }

                const filters = extractFilters(GLOBAL_DATA);
                populateFilters(filters);
                updateVisualizations();

                document.getElementById('loading-indicator').style.display = 'none';
                document.getElementById('visualization-content').style.display = 'block';

            } catch (error) {
                console.error("Error loading data:", error);
                document.getElementById('loading-indicator').textContent = `Error loading visualization data: ${error.message}`;
            }
        }

        function extractFilters(data) {
            const years = [...new Set(data.map(item => item.year))].sort((a, b) => b - a);
            const months = [...new Set(data.map(item => item.month))].sort((a, b) => a - b);
            const types = [...new Set(data.map(item => item.tea_type))].sort();
            return { years, months, types };
        }

        // --- UI Updates ---
        function populateFilters({ years, months, types }) {
            const yearSelect = document.getElementById('filter-year');
            const monthSelect = document.getElementById('filter-month');
            const typeSelect = document.getElementById('filter-type');

            years.forEach(year => {
                const option = new Option(year, year);
                yearSelect.add(option);
            });

            const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            months.forEach(monthNum => {
                const num = parseInt(monthNum, 10);
                if (num >= 1 && num <= 12) {
                    const option = new Option(monthNames[num - 1], num);
                    monthSelect.add(option);
                }
            });

            types.forEach(type => {
                const option = new Option(type, type);
                typeSelect.add(option);
            });

            yearSelect.addEventListener('change', updateVisualizations);
            monthSelect.addEventListener('change', updateVisualizations);
            typeSelect.addEventListener('change', updateVisualizations);
        }

        // --- Visualization Logic ---
        function updateVisualizations() {
            const selectedYear = document.getElementById('filter-year').value;
            const selectedMonth = document.getElementById('filter-month').value;
            const selectedType = document.getElementById('filter-type').value;

            let filteredData = GLOBAL_DATA.filter(item => item.year == selectedYear);

            if (selectedMonth !== "YTD") {
                filteredData = filteredData.filter(item => item.month == selectedMonth);
            }

            if (selectedType !== "ALL") {
                filteredData = filteredData.filter(item => item.tea_type === selectedType);
            }

            const aggregatedData = aggregateByCountry(filteredData);
            renderCombinedChart(aggregatedData);
        }

        function aggregateByCountry(data) {
            const aggregation = {};
            data.forEach(item => {
                const country = item.country_of_origin;
                if (!aggregation[country]) {
                    aggregation[country] = { country: country, value_gbp: 0, volume_kg: 0 };
                }
                aggregation[country].value_gbp += Number(item.statistical_value_gbp) || 0;
                aggregation[country].volume_kg += Number(item.net_mass_kg) || 0;
            });

            // Calculate Average Price per Kg
            const result = Object.values(aggregation);
            result.forEach(item => {
                item.avg_price_per_kg = item.volume_kg > 0 ? (item.value_gbp / item.volume_kg) : 0;
            });
            return result;
        }

        function renderCombinedChart(data) {
            // Focus on the Top 10 by Volume
            const top10Volume = [...data].sort((a, b) => b.volume_kg - a.volume_kg).slice(0, 10);
            
            const labels = top10Volume.map(item => item.country);
            const volumeData = top10Volume.map(item => item.volume_kg);
            const priceData = top10Volume.map(item => item.avg_price_per_kg);

            // Destroy existing instance
            if (combinedChartInstance) combinedChartInstance.destroy();

            combinedChartInstance = new Chart(document.getElementById('combinedChart').getContext('2d'), {
                // Note: When combining types, the 'type' is defined in the dataset, not globally
                data: {
                    labels: labels,
                    datasets: [
                        {
                            type: 'bar',
                            label: 'Volume (Kg)',
                            data: volumeData,
                            backgroundColor: CHART_COLORS.volume,
                            xAxisID: 'xVolume',
                            order: 2 // Bars appear behind the line
                        },
                        {
                            type: 'line',
                            label: 'Avg Price (£/Kg)',
                            data: priceData,
                            borderColor: CHART_COLORS.price,
                            backgroundColor: CHART_COLORS.price,
                            fill: false,
                            tension: 0.1,
                            xAxisID: 'xPrice',
                            pointRadius: 5,
                            pointHoverRadius: 8,
                            order: 1 // Line appears in front
                        }
                    ]
                },
                options: CHART_OPTIONS_DUAL_AXIS
            });
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
             if (typeof initializeMobileMenu === 'function') {
                initializeMobileMenu();
            }
            loadAndProcessData();
        });
    </script>
    </details>
</body>
</html>