<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consolidated Auction Viewer - TeaTrade</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="market-reports-page">
    <header class="site-header">
        <div class="header-top-bar">
            <a href="corporate.html" class="header-logo"><h1>Tea<span>Trade</span></h1></a>
            <div class="header-search-wrapper"><input type="text" class="header-search-bar" placeholder="Global site search..."></div>
            <div class="user-actions">
                <a href="#" title="Create Account"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><line x1="20" y1="8" x2="20" y2="14"></line><line x1="17" y1="11" x2="23" y2="11"></line></svg></a>
                <a href="#" title="Sign In"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path><polyline points="10 17 15 12 10 7"></polyline><line x1="15" y1="12" x2="3" y2="12"></line></svg></a>
            </div>
            <button class="mobile-menu-toggle" aria-label="Toggle navigation" aria-expanded="false">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
            </button>
        </div>
        <nav class="secondary-nav">
            <ul>
                <li><a href="data.html">Data</a></li>
                <li><a href="market-reports.html">Market Reports</a></li>
                <li><a href="auction-viewer.html" class="active">Auctions</a></li>
                <li><a href="visuals.html">Visuals</a></li>
            </ul>
        </nav>
    </header>

    <main class="page-container">
        <div class="dashboard-header">
            <h2 class="page-title" id="report-title">Loading Consolidated Report...</h2>
        </div>
        <p id="report-meta" style="margin-bottom: 24px; color: #5f6368;"></p>

        <div id="report-content" style="display: none;">
            
            <section class="report-section">
                <h3>Auction Overview</h3>
                <div class="stat-cards-container" id="summary-stats"></div>
                
                <div class="overview-grid">
                    <div class="commentary-block">
                        <h4>Market Synopsis</h4>
                        <p id="market-comment"></p>
                    </div>
                    <div class="highest-prices-block">
                        <h4>Highest Achieved Prices</h4>
                        <table class="data-table compact-table" id="highest-prices-table">
                            <thead>
                                <tr>
                                    <th>Price</th>
                                    <th>Grade</th>
                                    <th>Mark (Factory)</th>
                                    <th>Country</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section class="report-section">
                <h3>Volume Analysis</h3>
                <div class="analysis-grid">
                    <div class="analysis-block">
                        <h4>Offerings vs Sold by Country (kg)</h4>
                        <div style="position: relative; height: 350px;"><canvas id="countryVolumeChart"></canvas></div>
                    </div>
                    <div class="analysis-block">
                         <h4>Detailed Grade Statistics</h4>
                         <div class="data-table-container">
                            <table class="data-table stats-table" id="grade-stats-table">
                                <thead>
                                    <tr>
                                        <th>Grade</th>
                                        <th>Offered (Pkg)</th>
                                        <th>Sold (Pkg)</th>
                                        <th>Unsold (%)</th>
                                        <th>Avg Price</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <section class="report-section">
                <h3>Buyer Activity & Market Share</h3>
                 <div class="analysis-grid">
                    <div class="analysis-block">
                         <h4>Buyer Market Share (%)</h4>
                        <div style="position: relative; height: 400px;"><canvas id="buyerChart"></canvas></div>
                    </div>
                    <div class="analysis-block">
                        <h4>Top Buyers & Regional Activity (kg)</h4>
                         <div class="data-table-container">
                            <table class="data-table stats-table" id="buyer-activity-table">
                                <thead>
                                    <tr>
                                        <th>Buyer/Region</th>
                                        <th>Volume (kg)</th>
                                        <th>Market Share (%)</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <section class="report-section">
                <h3>Comparative Analysis (Year-on-Year)</h3>
                <div class="comparison-container">
                    <div class="comparison-block">
                         <h4>Country Average Prices</h4>
                        <div class="data-table-container">
                            <table class="data-table stats-table" id="country-comparison-table">
                                <thead>
                                    <tr>
                                        <th rowspan="2" class="header-main">Country</th>
                                        <th colspan="2" class="header-main">Current Sale Avg</th>
                                        <th colspan="2" class="header-main">Year-to-Date Avg</th>
                                    </tr>
                                    <tr>
                                        <th class="header-sub" id="header-current-year-sale"></th>
                                        <th class="header-sub" id="header-prev-year-sale"></th>
                                        <th class="header-sub" id="header-current-year-ytd"></th>
                                        <th class="header-sub" id="header-prev-year-ytd"></th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                                <tfoot></tfoot>
                            </table>
                        </div>
                    </div>
                    <div class="comparison-block">
                        <h4>Auction Average Visualization</h4>
                        <div style="position: relative; height: 300px;"><canvas id="auctionAvgChart"></canvas></div>
                    </div>
                </div>
            </section>

             <section class="report-section">
                <h3>Factory (Mark) Performance Ranking</h3>
                <p>Top Factories ranked by Average Price achieved during the sale.</p>
                 <div class="data-table-container">
                    <table class="data-table stats-table" id="factory-performance-table">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Mark (Factory)</th>
                                <th>Country</th>
                                <th>Average Price</th>
                                <th>Top Grade</th>
                                <th>Top Price</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </section>

            <section class="report-section">
                <h3>Weather Impact & Forward Look</h3>
                <div class="analysis-grid">
                    <div class="analysis-block" id="weather-section" style="display: none;">
                        <h4>Regional Weather & Crop Conditions</h4>
                        <div class="data-table-container">
                            <table class="data-table stats-table" id="weather-table">
                                <thead>
                                    <tr>
                                        <th>Region</th>
                                        <th>Conditions</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="analysis-block" id="upcoming-section" style="display: none;">
                        <h4>Upcoming Auction Offerings (Packages)</h4>
                        <div class="upcoming-container" id="upcoming-container">
                        </div>
                    </div>
                </div>
            </section>

        </div>
        <div id="loading-indicator">Loading data...</div>
    </main>
    <script src="script.js"></script>
    
    <details>
    <summary style="cursor: pointer; color: #1a73e8; margin-top: 16px; margin-bottom: 16px; font-weight: bold;">Click here to view/copy the complete JavaScript for auction-viewer.html</summary>
    <script>
        // --- Configuration ---
        const CHART_COLORS = {
            primary: 'rgba(26, 115, 232, 0.8)', // Blue
            secondary: 'rgba(128, 178, 247, 0.8)', // Lighter Blue
            accent1: 'rgba(251, 188, 4, 0.8)', 
            accent2: 'rgba(52, 168, 83, 0.8)', 
            neutral: 'rgba(160, 160, 160, 0.8)'
        };

        const PIE_COLORS = [
            '#1a73e8', '#34a853', '#fbbc05', '#ea4335', '#9b59b6', 
            '#3498db', '#16a085', '#f39c12', '#d35400', '#7f8c8d'
        ];

        const CHART_OPTIONS_BAR = {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: { display: true, text: 'Value' }
                },
                x: {
                    ticks: { autoSkip: false, maxRotation: 45, minRotation: 45 }
                }
            },
            plugins: { legend: { display: false } }
        };

         const CHART_OPTIONS_PIE = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { 
                legend: { 
                    display: true,
                    position: 'right',
                } 
            }
        };

        // --- Utility Functions ---
        const formatNumber = (num, decimals = 0) => {
            if (num === null || num === undefined || isNaN(num)) return 'N/A';
            return num.toLocaleString(undefined, { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
        };

        const formatCurrency = (num) => formatNumber(num, 2);

         const formatDiff = (current, previous, decimals = 2) => {
            if (current === null || previous === null || previous === 0) return 'N/A';
            const diff = current - previous;
            const formatted = formatNumber(diff, decimals);
            const className = diff > 0 ? 'diff-positive' : (diff < 0 ? 'diff-negative' : '');
            const sign = diff > 0 ? '+' : ''; 
            return `<span class="${className}">${sign}${formatted}</span>`;
        }

        // --- Rendering Functions ---

        // 1. Overview and Commentary
        const renderOverview = (summary, meta) => {
            const statsContainer = document.getElementById('summary-stats');
            statsContainer.innerHTML = '';

            const stats = [
                { label: 'Total Offered (kg)', value: summary.total_offered_kg, format: 0 },
                { label: 'Total Sold (kg)', value: summary.total_sold_kg, format: 0 },
                { label: 'Offered (Packages)', value: summary.total_offered_packages, format: 0 },
                { label: 'Unsold (%)', value: summary.percent_unsold, format: 1, suffix: '%' },
                { label: 'Auction Average Price', value: summary.auction_average_price, format: 2, prefix: meta.currency + ' '},
            ];

            stats.forEach(stat => {
                if (stat.value !== undefined && stat.value !== null) {
                    const card = document.createElement('div');
                    card.className = 'stat-card';
                    card.innerHTML = `
                        <span class="stat-value">${stat.prefix || ''}${formatNumber(stat.value, stat.format)}${stat.suffix || ''}</span>
                        <span class="stat-label">${stat.label}</span>
                    `;
                    statsContainer.appendChild(card);
                }
            });

            document.getElementById('market-comment').textContent = summary.commentary_synthesized || 'Commentary not available.';

            // Highest Prices Table
            const highestPricesTbody = document.getElementById('highest-prices-table').querySelector('tbody');
            highestPricesTbody.innerHTML = '';
            if (summary.highest_prices) {
                summary.highest_prices.forEach(item => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${formatCurrency(item.price)}</td>
                        <td>${item.grade}</td>
                        <td>${item.mark}</td>
                        <td>${item.country}</td>
                    `;
                    highestPricesTbody.appendChild(row);
                });
            }
        };

        // 2. Volume Analysis
        const renderVolumeAnalysis = (volumeData) => {
            if (!volumeData) return;

            // Chart: By Country
            if (volumeData.by_country) {
                const ctx = document.getElementById('countryVolumeChart').getContext('2d');
                const labels = volumeData.by_country.map(item => item.country);
                const offered = volumeData.by_country.map(item => item.offered_kg);
                const sold = volumeData.by_country.map(item => item.sold_kg);

                const options = JSON.parse(JSON.stringify(CHART_OPTIONS_BAR));
                options.scales.y.title.text = 'Quantity (kg)';
                options.plugins.legend.display = true;

                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Offered (kg)',
                                data: offered,
                                backgroundColor: CHART_COLORS.secondary,
                            },
                            {
                                label: 'Sold (kg)',
                                data: sold,
                                backgroundColor: CHART_COLORS.primary,
                            }
                        ]
                    },
                    options: options
                });
            }

            // Table: By Grade Detailed
            if (volumeData.by_grade_detailed) {
                const tbody = document.getElementById('grade-stats-table').querySelector('tbody');
                tbody.innerHTML = '';
                volumeData.by_grade_detailed.forEach(item => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${item.grade}</td>
                        <td>${formatNumber(item.offered_packages)}</td>
                        <td>${formatNumber(item.sold_packages)}</td>
                        <td>${formatNumber(item.percent_unsold, 1)}%</td>
                        <td>${formatCurrency(item.average_price)}</td>
                    `;
                    tbody.appendChild(row);
                });
            }
        };

        // 3. Buyer Activity
        const renderBuyerActivity = (activity) => {
            if (!activity || activity.length === 0) return;

            // Table: Top Buyers
            const tbody = document.getElementById('buyer-activity-table').querySelector('tbody');
            tbody.innerHTML = '';
            // Display top 15 buyers
            const top15 = activity.slice(0, 15); 
            top15.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.buyer}</td>
                    <td>${formatNumber(item.volume_kg)}</td>
                    <td>${formatNumber(item.market_share, 2)}%</td>
                `;
                tbody.appendChild(row);
            });

            // Chart: Market Share (Pie Chart)
            const ctx = document.getElementById('buyerChart').getContext('2d');

            // Prepare data for pie chart: Top 9 + Others
            const sortedActivity = [...activity].sort((a, b) => b.market_share - a.market_share);
            
            // Filter out explicit "Others" categories if they exist in the source data
            const primaryActivity = sortedActivity.filter(item => !item.buyer.toLowerCase().includes("others"));
            
            const top9 = primaryActivity.slice(0, 9);
            const others = primaryActivity.slice(9);
            
            const chartData = [...top9];
            if (others.length > 0) {
                const othersTotal = others.reduce((sum, item) => sum + item.market_share, 0);
                 // Ensure 'Others' total is meaningful before adding
                if (othersTotal > 0.1) {
                    chartData.push({ buyer: 'Others (Calculated)', market_share: othersTotal });
                }
            }

            const labels = chartData.map(item => item.buyer);
            const values = chartData.map(item => item.market_share);

            const options = JSON.parse(JSON.stringify(CHART_OPTIONS_PIE));

            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Market Share (%)',
                        data: values,
                        backgroundColor: PIE_COLORS,
                    }]
                },
                options: options
            });
        };

        // 4. Comparative Analysis
        const renderComparativeAnalysis = (comparison, meta) => {
            if (!comparison) return;

            const currentYear = meta.year;
            const prevYear = currentYear - 1;

            // Table: Country Averages YoY
            if (comparison.country_averages_yoy) {
                // Update Headers
                document.getElementById('header-current-year-sale').textContent = currentYear;
                document.getElementById('header-prev-year-sale').textContent = prevYear;
                document.getElementById('header-current-year-ytd').textContent = currentYear;
                document.getElementById('header-prev-year-ytd').textContent = prevYear;

                const tbody = document.getElementById('country-comparison-table').querySelector('tbody');
                tbody.innerHTML = '';
                comparison.country_averages_yoy.forEach(item => {
                    const row = document.createElement('tr');
                    // Dynamically access properties based on year
                    const avgCurrent = item[`avg_${currentYear}`];
                    const avgPrev = item[`avg_${prevYear}`];
                    const ytdCurrent = item[`ytd_${currentYear}`];
                    const ytdPrev = item[`ytd_${prevYear}`];

                    row.innerHTML = `
                        <td>${item.country}</td>
                        <td>${formatCurrency(avgCurrent)}</td>
                        <td>${formatCurrency(avgPrev)}</td>
                        <td>${formatCurrency(ytdCurrent)}</td>
                        <td>${formatCurrency(ytdPrev)}</td>
                    `;
                    tbody.appendChild(row);
                });

                // Footer: Total Auction Average
                if (comparison.auction_average_yoy) {
                    const tfoot = document.getElementById('country-comparison-table').querySelector('tfoot');
                    const avg = comparison.auction_average_yoy;
                    tfoot.innerHTML = `
                        <tr style="font-weight: bold; background-color: #f1f3f4;">
                            <td>AUCTION AVERAGE</td>
                            <td>${formatCurrency(avg[`avg_${currentYear}`])}</td>
                            <td>${formatCurrency(avg[`avg_${prevYear}`])}</td>
                            <td>${formatCurrency(avg[`ytd_${currentYear}`])}</td>
                            <td>${formatCurrency(avg[`ytd_${prevYear}`])}</td>
                        </tr>
                    `;
                }
            }

            // Chart: Auction Average Visualization
            if (comparison.auction_average_yoy) {
                const avgData = comparison.auction_average_yoy;
                const ctx = document.getElementById('auctionAvgChart').getContext('2d');
                
                const labels = ['Current Sale', 'Year-to-Date'];
                const currentYearData = [avgData[`avg_${currentYear}`], avgData[`ytd_${currentYear}`]];
                const prevYearData = [avgData[`avg_${prevYear}`], avgData[`ytd_${prevYear}`]];

                const options = JSON.parse(JSON.stringify(CHART_OPTIONS_BAR));
                options.scales.y.title.text = `Price (${meta.currency})`;
                options.plugins.legend.display = true;

                 new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: prevYear,
                                data: prevYearData,
                                backgroundColor: CHART_COLORS.secondary,
                            },
                            {
                                label: currentYear,
                                data: currentYearData,
                                backgroundColor: CHART_COLORS.primary,
                            }
                        ]
                    },
                    options: options
                });
            }
        };

        // 5. Factory Performance
        const renderFactoryPerformance = (performance) => {
            if (!performance || performance.length === 0) return;

            const tbody = document.getElementById('factory-performance-table').querySelector('tbody');
            tbody.innerHTML = '';

            // Display Top 50 (or fewer if data is limited)
            const top50 = performance.slice(0, 50);

            top50.forEach((item, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${item.mark}</td>
                    <td>${item.country}</td>
                    <td>${formatCurrency(item.average_price)}</td>
                    <td>${item.top_grade}</td>
                    <td>${formatCurrency(item.top_price)}</td>
                `;
                tbody.appendChild(row);
            });
        };

        // 6. Weather Analysis
        const renderWeatherAnalysis = (weather) => {
            if (!weather || weather.length === 0) return;

            document.getElementById('weather-section').style.display = 'block';
            const tbody = document.getElementById('weather-table').querySelector('tbody');
            tbody.innerHTML = '';

            weather.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.region}</td>
                    <td>${item.conditions}</td>
                `;
                tbody.appendChild(row);
            });
        };

        // 7. Upcoming Offerings
        const renderUpcomingOfferings = (upcoming) => {
            if (!upcoming || Object.keys(upcoming).length === 0) return;

            document.getElementById('upcoming-section').style.display = 'block';
            const container = document.getElementById('upcoming-container');
            container.innerHTML = '';

            for (const saleKey in upcoming) {
                const saleData = upcoming[saleKey];
                const saleNumber = saleKey.replace('sale_', '');

                const block = document.createElement('div');
                block.className = 'upcoming-block';

                let html = `<h4>Sale ${saleNumber} (${saleData.date})</h4>`;
                html += `<p><strong>Total Estimated: ${formatNumber(saleData.total_packages)} Packages</strong></p>`;
                
                // Check if country breakdown exists
                if (saleData.by_country && saleData.by_country.length > 0) {
                    html += `<div class="data-table-container"><table class="data-table compact-table">
                                <thead><tr><th>Country</th><th>Packages</th></tr></thead><tbody>`;
                    
                    saleData.by_country.forEach(item => {
                        html += `<tr><td>${item.country}</td><td>${formatNumber(item.packages)}</td></tr>`;
                    });

                    html += `</tbody></table></div>`;
                }
                block.innerHTML = html;
                container.appendChild(block);
            }
        };


        // Main Report Rendering Logic (Orchestration)
        const renderReport = (data) => {
            const meta = data.metadata;

            // 1. Metadata and Title
            document.getElementById('report-title').textContent = `${meta.auction_centre} Consolidated Auction Report - Sale ${meta.sale_number} (${meta.year})`;
            
            let metaText = `Dates: ${meta.sale_date_start} to ${meta.sale_date_end} | Prompt Date: ${meta.prompt_date} | Currency: ${meta.currency}`;
            document.getElementById('report-meta').textContent = metaText;

            // 2. Render Sections
            renderOverview(data.summary, meta);
            renderVolumeAnalysis(data.volume_analysis);
            renderBuyerActivity(data.buyer_activity);
            renderComparativeAnalysis(data.comparative_analysis, meta);
            renderFactoryPerformance(data.factory_performance);
            renderWeatherAnalysis(data.weather_analysis);
            renderUpcomingOfferings(data.upcoming_offerings);
        };

        // --- Data Loading ---
        document.addEventListener('DOMContentLoaded', async () => {
            // Initialize mobile menu toggle
             if (typeof initializeMobileMenu === 'function') {
                initializeMobileMenu();
            }
            
            const params = new URLSearchParams(window.location.search);
            let datasetFile = params.get('dataset');

            // Default to the latest report if no dataset is specified in the URL
            if (!datasetFile) {
                // In a real application, this would fetch the latest available report dynamically.
                // For this prototype, we default to the newly created report.
                datasetFile = 'Mombasa_Consolidated_W35_2025'; 
            }
            
            try {
                // Fetch data from the new Consolidated directory structure
                const response = await fetch(`Data/Consolidated/${datasetFile}.json`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const reportData = await response.json();
                
                // Orchestrate the rendering
                renderReport(reportData);
                
                document.getElementById('loading-indicator').style.display = 'none';
                document.getElementById('report-content').style.display = 'block';

            } catch (error) {
                console.error('Error fetching consolidated report data:', error);
                document.getElementById('report-title').textContent = 'Error loading report.';
                document.getElementById('loading-indicator').textContent = `Could not load the dataset: ${datasetFile}.json. Error: ${error.message}`;
            }
        });
    </script>
    </details>
</body>
</html>